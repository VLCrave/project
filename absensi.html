<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Face Recognition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2d3748);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .app-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .panel {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .panel-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #00c6ff;
            border-bottom: 2px solid rgba(0, 198, 255, 0.5);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title i {
            color: #00c6ff;
        }
        
        .camera-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 500px;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        #videoElement {
            width: 100%;
            height: auto;
            display: block;
            background: #000;
            transform: scaleX(-1); /* Mirror effect */
        }
        
        .canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .camera-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn {
            padding: 14px 28px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0, 114, 255, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(90deg, #00b09b, #96c93d);
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0, 176, 155, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(90deg, #f7971e, #ffd200);
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(247, 151, 30, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(255, 65, 108, 0.4);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .status-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }
        
        .status-ready {
            background-color: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }
        
        .status-scanning {
            background-color: #ffcc00;
            box-shadow: 0 0 10px #ffcc00;
            animation: pulse 1s infinite;
        }
        
        .status-error {
            background-color: #ff3333;
            box-shadow: 0 0 10px #ff3333;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .attendance-list {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .attendance-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border-left: 5px solid #00c6ff;
            transition: all 0.3s ease;
        }
        
        .attendance-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .attendance-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .attendance-info {
            flex: 1;
        }
        
        .attendance-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .attendance-time {
            font-size: 0.9rem;
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .attendance-type {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .type-checkin {
            background-color: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .type-checkout {
            background-color: rgba(255, 204, 0, 0.2);
            color: #ffcc00;
        }
        
        .registration-section {
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1rem;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #00c6ff;
            box-shadow: 0 0 0 2px rgba(0, 198, 255, 0.2);
        }
        
        .stats-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
        }
        
        .stat-card {
            flex: 1;
            min-width: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border-top: 5px solid #00c6ff;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
            color: #00c6ff;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #aaa;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #aaa;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #555;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a2a6c, #2d3748);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        .modal-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #00c6ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-message {
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #aaa;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .camera-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            header h1 {
                font-size: 2.2rem;
            }
        }
        
        /* Animation for detected face */
        @keyframes faceDetected {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(0, 255, 136, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
        }
        
        .face-detected {
            animation: faceDetected 1s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-camera"></i> Sistem Absensi Face Recognition</h1>
            <p>Absensi otomatis dengan teknologi pengenalan wajah. Sistem akan mengenali wajah Anda dan mencatat kehadiran secara otomatis.</p>
        </header>
        
        <div class="app-container">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-video"></i> Kamera Absensi</h2>
                <div class="camera-section">
                    <div class="video-container">
                        <video id="videoElement" autoplay muted playsinline></video>
                        <canvas id="canvasOverlay" class="canvas-overlay"></canvas>
                    </div>
                    
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">Memuat model AI...</span>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="btn btn-primary" id="startCamera">
                            <i class="fas fa-play"></i> Mulai Kamera
                        </button>
                        <button class="btn btn-success" id="startScan">
                            <i class="fas fa-search"></i> Mulai Scan
                        </button>
                        <button class="btn btn-warning" id="registerFace">
                            <i class="fas fa-user-plus"></i> Daftarkan Wajah
                        </button>
                        <button class="btn btn-danger" id="stopCamera">
                            <i class="fas fa-stop"></i> Hentikan
                        </button>
                    </div>
                </div>
                
                <div class="registration-section" id="registrationSection" style="display: none;">
                    <h3 class="panel-title"><i class="fas fa-user-edit"></i> Registrasi Wajah Baru</h3>
                    <div class="form-group">
                        <label for="employeeName">Nama Lengkap</label>
                        <input type="text" id="employeeName" placeholder="Masukkan nama lengkap">
                    </div>
                    <div class="form-group">
                        <label for="employeeId">ID Karyawan</label>
                        <input type="text" id="employeeId" placeholder="Masukkan ID karyawan">
                    </div>
                    <div class="form-group">
                        <label for="employeeDept">Departemen</label>
                        <input type="text" id="employeeDept" placeholder="Masukkan departemen">
                    </div>
                    <div class="camera-controls">
                        <button class="btn btn-success" id="captureFace">
                            <i class="fas fa-camera"></i> Ambil Foto Wajah
                        </button>
                        <button class="btn btn-danger" id="cancelRegistration">
                            <i class="fas fa-times"></i> Batal
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-list-check"></i> Daftar Kehadiran Hari Ini</h2>
                <div class="attendance-list" id="attendanceList">
                    <!-- Daftar kehadiran akan diisi oleh JavaScript -->
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPresent">0</div>
                        <div class="stat-label">Hadir Hari Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="checkinCount">0</div>
                        <div class="stat-label">Check-in</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="checkoutCount">0</div>
                        <div class="stat-label">Check-out</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2 class="panel-title"><i class="fas fa-database"></i> Data Karyawan Terdaftar</h2>
            <div class="attendance-list" id="employeeList">
                <!-- Daftar karyawan terdaftar akan diisi oleh JavaScript -->
            </div>
        </div>
        
        <footer>
            <p>Sistem Absensi Face Recognition &copy; 2023 - Dibuat dengan <i class="fas fa-heart" style="color: #ff416c;"></i></p>
            <p>Sistem ini bekerja sepenuhnya di browser Anda. Data disimpan secara lokal di perangkat Anda.</p>
        </footer>
    </div>
    
    <!-- Modal untuk hasil scan -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-user-check"></i> Hasil Scan Wajah</h2>
            <div class="modal-message" id="modalMessage">
                <!-- Pesan hasil scan akan dimuat di sini -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="closeModal">Tutup</button>
            </div>
        </div>
    </div>
    
    <script>
        // Inisialisasi variabel
        let videoStream = null;
        let isScanning = false;
        let isCameraOn = false;
        let registeredFaces = [];
        let attendanceRecords = [];
        let faceDescriptors = [];
        
        // Load models untuk face-api.js
        async function loadModels() {
            try {
                updateStatus('Memuat model AI...', 'status-scanning');
                
                // Load model yang diperlukan
                await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
                await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
                await faceapi.nets.faceRecognitionNet.loadFromUri('/models');
                await faceapi.nets.faceExpressionNet.loadFromUri('/models');
                
                updateStatus('Model AI siap!', 'status-ready');
                console.log('Model AI berhasil dimuat');
                
                // Coba muat data yang disimpan sebelumnya
                loadSavedData();
            } catch (error) {
                console.error('Gagal memuat model AI:', error);
                updateStatus('Gagal memuat model AI', 'status-error');
            }
        }
        
        // Muat data yang disimpan di localStorage
        function loadSavedData() {
            try {
                const savedFaces = localStorage.getItem('registeredFaces');
                const savedAttendance = localStorage.getItem('attendanceRecords');
                
                if (savedFaces) {
                    registeredFaces = JSON.parse(savedFaces);
                    updateEmployeeList();
                }
                
                if (savedAttendance) {
                    attendanceRecords = JSON.parse(savedAttendance);
                    updateAttendanceList();
                    updateStats();
                }
                
                console.log('Data berhasil dimuat dari penyimpanan lokal');
            } catch (error) {
                console.error('Gagal memuat data dari penyimpanan lokal:', error);
            }
        }
        
        // Simpan data ke localStorage
        function saveData() {
            try {
                localStorage.setItem('registeredFaces', JSON.stringify(registeredFaces));
                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                console.log('Data berhasil disimpan ke penyimpanan lokal');
            } catch (error) {
                console.error('Gagal menyimpan data ke penyimpanan lokal:', error);
            }
        }
        
        // Update status indikator
        function updateStatus(text, statusClass) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = text;
            
            // Reset semua kelas status
            statusDot.classList.remove('status-ready', 'status-scanning', 'status-error');
            
            // Tambahkan kelas status baru
            if (statusClass) {
                statusDot.classList.add(statusClass);
            }
        }
        
        // Mulai kamera
        async function startCamera() {
            try {
                const video = document.getElementById('videoElement');
                
                // Minta akses ke kamera
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user' // Gunakan kamera depan
                    },
                    audio: false
                });
                
                video.srcObject = videoStream;
                isCameraOn = true;
                updateStatus('Kamera aktif', 'status-ready');
                
                // Sembunyikan tombol mulai kamera, tampilkan tombol hentikan
                document.getElementById('startCamera').style.display = 'none';
                document.getElementById('stopCamera').style.display = 'flex';
                
                console.log('Kamera berhasil diaktifkan');
            } catch (error) {
                console.error('Gagal mengakses kamera:', error);
                updateStatus('Gagal mengakses kamera', 'status-error');
                showModal('Error', 'Tidak dapat mengakses kamera. Pastikan Anda memberikan izin akses kamera dan perangkat Anda memiliki kamera yang berfungsi.');
            }
        }
        
        // Hentikan kamera
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            const video = document.getElementById('videoElement');
            video.srcObject = null;
            
            isCameraOn = false;
            isScanning = false;
            
            updateStatus('Kamera dihentikan', 'status-error');
            
            // Tampilkan tombol mulai kamera, sembunyikan tombol hentikan
            document.getElementById('startCamera').style.display = 'flex';
            document.getElementById('stopCamera').style.display = 'none';
            
            console.log('Kamera dihentikan');
        }
        
        // Mulai scanning wajah
        async function startScan() {
            if (!isCameraOn) {
                showModal('Peringatan', 'Silakan aktifkan kamera terlebih dahulu.');
                return;
            }
            
            isScanning = true;
            updateStatus('Scanning wajah...', 'status-scanning');
            
            // Dapatkan elemen video dan canvas
            const video = document.getElementById('videoElement');
            const canvas = document.getElementById('canvasOverlay');
            const displaySize = { width: video.width, height: video.height };
            
            // Sesuaikan ukuran canvas dengan video
            faceapi.matchDimensions(canvas, displaySize);
            
            console.log('Memulai scanning wajah...');
            
            // Fungsi untuk mendeteksi wajah
            async function detectFaces() {
                if (!isScanning || !isCameraOn) return;
                
                try {
                    // Deteksi wajah dari video
                    const detections = await faceapi.detectAllFaces(
                        video, 
                        new faceapi.TinyFaceDetectorOptions()
                    ).withFaceLandmarks().withFaceDescriptors();
                    
                    // Bersihkan canvas
                    const context = canvas.getContext('2d');
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Gambar deteksi di canvas
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                    faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
                    
                    // Jika ada wajah yang terdeteksi
                    if (detections.length > 0) {
                        const detection = detections[0];
                        
                        // Cek apakah wajah dikenali
                        if (registeredFaces.length > 0) {
                            const faceMatcher = new faceapi.FaceMatcher(faceDescriptors);
                            const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                            
                            // Jika wajah dikenali
                            if (bestMatch.distance < 0.5) {
                                const matchedFace = registeredFaces.find(face => face.id === bestMatch.label);
                                
                                if (matchedFace) {
                                    // Tandai wajah yang dikenali dengan warna hijau
                                    const box = resizedDetections[0].detection.box;
                                    context.strokeStyle = '#00ff88';
                                    context.lineWidth = 3;
                                    context.strokeRect(box.x, box.y, box.width, box.height);
                                    
                                    // Tambahkan nama
                                    context.fillStyle = '#00ff88';
                                    context.font = '18px Arial';
                                    context.fillText(matchedFace.name, box.x, box.y > 20 ? box.y - 10 : box.y + 20);
                                    
                                    // Hentikan scanning sementara
                                    isScanning = false;
                                    
                                    // Proses absensi
                                    processAttendance(matchedFace);
                                    
                                    // Animasi deteksi wajah
                                    document.querySelector('.video-container').classList.add('face-detected');
                                    setTimeout(() => {
                                        document.querySelector('.video-container').classList.remove('face-detected');
                                    }, 1000);
                                    
                                    return; // Keluar dari loop scanning
                                }
                            }
                        }
                    }
                    
                    // Lanjutkan scanning jika tidak ada wajah yang dikenali
                    setTimeout(detectFaces, 500);
                } catch (error) {
                    console.error('Error saat scanning:', error);
                    isScanning = false;
                    updateStatus('Error scanning', 'status-error');
                }
            }
            
            // Mulai proses deteksi
            detectFaces();
        }
        
        // Proses absensi setelah wajah dikenali
        function processAttendance(employee) {
            const now = new Date();
            const currentTime = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const currentDate = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Cek apakah sudah absen hari ini
            const todayRecords = attendanceRecords.filter(record => 
                record.employeeId === employee.id && 
                new Date(record.timestamp).toDateString() === now.toDateString()
            );
            
            let attendanceType = 'checkin';
            let message = '';
            
            if (todayRecords.length === 0) {
                // Check-in
                attendanceType = 'checkin';
                message = `Check-in berhasil! Selamat datang ${employee.name}`;
            } else if (todayRecords.length === 1 && todayRecords[0].type === 'checkin') {
                // Check-out
                attendanceType = 'checkout';
                message = `Check-out berhasil! Selamat jalan ${employee.name}`;
            } else {
                // Sudah check-in dan check-out hari ini
                message = `${employee.name}, Anda sudah melakukan check-in dan check-out hari ini.`;
                attendanceType = null;
            }
            
            // Jika ada aksi absensi
            if (attendanceType) {
                // Tambahkan catatan absensi
                const attendanceRecord = {
                    id: generateId(),
                    employeeId: employee.id,
                    name: employee.name,
                    department: employee.department,
                    type: attendanceType,
                    timestamp: now.toISOString(),
                    time: currentTime,
                    date: currentDate
                };
                
                attendanceRecords.unshift(attendanceRecord);
                
                // Simpan data
                saveData();
                
                // Update tampilan
                updateAttendanceList();
                updateStats();
            }
            
            // Tampilkan modal hasil
            showModal('Absensi Berhasil', message);
            
            // Lanjutkan scanning setelah 3 detik
            setTimeout(() => {
                isScanning = true;
                updateStatus('Scanning wajah...', 'status-scanning');
                startScan();
            }, 3000);
        }
        
        // Tampilkan modal
        function showModal(title, message) {
            const modal = document.getElementById('resultModal');
            const modalMessage = document.getElementById('modalMessage');
            
            modalMessage.innerHTML = `
                <h3 style="margin-bottom: 10px; color: #00c6ff;">${title}</h3>
                <p>${message}</p>
            `;
            
            modal.style.display = 'flex';
        }
        
        // Tutup modal
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('resultModal').style.display = 'none';
        });
        
        // Tampilkan form registrasi wajah baru
        document.getElementById('registerFace').addEventListener('click', function() {
            if (!isCameraOn) {
                showModal('Peringatan', 'Silakan aktifkan kamera terlebih dahulu.');
                return;
            }
            
            document.getElementById('registrationSection').style.display = 'block';
        });
        
        // Batal registrasi
        document.getElementById('cancelRegistration').addEventListener('click', function() {
            document.getElementById('registrationSection').style.display = 'none';
            resetRegistrationForm();
        });
        
        // Ambil foto wajah untuk registrasi
        document.getElementById('captureFace').addEventListener('click', async function() {
            const name = document.getElementById('employeeName').value.trim();
            const id = document.getElementById('employeeId').value.trim();
            const dept = document.getElementById('employeeDept').value.trim();
            
            if (!name || !id || !dept) {
                showModal('Peringatan', 'Harap isi semua field terlebih dahulu.');
                return;
            }
            
            // Cek apakah ID sudah terdaftar
            if (registeredFaces.some(face => face.id === id)) {
                showModal('Peringatan', `ID ${id} sudah terdaftar. Gunakan ID lain.`);
                return;
            }
            
            try {
                updateStatus('Mengambil foto wajah...', 'status-scanning');
                
                const video = document.getElementById('videoElement');
                const detections = await faceapi.detectSingleFace(
                    video, 
                    new faceapi.TinyFaceDetectorOptions()
                ).withFaceLandmarks().withFaceDescriptor();
                
                if (!detections) {
                    showModal('Peringatan', 'Tidak ada wajah yang terdeteksi. Pastikan wajah Anda terlihat jelas di kamera.');
                    updateStatus('Kamera aktif', 'status-ready');
                    return;
                }
                
                // Simpan data wajah
                const newFace = {
                    id: id,
                    name: name,
                    department: dept,
                    descriptor: Array.from(detections.descriptor),
                    registrationDate: new Date().toLocaleDateString('id-ID')
                };
                
                registeredFaces.push(newFace);
                
                // Simpan descriptor untuk face matching
                const labeledDescriptor = new faceapi.LabeledFaceDescriptors(
                    id, 
                    [new Float32Array(detections.descriptor)]
                );
                
                faceDescriptors.push(labeledDescriptor);
                
                // Simpan data
                saveData();
                
                // Update tampilan
                updateEmployeeList();
                
                // Reset form
                resetRegistrationForm();
                document.getElementById('registrationSection').style.display = 'none';
                
                updateStatus('Wajah berhasil didaftarkan!', 'status-ready');
                showModal('Registrasi Berhasil', `Wajah ${name} (${id}) berhasil didaftarkan.`);
                
            } catch (error) {
                console.error('Error saat mengambil foto wajah:', error);
                showModal('Error', 'Terjadi kesalahan saat mengambil foto wajah.');
                updateStatus('Kamera aktif', 'status-ready');
            }
        });
        
        // Reset form registrasi
        function resetRegistrationForm() {
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeId').value = '';
            document.getElementById('employeeDept').value = '';
        }
        
        // Update daftar karyawan terdaftar
        function updateEmployeeList() {
            const employeeList = document.getElementById('employeeList');
            
            if (registeredFaces.length === 0) {
                employeeList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users-slash"></i>
                        <p>Belum ada karyawan terdaftar</p>
                    </div>
                `;
                return;
            }
            
            employeeList.innerHTML = registeredFaces.map(employee => `
                <div class="attendance-item">
                    <div class="attendance-avatar">${getInitials(employee.name)}</div>
                    <div class="attendance-info">
                        <div class="attendance-name">${employee.name}</div>
                        <div class="attendance-time">
                            <i class="fas fa-id-card"></i> ${employee.id} | 
                            <i class="fas fa-building"></i> ${employee.department}
                        </div>
                    </div>
                    <div>
                        <div class="attendance-time">
                            <i class="fas fa-calendar-alt"></i> Terdaftar: ${employee.registrationDate}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Update daftar kehadiran
        function updateAttendanceList() {
            const attendanceList = document.getElementById('attendanceList');
            
            if (attendanceRecords.length === 0) {
                attendanceList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Belum ada catatan kehadiran hari ini</p>
                    </div>
                `;
                return;
            }
            
            // Ambil hanya catatan hari ini
            const today = new Date().toDateString();
            const todayRecords = attendanceRecords.filter(record => 
                new Date(record.timestamp).toDateString() === today
            );
            
            if (todayRecords.length === 0) {
                attendanceList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Belum ada catatan kehadiran hari ini</p>
                    </div>
                `;
                return;
            }
            
            attendanceList.innerHTML = todayRecords.map(record => `
                <div class="attendance-item">
                    <div class="attendance-avatar">${getInitials(record.name)}</div>
                    <div class="attendance-info">
                        <div class="attendance-name">${record.name}</div>
                        <div class="attendance-time">
                            <i class="fas fa-clock"></i> ${record.time} | 
                            <i class="fas fa-calendar"></i> ${record.date}
                        </div>
                    </div>
                    <div>
                        <span class="attendance-type type-${record.type}">
                            ${record.type === 'checkin' ? 'CHECK-IN' : 'CHECK-OUT'}
                        </span>
                        <div class="attendance-time">
                            <i class="fas fa-building"></i> ${record.department}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Update statistik
        function updateStats() {
            const today = new Date().toDateString();
            const todayRecords = attendanceRecords.filter(record => 
                new Date(record.timestamp).toDateString() === today
            );
            
            const uniqueEmployees = [...new Set(todayRecords.map(record => record.employeeId))];
            const checkinCount = todayRecords.filter(record => record.type === 'checkin').length;
            const checkoutCount = todayRecords.filter(record => record.type === 'checkout').length;
            
            document.getElementById('totalPresent').textContent = uniqueEmployees.length;
            document.getElementById('checkinCount').textContent = checkinCount;
            document.getElementById('checkoutCount').textContent = checkoutCount;
        }
        
        // Helper function untuk mendapatkan inisial nama
        function getInitials(name) {
            return name.split(' ').map(part => part[0]).join('').toUpperCase().substring(0, 2);
        }
        
        // Helper function untuk generate ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // Event listeners untuk tombol
        document.getElementById('startCamera').addEventListener('click', startCamera);
        document.getElementById('stopCamera').addEventListener('click', stopCamera);
        document.getElementById('startScan').addEventListener('click', startScan);
        
        // Tambahkan beberapa data contoh untuk demo
        function addSampleData() {
            // Hanya tambahkan data contoh jika tidak ada data sebelumnya
            if (registeredFaces.length === 0) {
                const sampleFaces = [
                    { id: 'EMP001', name: 'Ahmad Santoso', department: 'IT', registrationDate: '1 Jan 2023' },
                    { id: 'EMP002', name: 'Siti Rahayu', department: 'HRD', registrationDate: '15 Feb 2023' },
                    { id: 'EMP003', name: 'Budi Prasetyo', department: 'Keuangan', registrationDate: '10 Mar 2023' },
                    { id: 'EMP004', name: 'Maya Indah', department: 'Marketing', registrationDate: '5 Apr 2023' }
                ];
                
                // Tambahkan descriptor kosong untuk contoh
                sampleFaces.forEach(face => {
                    registeredFaces.push(face);
                    
                    // Buat descriptor acak untuk contoh (dalam implementasi nyata ini akan dari foto wajah)
                    const randomDescriptor = new Array(128).fill(0).map(() => Math.random());
                    const labeledDescriptor = new faceapi.LabeledFaceDescriptors(
                        face.id, 
                        [new Float32Array(randomDescriptor)]
                    );
                    
                    faceDescriptors.push(labeledDescriptor);
                });
                
                // Tambahkan contoh catatan kehadiran
                const now = new Date();
                const today = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const morningTime = '08:15';
                
                const sampleAttendance = [
                    { 
                        id: generateId(), 
                        employeeId: 'EMP001', 
                        name: 'Ahmad Santoso', 
                        department: 'IT',
                        type: 'checkin', 
                        timestamp: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 15).toISOString(),
                        time: morningTime,
                        date: today
                    },
                    { 
                        id: generateId(), 
                        employeeId: 'EMP002', 
                        name: 'Siti Rahayu', 
                        department: 'HRD',
                        type: 'checkin', 
                        timestamp: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 30).toISOString(),
                        time: '08:30',
                        date: today
                    }
                ];
                
                sampleAttendance.forEach(record => attendanceRecords.push(record));
                
                // Simpan dan update tampilan
                saveData();
                updateEmployeeList();
                updateAttendanceList();
                updateStats();
                
                console.log('Data contoh berhasil ditambahkan');
            }
        }
        
        // Inisialisasi saat halaman dimuat
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('Memulai inisialisasi sistem absensi...');
            
            // Muat model AI
            await loadModels();
            
            // Tambahkan data contoh setelah model dimuat
            setTimeout(addSampleData, 1000);
            
            // Event listener untuk modal
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('resultModal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            console.log('Sistem absensi siap digunakan');
        });
    </script>
</body>
</html>
