<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Face Recognition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2d3748);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .app-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .panel {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .panel-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #00c6ff;
            border-bottom: 2px solid rgba(0, 198, 255, 0.5);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title i {
            color: #00c6ff;
        }
        
        .camera-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 500px;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        #videoElement {
            width: 100%;
            height: auto;
            display: block;
            background: #000;
            transform: scaleX(-1);
        }
        
        .canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .camera-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn {
            padding: 14px 28px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0, 114, 255, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(90deg, #00b09b, #96c93d);
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0, 176, 155, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(90deg, #f7971e, #ffd200);
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(247, 151, 30, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(255, 65, 108, 0.4);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .status-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }
        
        .status-ready {
            background-color: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }
        
        .status-scanning {
            background-color: #ffcc00;
            box-shadow: 0 0 10px #ffcc00;
            animation: pulse 1s infinite;
        }
        
        .status-error {
            background-color: #ff3333;
            box-shadow: 0 0 10px #ff3333;
        }
        
        .status-paused {
            background-color: #888;
            box-shadow: 0 0 10px #888;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .attendance-list {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .attendance-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border-left: 5px solid #00c6ff;
            transition: all 0.3s ease;
        }
        
        .attendance-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .attendance-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .attendance-info {
            flex: 1;
        }
        
        .attendance-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .attendance-time {
            font-size: 0.9rem;
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .attendance-type {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .type-checkin {
            background-color: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .type-checkout {
            background-color: rgba(255, 204, 0, 0.2);
            color: #ffcc00;
        }
        
        .registration-section {
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1rem;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #00c6ff;
            box-shadow: 0 0 0 2px rgba(0, 198, 255, 0.2);
        }
        
        .stats-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
        }
        
        .stat-card {
            flex: 1;
            min-width: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border-top: 5px solid #00c6ff;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
            color: #00c6ff;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #aaa;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #aaa;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #555;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a2a6c, #2d3748);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        .modal-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #00c6ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-message {
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #aaa;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .camera-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            header h1 {
                font-size: 2.2rem;
            }
        }
        
        @keyframes faceDetected {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(0, 255, 136, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
        }
        
        .face-detected {
            animation: faceDetected 1s ease-out;
        }
        
        .scan-timer {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-camera"></i> Sistem Absensi Face Recognition</h1>
            <p>Absensi otomatis dengan teknologi pengenalan wajah. Sistem akan mengenali wajah Anda dan mencatat kehadiran secara otomatis.</p>
        </header>
        
        <div class="app-container">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-video"></i> Kamera Absensi</h2>
                <div class="camera-section">
                    <div class="video-container">
                        <video id="videoElement" autoplay muted playsinline></video>
                        <canvas id="canvasOverlay" class="canvas-overlay"></canvas>
                    </div>
                    
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">Memuat model AI...</span>
                    </div>
                    
                    <div class="scan-timer" id="scanTimer" style="display: none;">
                        <i class="fas fa-clock"></i> Scan akan berakhir dalam: <span id="timerCount">30</span> detik
                    </div>
                    
                    <div class="camera-controls">
                        <button class="btn btn-primary" id="startCamera">
                            <i class="fas fa-play"></i> Mulai Kamera
                        </button>
                        <button class="btn btn-success" id="startScan" disabled>
                            <i class="fas fa-search"></i> Mulai Scan (30 detik)
                        </button>
                        <button class="btn btn-warning" id="registerFace" disabled>
                            <i class="fas fa-user-plus"></i> Daftarkan Wajah
                        </button>
                        <button class="btn btn-danger" id="stopCamera" disabled>
                            <i class="fas fa-stop"></i> Hentikan
                        </button>
                    </div>
                </div>
                
                <div class="registration-section" id="registrationSection" style="display: none;">
                    <h3 class="panel-title"><i class="fas fa-user-edit"></i> Registrasi Wajah Baru</h3>
                    <div class="form-group">
                        <label for="employeeName">Nama Lengkap</label>
                        <input type="text" id="employeeName" placeholder="Masukkan nama lengkap">
                    </div>
                    <div class="form-group">
                        <label for="employeeId">ID Karyawan</label>
                        <input type="text" id="employeeId" placeholder="Masukkan ID karyawan">
                    </div>
                    <div class="form-group">
                        <label for="employeeDept">Departemen</label>
                        <select id="employeeDept">
                            <option value="">Pilih Departemen</option>
                            <option value="IT">IT</option>
                            <option value="HRD">HRD</option>
                            <option value="Keuangan">Keuangan</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Produksi">Produksi</option>
                            <option value="Operasional">Operasional</option>
                        </select>
                    </div>
                    <div class="camera-controls">
                        <button class="btn btn-success" id="captureFace">
                            <i class="fas fa-camera"></i> Ambil Foto Wajah
                        </button>
                        <button class="btn btn-danger" id="cancelRegistration">
                            <i class="fas fa-times"></i> Batal
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-list-check"></i> Daftar Kehadiran Hari Ini</h2>
                <div class="attendance-list" id="attendanceList">
                    <!-- Daftar kehadiran akan diisi oleh JavaScript -->
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPresent">0</div>
                        <div class="stat-label">Hadir Hari Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="checkinCount">0</div>
                        <div class="stat-label">Check-in</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="checkoutCount">0</div>
                        <div class="stat-label">Check-out</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2 class="panel-title"><i class="fas fa-database"></i> Data Karyawan Terdaftar</h2>
            <div class="attendance-list" id="employeeList">
                <!-- Daftar karyawan terdaftar akan diisi oleh JavaScript -->
            </div>
        </div>
        
        <footer>
            <p>Sistem Absensi Face Recognition &copy; 2023 - Dibuat dengan <i class="fas fa-heart" style="color: #ff416c;"></i></p>
            <p>Sistem ini bekerja sepenuhnya di browser Anda. Data disimpan secara lokal di perangkat Anda.</p>
        </footer>
    </div>
    
    <!-- Modal untuk hasil scan -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle"><i class="fas fa-user-check"></i> Hasil Scan Wajah</h2>
            <div class="modal-message" id="modalMessage">
                <!-- Pesan hasil scan akan dimuat di sini -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="closeModal">Tutup</button>
            </div>
        </div>
    </div>
    
    <script>
        // Inisialisasi variabel
        let videoStream = null;
        let isScanning = false;
        let isCameraOn = false;
        let registeredFaces = [];
        let attendanceRecords = [];
        let faceDescriptors = [];
        let scanInterval = null;
        let scanTimer = null;
        let scanTimeout = null;
        const SCAN_DURATION = 30; // Durasi scan dalam detik
        
        // Load models untuk face-api.js
        async function loadModels() {
            try {
                updateStatus('Memuat model AI...', 'status-scanning');
                
                // Gunakan model dari CDN
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights');
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights');
                await faceapi.nets.faceRecognitionNet.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights');
                
                updateStatus('Model AI siap!', 'status-ready');
                console.log('Model AI berhasil dimuat');
                
                // Coba muat data yang disimpan sebelumnya
                loadSavedData();
            } catch (error) {
                console.error('Gagal memuat model AI:', error);
                updateStatus('Gagal memuat model AI', 'status-error');
                showModal('Error', 'Gagal memuat model AI. Pastikan koneksi internet Anda aktif untuk mengunduh model pertama kali.');
            }
        }
        
        // Muat data yang disimpan di localStorage
        function loadSavedData() {
            try {
                const savedFaces = localStorage.getItem('registeredFaces');
                const savedAttendance = localStorage.getItem('attendanceRecords');
                
                if (savedFaces) {
                    registeredFaces = JSON.parse(savedFaces);
                    updateEmployeeList();
                }
                
                if (savedAttendance) {
                    attendanceRecords = JSON.parse(savedAttendance);
                    updateAttendanceList();
                    updateStats();
                }
                
                console.log('Data berhasil dimuat dari penyimpanan lokal');
            } catch (error) {
                console.error('Gagal memuat data dari penyimpanan lokal:', error);
            }
        }
        
        // Simpan data ke localStorage
        function saveData() {
            try {
                localStorage.setItem('registeredFaces', JSON.stringify(registeredFaces));
                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                console.log('Data berhasil disimpan ke penyimpanan lokal');
            } catch (error) {
                console.error('Gagal menyimpan data ke penyimpanan lokal:', error);
            }
        }
        
        // Update status indikator
        function updateStatus(text, statusClass) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = text;
            
            // Reset semua kelas status
            statusDot.classList.remove('status-ready', 'status-scanning', 'status-error', 'status-paused');
            
            // Tambahkan kelas status baru
            if (statusClass) {
                statusDot.classList.add(statusClass);
            }
        }
        
        // Mulai kamera
        async function startCamera() {
            try {
                const video = document.getElementById('videoElement');
                
                // Minta akses ke kamera
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: false
                });
                
                video.srcObject = videoStream;
                isCameraOn = true;
                updateStatus('Kamera aktif', 'status-ready');
                
                // Enable tombol lainnya
                document.getElementById('startScan').disabled = false;
                document.getElementById('registerFace').disabled = false;
                document.getElementById('stopCamera').disabled = false;
                document.getElementById('startCamera').disabled = true;
                
                console.log('Kamera berhasil diaktifkan');
            } catch (error) {
                console.error('Gagal mengakses kamera:', error);
                updateStatus('Gagal mengakses kamera', 'status-error');
                showModal('Error', 'Tidak dapat mengakses kamera. Pastikan Anda memberikan izin akses kamera dan perangkat Anda memiliki kamera yang berfungsi.');
            }
        }
        
        // Hentikan kamera
        function stopCamera() {
            stopScanning(); // Hentikan scanning jika sedang berjalan
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            const video = document.getElementById('videoElement');
            video.srcObject = null;
            
            // Clear canvas
            const canvas = document.getElementById('canvasOverlay');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            isCameraOn = false;
            
            updateStatus('Kamera dihentikan', 'status-error');
            
            // Reset tombol
            document.getElementById('startScan').disabled = true;
            document.getElementById('registerFace').disabled = true;
            document.getElementById('stopCamera').disabled = true;
            document.getElementById('startCamera').disabled = false;
            
            // Sembunyikan timer
            document.getElementById('scanTimer').style.display = 'none';
            
            console.log('Kamera dihentikan');
        }
        
        // Mulai scanning wajah
        function startScan() {
            if (!isCameraOn) {
                showModal('Peringatan', 'Silakan aktifkan kamera terlebih dahulu.');
                return;
            }
            
            isScanning = true;
            updateStatus('Scanning wajah...', 'status-scanning');
            
            // Tampilkan timer
            document.getElementById('scanTimer').style.display = 'block';
            let timeLeft = SCAN_DURATION;
            document.getElementById('timerCount').textContent = timeLeft;
            
            // Update timer setiap detik
            scanTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('timerCount').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    stopScanning();
                    showModal('Info', 'Waktu scanning telah habis. Klik "Mulai Scan" lagi jika ingin melanjutkan.');
                }
            }, 1000);
            
            // Set timeout untuk menghentikan scanning
            scanTimeout = setTimeout(() => {
                stopScanning();
            }, SCAN_DURATION * 1000);
            
            // Disable tombol start scan
            document.getElementById('startScan').disabled = true;
            document.getElementById('stopCamera').disabled = true;
            
            // Mulai proses deteksi wajah
            detectFaces();
        }
        
        // Hentikan scanning
        function stopScanning() {
            isScanning = false;
            
            // Hentikan interval dan timeout
            if (scanTimer) {
                clearInterval(scanTimer);
                scanTimer = null;
            }
            
            if (scanTimeout) {
                clearTimeout(scanTimeout);
                scanTimeout = null;
            }
            
            // Hentikan interval deteksi wajah
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            // Clear canvas
            const canvas = document.getElementById('canvasOverlay');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Update status
            if (isCameraOn) {
                updateStatus('Kamera aktif - Scan dihentikan', 'status-ready');
            }
            
            // Sembunyikan timer
            document.getElementById('scanTimer').style.display = 'none';
            
            // Enable tombol
            document.getElementById('startScan').disabled = !isCameraOn;
            document.getElementById('stopCamera').disabled = !isCameraOn;
            
            console.log('Scanning dihentikan');
        }
        
        // Fungsi untuk mendeteksi wajah
        async function detectFaces() {
            if (!isScanning || !isCameraOn) return;
            
            try {
                const video = document.getElementById('videoElement');
                const canvas = document.getElementById('canvasOverlay');
                
                // Set ukuran canvas sama dengan video
                if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                }
                
                // Deteksi wajah
                const detections = await faceapi.detectAllFaces(
                    video, 
                    new faceapi.TinyFaceDetectorOptions()
                ).withFaceLandmarks().withFaceDescriptors();
                
                // Clear canvas
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Gambar deteksi
                const resizedDetections = faceapi.resizeResults(detections, { width: video.videoWidth, height: video.videoHeight });
                faceapi.draw.drawDetections(canvas, resizedDetections);
                faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
                
                // Jika ada wajah yang terdeteksi
                if (detections.length > 0) {
                    const detection = detections[0];
                    
                    // Cek apakah wajah dikenali
                    if (registeredFaces.length > 0 && faceDescriptors.length > 0) {
                        const faceMatcher = new faceapi.FaceMatcher(faceDescriptors, 0.6);
                        const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                        
                        // Jika wajah dikenali
                        if (bestMatch.distance < 0.5) {
                            const matchedFace = registeredFaces.find(face => face.id === bestMatch.label);
                            
                            if (matchedFace) {
                                // Tandai wajah yang dikenali dengan warna hijau
                                const box = resizedDetections[0].detection.box;
                                ctx.strokeStyle = '#00ff88';
                                ctx.lineWidth = 3;
                                ctx.strokeRect(box.x, box.y, box.width, box.height);
                                
                                // Tambahkan nama
                                ctx.fillStyle = '#00ff88';
                                ctx.font = '18px Arial';
                                ctx.fillText(matchedFace.name, box.x, box.y > 20 ? box.y - 10 : box.y + 20);
                                
                                // Animasi
                                document.querySelector('.video-container').classList.add('face-detected');
                                setTimeout(() => {
                                    document.querySelector('.video-container').classList.remove('face-detected');
                                }, 1000);
                                
                                // Proses absensi
                                processAttendance(matchedFace);
                                
                                // Hentikan scanning setelah berhasil mengenali
                                stopScanning();
                                return;
                            }
                        } else {
                            // Wajah tidak dikenali
                            const box = resizedDetections[0].detection.box;
                            ctx.strokeStyle = '#ff3333';
                            ctx.lineWidth = 3;
                            ctx.strokeRect(box.x, box.y, box.width, box.height);
                            
                            ctx.fillStyle = '#ff3333';
                            ctx.font = '18px Arial';
                            ctx.fillText('Tidak Dikenali', box.x, box.y > 20 ? box.y - 10 : box.y + 20);
                        }
                    } else {
                        // Tidak ada wajah terdaftar
                        const box = resizedDetections[0].detection.box;
                        ctx.strokeStyle = '#ffcc00';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(box.x, box.y, box.width, box.height);
                        
                        ctx.fillStyle = '#ffcc00';
                        ctx.font = '18px Arial';
                        ctx.fillText('Tidak Terdaftar', box.x, box.y > 20 ? box.y - 10 : box.y + 20);
                    }
                }
                
                // Lanjutkan scanning jika masih aktif
                if (isScanning) {
                    scanInterval = setTimeout(detectFaces, 500);
                }
            } catch (error) {
                console.error('Error saat scanning:', error);
                if (isScanning) {
                    scanInterval = setTimeout(detectFaces, 1000);
                }
            }
        }
        
        // Proses absensi setelah wajah dikenali
        function processAttendance(employee) {
            const now = new Date();
            const currentTime = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const currentDate = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Cek apakah sudah absen hari ini
            const todayRecords = attendanceRecords.filter(record => 
                record.employeeId === employee.id && 
                new Date(record.timestamp).toDateString() === now.toDateString()
            );
            
            let attendanceType = 'checkin';
            let message = '';
            
            if (todayRecords.length === 0) {
                // Check-in
                attendanceType = 'checkin';
                message = `<strong>Check-in berhasil!</strong><br><br>
                          <i class="fas fa-user"></i> ${employee.name}<br>
                          <i class="fas fa-clock"></i> ${currentTime}<br>
                          <i class="fas fa-building"></i> ${employee.department}<br><br>
                          Selamat bekerja!`;
            } else if (todayRecords.length === 1 && todayRecords[0].type === 'checkin') {
                // Check-out
                attendanceType = 'checkout';
                message = `<strong>Check-out berhasil!</strong><br><br>
                          <i class="fas fa-user"></i> ${employee.name}<br>
                          <i class="fas fa-clock"></i> ${currentTime}<br>
                          <i class="fas fa-building"></i> ${employee.department}<br><br>
                          Terima kasih telah bekerja hari ini!`;
            } else {
                // Sudah check-in dan check-out hari ini
                message = `<strong>Informasi</strong><br><br>
                          <i class="fas fa-user"></i> ${employee.name}<br>
                          Anda sudah melakukan check-in dan check-out hari ini.<br><br>
                          <i class="fas fa-info-circle"></i> Check-in: ${todayRecords.find(r => r.type === 'checkin').time}`;
                attendanceType = null;
            }
            
            // Jika ada aksi absensi
            if (attendanceType) {
                // Tambahkan catatan absensi
                const attendanceRecord = {
                    id: generateId(),
                    employeeId: employee.id,
                    name: employee.name,
                    department: employee.department,
                    type: attendanceType,
                    timestamp: now.toISOString(),
                    time: currentTime,
                    date: currentDate
                };
                
                attendanceRecords.unshift(attendanceRecord);
                
                // Simpan data
                saveData();
                
                // Update tampilan
                updateAttendanceList();
                updateStats();
            }
            
            // Tampilkan modal hasil
            showModal('Absensi Berhasil', message);
        }
        
        // Tampilkan modal
        function showModal(title, message) {
            const modal = document.getElementById('resultModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            
            modalTitle.innerHTML = `<i class="fas fa-user-check"></i> ${title}`;
            modalMessage.innerHTML = message;
            
            modal.style.display = 'flex';
        }
        
        // Event Listeners
        document.getElementById('startCamera').addEventListener('click', startCamera);
        document.getElementById('stopCamera').addEventListener('click', stopCamera);
        document.getElementById('startScan').addEventListener('click', startScan);
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('resultModal').style.display = 'none';
        });
        
        // Registrasi wajah
        document.getElementById('registerFace').addEventListener('click', function() {
            if (!isCameraOn) {
                showModal('Peringatan', 'Silakan aktifkan kamera terlebih dahulu.');
                return;
            }
            
            document.getElementById('registrationSection').style.display = 'block';
        });
        
        document.getElementById('cancelRegistration').addEventListener('click', function() {
            document.getElementById('registrationSection').style.display = 'none';
            resetRegistrationForm();
        });
        
        document.getElementById('captureFace').addEventListener('click', async function() {
            const name = document.getElementById('employeeName').value.trim();
            const id = document.getElementById('employeeId').value.trim();
            const dept = document.getElementById('employeeDept').value;
            
            if (!name || !id || !dept) {
                showModal('Peringatan', 'Harap isi semua field terlebih dahulu.');
                return;
            }
            
            // Cek apakah ID sudah terdaftar
            if (registeredFaces.some(face => face.id === id)) {
                showModal('Peringatan', `ID ${id} sudah terdaftar. Gunakan ID lain.`);
                return;
            }
            
            try {
                updateStatus('Mengambil foto wajah...', 'status-scanning');
                
                const video = document.getElementById('videoElement');
                const detection = await faceapi.detectSingleFace(
                    video, 
                    new faceapi.TinyFaceDetectorOptions()
                ).withFaceLandmarks().withFaceDescriptor();
                
                if (!detection) {
                    showModal('Peringatan', 'Tidak ada wajah yang terdeteksi. Pastikan wajah Anda terlihat jelas di kamera.');
                    updateStatus('Kamera aktif', 'status-ready');
                    return;
                }
                
                // Simpan data wajah
                const newFace = {
                    id: id,
                    name: name,
                    department: dept,
                    descriptor: Array.from(detection.descriptor),
                    registrationDate: new Date().toLocaleDateString('id-ID')
                };
                
                registeredFaces.push(newFace);
                
                // Buat labeled descriptor untuk face matching
                const labeledDescriptor = new faceapi.LabeledFaceDescriptors(
                    id, 
                    [new Float32Array(detection.descriptor)]
                );
                
                faceDescriptors.push(labeledDescriptor);
                
                // Simpan data
                saveData();
                
                // Update tampilan
                updateEmployeeList();
                
                // Reset form dan sembunyikan
                resetRegistrationForm();
                document.getElementById('registrationSection').style.display = 'none';
                
                updateStatus('Wajah berhasil didaftarkan!', 'status-ready');
                showModal('Registrasi Berhasil', 
                    `<strong>Registrasi berhasil!</strong><br><br>
                    <i class="fas fa-user"></i> ${name}<br>
                    <i class="fas fa-id-card"></i> ${id}<br>
                    <i class="fas fa-building"></i> ${dept}<br><br>
                    Wajah telah berhasil didaftarkan ke sistem.`);
                
            } catch (error) {
                console.error('Error saat mengambil foto wajah:', error);
                showModal('Error', 'Terjadi kesalahan saat mengambil foto wajah.');
                updateStatus('Kamera aktif', 'status-ready');
            }
        });
        
        // Reset form registrasi
        function resetRegistrationForm() {
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeId').value = '';
            document.getElementById('employeeDept').value = '';
        }
        
        // Update daftar karyawan terdaftar
        function updateEmployeeList() {
            const employeeList = document.getElementById('employeeList');
            
            if (registeredFaces.length === 0) {
                employeeList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users-slash"></i>
                        <p>Belum ada karyawan terdaftar</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Klik "Daftarkan Wajah" untuk menambahkan karyawan</p>
                    </div>
                `;
                return;
            }
            
            employeeList.innerHTML = registeredFaces.map(employee => `
                <div class="attendance-item">
                    <div class="attendance-avatar">${getInitials(employee.name)}</div>
                    <div class="attendance-info">
                        <div class="attendance-name">${employee.name}</div>
                        <div class="attendance-time">
                            <i class="fas fa-id-card"></i> ${employee.id} | 
                            <i class="fas fa-building"></i> ${employee.department}
                        </div>
                    </div>
                    <div>
                        <div class="attendance-time">
                            <i class="fas fa-calendar-alt"></i> Terdaftar: ${employee.registrationDate}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Update daftar kehadiran
        function updateAttendanceList() {
            const attendanceList = document.getElementById('attendanceList');
            
            if (attendanceRecords.length === 0) {
                attendanceList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Belum ada catatan kehadiran hari ini</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Lakukan scan wajah untuk mencatat kehadiran</p>
                    </div>
                `;
                return;
            }
            
            // Ambil hanya catatan hari ini
            const today = new Date().toDateString();
            const todayRecords = attendanceRecords.filter(record => 
                new Date(record.timestamp).toDateString() === today
            ).slice(0, 10); // Batasi 10 record terbaru
            
            if (todayRecords.length === 0) {
                attendanceList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Belum ada catatan kehadiran hari ini</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Lakukan scan wajah untuk mencatat kehadiran</p>
                    </div>
                `;
                return;
            }
            
            attendanceList.innerHTML = todayRecords.map(record => `
                <div class="attendance-item">
                    <div class="attendance-avatar">${getInitials(record.name)}</div>
                    <div class="attendance-info">
                        <div class="attendance-name">${record.name}</div>
                        <div class="attendance-time">
                            <i class="fas fa-clock"></i> ${record.time} | 
                            <i class="fas fa-calendar"></i> ${record.date.split(',')[0]}
                        </div>
                    </div>
                    <div>
                        <span class="attendance-type type-${record.type}">
                            ${record.type === 'checkin' ? 'CHECK-IN' : 'CHECK-OUT'}
                        </span>
                        <div class="attendance-time">
                            <i class="fas fa-building"></i> ${record.department}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Update statistik
        function updateStats() {
            const today = new Date().toDateString();
            const todayRecords = attendanceRecords.filter(record => 
                new Date(record.timestamp).toDateString() === today
            );
            
            const uniqueEmployees = [...new Set(todayRecords.map(record => record.employeeId))];
            const checkinCount = todayRecords.filter(record => record.type === 'checkin').length;
            const checkoutCount = todayRecords.filter(record => record.type === 'checkout').length;
            
            document.getElementById('totalPresent').textContent = uniqueEmployees.length;
            document.getElementById('checkinCount').textContent = checkinCount;
            document.getElementById('checkoutCount').textContent = checkoutCount;
        }
        
        // Helper functions
        function getInitials(name) {
            return name.split(' ').map(part => part[0]).join('').toUpperCase().substring(0, 2);
        }
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // Tambahkan beberapa data contoh untuk demo
        function addSampleData() {
            if (registeredFaces.length === 0) {
                const sampleFaces = [
                    { id: 'EMP001', name: 'Ahmad Santoso', department: 'IT', registrationDate: '1 Jan 2023', descriptor: [] },
                    { id: 'EMP002', name: 'Siti Rahayu', department: 'HRD', registrationDate: '15 Feb 2023', descriptor: [] },
                    { id: 'EMP003', name: 'Budi Prasetyo', department: 'Keuangan', registrationDate: '10 Mar 2023', descriptor: [] },
                    { id: 'EMP004', name: 'Maya Indah', department: 'Marketing', registrationDate: '5 Apr 2023', descriptor: [] }
                ];
                
                sampleFaces.forEach(face => {
                    registeredFaces.push(face);
                });
                
                // Simpan dan update tampilan
                saveData();
                updateEmployeeList();
                updateStats();
                
                console.log('Data contoh berhasil ditambahkan');
            }
        }
        
        // Inisialisasi saat halaman dimuat
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('Memulai inisialisasi sistem absensi...');
            
            // Muat model AI
            await loadModels();
            
            // Tambahkan data contoh setelah model dimuat
            setTimeout(addSampleData, 1000);
            
            // Event listener untuk modal
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('resultModal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            console.log('Sistem absensi siap digunakan');
        });
    </script>
</body>
</html>
