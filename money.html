<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLCrave Express - All in One</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Light Theme Styles */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #ffffff;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            color: #374151;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            padding: 0.5rem;
            z-index: 40;
            padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 0.75rem;
            gap: 0.25rem;
            transition: all 0.2s;
            border-radius: 0.5rem;
        }

        .nav-item.active {
            color: #f97316;
            background: #fff7ed;
        }

        .nav-item i {
            font-size: 1.25rem;
        }

        /* Main Content */
        .main-content {
            padding: 1rem;
            padding-bottom: calc(5rem + env(safe-area-inset-bottom));
            max-width: 100%;
            margin: 0 auto;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            border: 1px solid #f3f4f6;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            border: 1px solid #f3f4f6;
            text-align: center;
        }

        .stat-value {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: #1f2937;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.2);
        }

        .btn-primary:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(249, 115, 22, 0.2);
        }

        .btn-secondary {
            background: #f8fafc;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:active {
            background: #f1f5f9;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            width: auto;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.2s;
            background: white;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 28rem;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            padding: 1.25rem;
            color: white;
            position: relative;
        }

        .modal-body {
            padding: 1.25rem;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }

        .modal-footer {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid #f3f4f6;
            background: #fafafa;
        }

        /* Lists */
        .transaction-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #f8fafc;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Bubble Chart */
        .bubble-chart-container {
            position: relative;
            height: 250px;
            margin: 1.5rem 0;
        }

        .bubble {
            position: absolute;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-size: 0.75rem;
        }

        /* Tabs */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            left: 1rem;
            z-index: 100;
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.875rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(-100px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateY(0);
        }

        .notification.success {
            background: #10b981;
            color: white;
        }

        .notification.error {
            background: #ef4444;
            color: white;
        }

        .notification.info {
            background: #3b82f6;
            color: white;
        }

        /* Utility Classes */
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .hidden {
            display: none !important;
        }

        /* Account Cards */
        .account-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }

        .account-bca {
            border-left-color: #1e40af;
        }

        .account-tunai {
            border-left-color: #ea580c;
        }

        .account-dana {
            border-left-color: #16a34a;
        }

        /* Safe Area Support */
        @supports(padding: max(0px)) {
            .main-content {
                padding-left: max(1rem, env(safe-area-inset-left));
                padding-right: max(1rem, env(safe-area-inset-right));
            }
        }

        /* Responsive adjustments */
        @media (min-width: 640px) {
            .main-content {
                max-width: 28rem;
                margin: 0 auto;
            }
            
            .stats-grid {
                gap: 1rem;
            }
            
            .stat-value {
                font-size: 1.25rem;
            }
        }

        /* Loading Spinner */
        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Product Row */
        .product-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 0.5rem;
            align-items: end;
            margin-bottom: 1rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-top: 1px solid #e5e7eb;
        }

        .summary-total {
            font-weight: bold;
            font-size: 1.1rem;
            border-top: 2px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-white rounded-full shadow-sm mb-3 border border-orange-100">
                <img src="https://vlcrave.github.io/project/img/icon.png" alt="VLCrave Express" class="w-8 h-8">
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-1">VLCrave Express</h1>
            <p class="text-gray-600 text-sm">All-in-One Business Solution</p>
        </header>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <!-- Quick Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="incomeToday">Rp 0</div>
                    <div class="stat-label">Pendapatan Hari Ini</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="deliveryToday">0</div>
                    <div class="stat-label">Pengantaran Hari Ini</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalBalance">Rp 0</div>
                    <div class="stat-label">Total Saldo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="invoiceCount">0</div>
                    <div class="stat-label">Invoice Bulan Ini</div>
                </div>
            </div>

            <!-- Account Balances -->
            <div class="card">
                <h2 class="text-lg font-bold text-gray-800 mb-3">Saldo Rekening</h2>
                <div id="accountBalances">
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-wallet text-xl mb-2"></i>
                        <p class="text-sm">Belum ada rekening</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <h2 class="text-lg font-bold text-gray-800 mb-3">Quick Actions</h2>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="app.showInvoiceGeneratorModal()" class="btn btn-primary">
                        <i class="fas fa-receipt"></i>
                        Buat Invoice
                    </button>
                    <button onclick="app.showTab('finance')" class="btn btn-secondary">
                        <i class="fas fa-wallet"></i>
                        Keuangan
                    </button>
                </div>
            </div>

            <!-- Recent Invoices -->
            <div class="card">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800">Invoice Terbaru</h2>
                    <button onclick="app.showTab('invoices')" class="text-sm text-orange-600 font-medium">
                        Lihat Semua
                    </button>
                </div>
                <div id="recentInvoices">
                    <div class="text-center py-6 text-gray-500">
                        <i class="fas fa-receipt text-2xl mb-2"></i>
                        <p class="text-sm">Belum ada invoice</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoices Tab -->
        <div id="invoicesTab" class="tab-content">
            <div class="card">
                <div class="flex gap-2 mb-4">
                    <button onclick="app.showInvoiceGeneratorModal()" class="btn btn-primary flex-1">
                        <i class="fas fa-plus mr-2"></i>
                        Buat Invoice
                    </button>
                    <button onclick="app.showManageAccountsModal()" class="btn btn-secondary">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>

                <div id="invoiceList">
                    <!-- Invoices will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Finance Tab -->
        <div id="financeTab" class="tab-content">
            <!-- Finance Quick Stats -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-value" id="financeIncome">Rp 0</div>
                    <div class="stat-label">Pendapatan Bulan Ini</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="financeExpense">Rp 0</div>
                    <div class="stat-label">Pengeluaran Bulan Ini</div>
                </div>
            </div>

            <!-- Finance Actions -->
            <div class="card mb-4">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="app.showAddTransactionModal()" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Transaksi
                    </button>
                    <button onclick="app.showTab('analysis')" class="btn btn-secondary">
                        <i class="fas fa-chart-pie"></i>
                        Analisis
                    </button>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="card">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800">Transaksi Terbaru</h2>
                    <button onclick="app.showTransactionHistory()" class="text-sm text-orange-600 font-medium">
                        Lihat Semua
                    </button>
                </div>
                <div id="recentTransactions">
                    <div class="text-center py-6 text-gray-500">
                        <i class="fas fa-exchange-alt text-2xl mb-2"></i>
                        <p class="text-sm">Belum ada transaksi</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysisTab" class="tab-content">
            <div class="card">
                <button onclick="app.analyzeExpenses()" class="btn btn-primary mb-4" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);">
                    <i class="fas fa-robot mr-2"></i>
                    Analisis AI Pengeluaran
                </button>

                <div id="expenseAnalysis">
                    <div class="bubble-chart-container" id="bubbleChart">
                        <!-- Bubbles will be generated here -->
                    </div>

                    <div id="categoryDetails">
                        <!-- Category details will be generated here -->
                    </div>

                    <div id="aiInsights" class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-robot text-blue-500 text-lg mt-0.5"></i>
                            <div>
                                <h5 class="font-bold text-blue-800 mb-1 text-sm">AI Insights</h5>
                                <p class="text-blue-700 text-xs">Klik tombol analisis untuk melihat insights pengeluaran Anda</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="app.showTab('dashboard')">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="app.showTab('invoices')">
            <i class="fas fa-receipt"></i>
            <span>Invoice</span>
        </button>
        <button class="nav-item" onclick="app.showTab('finance')">
            <i class="fas fa-wallet"></i>
            <span>Keuangan</span>
        </button>
        <button class="nav-item" onclick="app.showTab('analysis')">
            <i class="fas fa-chart-pie"></i>
            <span>Analisis</span>
        </button>
    </nav>

    <!-- Invoice Generator Modal -->
    <div id="invoiceModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold">Buat Invoice</h2>
                <button onclick="app.closeModal()" class="absolute top-4 right-4 text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Produk</label>
                    <div id="productsContainer">
                        <div class="product-row">
                            <div>
                                <label class="form-label text-sm">Nama Produk</label>
                                <input type="text" class="form-input product-name" placeholder="Nama produk" value="Teh Tarik">
                            </div>
                            <div>
                                <label class="form-label text-sm">Qty</label>
                                <input type="number" class="form-input product-qty" placeholder="Qty" value="1" min="1">
                            </div>
                            <div>
                                <label class="form-label text-sm">Harga</label>
                                <input type="number" class="form-input product-price" placeholder="Harga" value="10000">
                            </div>
                            <div>
                                <button onclick="app.removeProduct(this)" class="btn btn-danger btn-sm mt-6">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button onclick="app.addProduct()" class="btn btn-secondary btn-sm mt-2">
                        <i class="fas fa-plus mr-1"></i>Tambah Produk
                    </button>
                </div>

                <div class="form-group">
                    <label class="form-label">Ongkos Kirim</label>
                    <input type="number" id="shippingCost" class="form-input" placeholder="0" value="5000">
                </div>

                <div class="form-group">
                    <label class="form-label">Metode Pembayaran</label>
                    <select id="paymentMethod" class="form-select">
                        <option value="tunai">Tunai</option>
                        <option value="bca">BCA</option>
                    </select>
                </div>

                <!-- Invoice Summary -->
                <div class="bg-gray-50 rounded-lg p-4 mt-4">
                    <h3 class="font-bold text-gray-800 mb-2">Ringkasan Invoice</h3>
                    <div id="invoiceSummary">
                        <div class="summary-row">
                            <span>Subtotal Produk:</span>
                            <span id="subtotalDisplay">Rp 0</span>
                        </div>
                        <div class="summary-row">
                            <span>Ongkos Kirim:</span>
                            <span id="shippingDisplay">Rp 0</span>
                        </div>
                        <div class="summary-row summary-total">
                            <span>Total:</span>
                            <span id="totalDisplay">Rp 0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="app.closeModal()" class="btn btn-secondary flex-1">
                    Batal
                </button>
                <button onclick="app.generateInvoice()" class="btn btn-primary flex-1">
                    <i class="fas fa-check"></i>
                    Buat Invoice
                </button>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="transactionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold">Tambah Transaksi</h2>
                <button onclick="app.closeModal()" class="absolute top-4 right-4 text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Jenis Transaksi</label>
                    <select id="transactionType" class="form-select">
                        <option value="income">Pendapatan</option>
                        <option value="expense">Pengeluaran</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Kategori</label>
                    <select id="transactionCategory" class="form-select">
                        <option value="operasional">Operasional</option>
                        <option value="bahan_baku">Bahan Baku</option>
                        <option value="transportasi">Transportasi</option>
                        <option value="gaji">Gaji Karyawan</option>
                        <option value="listrik">Listrik & Air</option>
                        <option value="internet">Internet</option>
                        <option value="pemeliharaan">Pemeliharaan</option>
                        <option value="lainnya">Lainnya</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Rekening</label>
                    <select id="transactionAccount" class="form-select">
                        <!-- Accounts will be populated here -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Jumlah</label>
                    <input type="number" id="transactionAmount" class="form-input" placeholder="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Keterangan</label>
                    <input type="text" id="transactionDescription" class="form-input" placeholder="Deskripsi transaksi">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="app.closeModal()" class="btn btn-secondary flex-1">
                    Batal
                </button>
                <button onclick="app.saveTransaction()" class="btn btn-primary flex-1">
                    Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- Manage Accounts Modal -->
    <div id="manageAccountsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold">Kelola Rekening</h2>
                <button onclick="app.closeModal()" class="absolute top-4 right-4 text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Tambah Rekening Baru</label>
                    <select id="newAccountType" class="form-select mb-2">
                        <option value="tunai">Tunai</option>
                        <option value="bca">BCA</option>
                        <option value="dana">Dana</option>
                    </select>
                    <input type="number" id="newAccountBalance" class="form-input" placeholder="Saldo awal" value="0">
                    <button onclick="app.addAccount()" class="btn btn-primary mt-2">
                        <i class="fas fa-plus mr-2"></i>
                        Tambah Rekening
                    </button>
                </div>
                
                <div class="mt-4">
                    <h3 class="font-bold text-gray-800 mb-2">Rekening Saat Ini</h3>
                    <div id="accountsList">
                        <!-- Accounts will be listed here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="app.closeModal()" class="btn btn-secondary flex-1">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Invoice Modal -->
    <div id="editInvoiceModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold">Edit Invoice</h2>
                <button onclick="app.closeModal()" class="absolute top-4 right-4 text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="editInvoiceForm">
                    <!-- Edit form will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="app.closeModal()" class="btn btn-secondary flex-1">
                    Batal
                </button>
                <button onclick="app.updateInvoice()" class="btn btn-primary flex-1">
                    <i class="fas fa-save mr-2"></i>
                    Update
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA1kevuJ9mRJ8le8uPXin11uUqJ6sOLopY",
            authDomain: "vlcrave-whatsapp-order.firebaseapp.com",
            projectId: "vlcrave-whatsapp-order",
            storageBucket: "vlcrave-whatsapp-order.firebasestorage.app",
            messagingSenderId: "796602954067",
            appId: "1:796602954067:web:e10a110ae904decdc471a6",
            measurementId: "G-XLWNDN39ZD"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Main Application
        const app = {
            currentTab: 'dashboard',
            invoices: [],
            transactions: [],
            accounts: [],
            currentEditingInvoice: null,
            expenseCategories: {
                'operasional': { name: 'Operasional', color: '#ef4444' },
                'bahan_baku': { name: 'Bahan Baku', color: '#f97316' },
                'transportasi': { name: 'Transportasi', color: '#eab308' },
                'gaji': { name: 'Gaji Karyawan', color: '#84cc16' },
                'listrik': { name: 'Listrik & Air', color: '#06b6d4' },
                'internet': { name: 'Internet', color: '#3b82f6' },
                'pemeliharaan': { name: 'Pemeliharaan', color: '#8b5cf6' },
                'lainnya': { name: 'Lainnya', color: '#64748b' }
            },

            // Initialize App
            async init() {
                console.log("VLCrave Express Mobile App Initialized");
                
                // Set up real-time listeners
                this.setupRealtimeListeners();
                
                // Initialize default accounts if not exists
                await this.initializeDefaultAccounts();
                
                // Setup invoice calculation listeners
                this.setupInvoiceCalculations();
            },

            // Setup invoice calculation listeners
            setupInvoiceCalculations() {
                // Recalculate invoice when inputs change
                document.addEventListener('input', (e) => {
                    if (e.target.classList.contains('product-name') || 
                        e.target.classList.contains('product-qty') || 
                        e.target.classList.contains('product-price') ||
                        e.target.id === 'shippingCost') {
                        this.calculateInvoiceTotal();
                    }
                });
            },

            // Calculate invoice total
            calculateInvoiceTotal() {
                let subtotal = 0;
                
                // Calculate products subtotal
                const productRows = document.querySelectorAll('.product-row');
                productRows.forEach(row => {
                    const qty = parseInt(row.querySelector('.product-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.product-price').value) || 0;
                    subtotal += qty * price;
                });
                
                const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
                const total = subtotal + shippingCost;
                
                // Update display
                document.getElementById('subtotalDisplay').textContent = this.formatCurrency(subtotal);
                document.getElementById('shippingDisplay').textContent = this.formatCurrency(shippingCost);
                document.getElementById('totalDisplay').textContent = this.formatCurrency(total);
            },

            // Initialize default accounts
            async initializeDefaultAccounts() {
                try {
                    const accountsSnapshot = await db.collection("finance_accounts").get();
                    if (accountsSnapshot.empty) {
                        // Create default accounts
                        const defaultAccounts = [
                            { name: 'Tunai', type: 'tunai', balance: 0, createdAt: new Date(), updatedAt: new Date() },
                            { name: 'BCA', type: 'bca', balance: 0, createdAt: new Date(), updatedAt: new Date() }
                        ];
                        
                        for (const account of defaultAccounts) {
                            await db.collection("finance_accounts").add(account);
                        }
                        console.log("Default accounts created");
                    }
                } catch (error) {
                    console.error("Error initializing default accounts:", error);
                }
            },

            // Setup real-time Firestore listeners
            setupRealtimeListeners() {
                // Invoices listener
                db.collection("invoices")
                    .orderBy("createdAt", "desc")
                    .limit(50)
                    .onSnapshot((snapshot) => {
                        this.invoices = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            data.id = doc.id;
                            this.invoices.push(data);
                        });
                        this.updateDashboard();
                        this.renderRecentInvoices();
                        this.renderInvoiceList();
                    });

                // Transactions listener
                db.collection("finance_transactions")
                    .orderBy("createdAt", "desc")
                    .limit(50)
                    .onSnapshot((snapshot) => {
                        this.transactions = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            data.id = doc.id;
                            this.transactions.push(data);
                        });
                        this.updateDashboard();
                        this.renderRecentTransactions();
                    });

                // Accounts listener
                db.collection("finance_accounts")
                    .onSnapshot((snapshot) => {
                        this.accounts = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            data.id = doc.id;
                            this.accounts.push(data);
                        });
                        this.updateDashboard();
                        this.renderAccountBalances();
                        this.renderAccountsList();
                        this.updateAccountSelect();
                    });
            },

            // Tab Navigation
            showTab(tabName) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Remove active class from all nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Show selected tab
                document.getElementById(tabName + 'Tab').classList.add('active');
                
                // Activate corresponding nav item
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach((item, index) => {
                    if (item.textContent.includes(
                        tabName === 'dashboard' ? 'Home' :
                        tabName === 'invoices' ? 'Invoice' :
                        tabName === 'finance' ? 'Keuangan' : 'Analisis'
                    )) {
                        item.classList.add('active');
                    }
                });
                
                this.currentTab = tabName;
            },

            // Modal Management
            showInvoiceGeneratorModal() {
                document.getElementById('invoiceModal').classList.remove('hidden');
                // Reset form
                this.resetInvoiceForm();
                this.calculateInvoiceTotal();
            },

            showAddTransactionModal() {
                document.getElementById('transactionModal').classList.remove('hidden');
                // Reset form
                document.getElementById('transactionAmount').value = '';
                document.getElementById('transactionDescription').value = '';
            },

            showManageAccountsModal() {
                document.getElementById('manageAccountsModal').classList.remove('hidden');
            },

            closeModal() {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.classList.add('hidden');
                });
                this.currentEditingInvoice = null;
            },

            // Invoice Form Management
            resetInvoiceForm() {
                const container = document.getElementById('productsContainer');
                container.innerHTML = `
                    <div class="product-row">
                        <div>
                            <label class="form-label text-sm">Nama Produk</label>
                            <input type="text" class="form-input product-name" placeholder="Nama produk" value="Teh Tarik">
                        </div>
                        <div>
                            <label class="form-label text-sm">Qty</label>
                            <input type="number" class="form-input product-qty" placeholder="Qty" value="1" min="1">
                        </div>
                        <div>
                            <label class="form-label text-sm">Harga</label>
                            <input type="number" class="form-input product-price" placeholder="Harga" value="10000">
                        </div>
                        <div>
                            <button onclick="app.removeProduct(this)" class="btn btn-danger btn-sm mt-6">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('shippingCost').value = '5000';
                document.getElementById('paymentMethod').value = 'tunai';
            },

            addProduct() {
                const container = document.getElementById('productsContainer');
                const newRow = document.createElement('div');
                newRow.className = 'product-row';
                newRow.innerHTML = `
                    <div>
                        <label class="form-label text-sm">Nama Produk</label>
                        <input type="text" class="form-input product-name" placeholder="Nama produk">
                    </div>
                    <div>
                        <label class="form-label text-sm">Qty</label>
                        <input type="number" class="form-input product-qty" placeholder="Qty" value="1" min="1">
                    </div>
                    <div>
                        <label class="form-label text-sm">Harga</label>
                        <input type="number" class="form-input product-price" placeholder="Harga" value="0">
                    </div>
                    <div>
                        <button onclick="app.removeProduct(this)" class="btn btn-danger btn-sm mt-6">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                container.appendChild(newRow);
                this.calculateInvoiceTotal();
            },

            removeProduct(button) {
                const row = button.closest('.product-row');
                if (document.querySelectorAll('.product-row').length > 1) {
                    row.remove();
                    this.calculateInvoiceTotal();
                } else {
                    this.showNotification('Minimal harus ada 1 produk', 'error');
                }
            },

            // Account Management
            async addAccount() {
                const type = document.getElementById('newAccountType').value;
                const balance = parseFloat(document.getElementById('newAccountBalance').value) || 0;
                
                const accountName = type === 'tunai' ? 'Tunai' : 
                                  type === 'bca' ? 'BCA' : 'Dana';

                // Check if account already exists
                const existingAccount = this.accounts.find(acc => acc.type === type);
                if (existingAccount) {
                    this.showNotification('Rekening sudah ada', 'error');
                    return;
                }

                const accountData = {
                    name: accountName,
                    type: type,
                    balance: balance,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                try {
                    await db.collection("finance_accounts").add(accountData);
                    this.showNotification('Rekening berhasil ditambahkan', 'success');
                    document.getElementById('newAccountBalance').value = '0';
                } catch (error) {
                    console.error("Error adding account:", error);
                    this.showNotification('Error menambah rekening', 'error');
                }
            },

            async updateAccountBalance(accountId, newBalance) {
                try {
                    // Ensure balance doesn't go negative
                    const safeBalance = Math.max(0, newBalance);
                    
                    await db.collection("finance_accounts").doc(accountId).update({
                        balance: safeBalance,
                        updatedAt: new Date()
                    });
                } catch (error) {
                    console.error("Error updating account:", error);
                    throw error;
                }
            },

            async deleteAccount(accountId) {
                if (!confirm('Hapus rekening ini?')) return;
                
                try {
                    await db.collection("finance_accounts").doc(accountId).delete();
                    this.showNotification('Rekening dihapus', 'success');
                } catch (error) {
                    console.error("Error deleting account:", error);
                    this.showNotification('Error menghapus rekening', 'error');
                }
            },

            renderAccountBalances() {
                const container = document.getElementById('accountBalances');
                
                if (this.accounts.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-wallet text-xl mb-2"></i>
                            <p class="text-sm">Belum ada rekening</p>
                            <button onclick="app.showManageAccountsModal()" class="text-orange-600 text-xs mt-1">
                                Tambah Rekening
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.accounts.map(account => `
                    <div class="account-card account-${account.type}">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-semibold text-gray-800">${account.name}</div>
                                <div class="text-xs text-gray-500 capitalize">${account.type}</div>
                            </div>
                            <div class="font-bold text-gray-800">${this.formatCurrency(account.balance)}</div>
                        </div>
                    </div>
                `).join('');
            },

            renderAccountsList() {
                const container = document.getElementById('accountsList');
                
                if (this.accounts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">Belum ada rekening</p>';
                    return;
                }

                container.innerHTML = this.accounts.map(account => `
                    <div class="flex justify-between items-center p-3 border border-gray-200 rounded-lg mb-2">
                        <div>
                            <div class="font-medium text-gray-800">${account.name}</div>
                            <div class="text-sm text-gray-500">${this.formatCurrency(account.balance)}</div>
                        </div>
                        <button onclick="app.deleteAccount('${account.id}')" class="text-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            },

            updateAccountSelect() {
                const select = document.getElementById('transactionAccount');
                select.innerHTML = this.accounts.map(account => `
                    <option value="${account.id}">${account.name} - ${this.formatCurrency(account.balance)}</option>
                `).join('');
            },

            // Invoice Management
            renderRecentInvoices() {
                const container = document.getElementById('recentInvoices');
                const recent = this.invoices.slice(0, 3);
                
                if (recent.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-6 text-gray-500">
                            <i class="fas fa-receipt text-2xl mb-2"></i>
                            <p class="text-sm">Belum ada invoice</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = recent.map(invoice => `
                    <div class="transaction-item">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800 text-sm">${invoice.invoiceNumber}</div>
                            <div class="text-xs text-gray-500">${this.formatDate(invoice.createdAt)}</div>
                        </div>
                        <div class="font-semibold text-orange-600 text-sm">
                            ${this.formatCurrency(invoice.total || 0)}
                        </div>
                    </div>
                `).join('');
            },

            renderInvoiceList() {
                const container = document.getElementById('invoiceList');
                
                if (this.invoices.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-receipt text-3xl mb-3"></i>
                            <p>Belum ada invoice</p>
                            <p class="text-sm">Buat invoice pertama Anda</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.invoices.map(invoice => `
                    <div class="transaction-item">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800 text-sm">${invoice.invoiceNumber}</div>
                            <div class="text-xs text-gray-500">${this.formatDate(invoice.createdAt)} â€¢ ${invoice.paymentMethod}</div>
                            <div class="text-xs text-gray-500">Ongkir: ${this.formatCurrency(invoice.shippingCost || 0)}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-orange-600 text-sm">${this.formatCurrency(invoice.total || 0)}</div>
                            <div class="action-buttons">
                                <button onclick="app.editInvoice('${invoice.id}')" class="btn btn-sm btn-secondary">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="app.deleteInvoice('${invoice.id}')" class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button onclick="app.shareInvoice('${invoice.id}')" class="btn btn-sm btn-success">
                                    <i class="fas fa-share"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            // Generate Invoice
            async generateInvoice() {
                // Get products data
                const productRows = document.querySelectorAll('.product-row');
                const products = [];
                let subtotal = 0;

                productRows.forEach(row => {
                    const name = row.querySelector('.product-name').value.trim();
                    const quantity = parseInt(row.querySelector('.product-qty').value) || 1;
                    const price = parseFloat(row.querySelector('.product-price').value) || 0;
                    
                    if (name && price > 0) {
                        const productTotal = quantity * price;
                        products.push({
                            name: name,
                            quantity: quantity,
                            price: price,
                            total: productTotal
                        });
                        subtotal += productTotal;
                    }
                });

                if (products.length === 0) {
                    this.showNotification('Tambahkan minimal 1 produk', 'error');
                    return;
                }

                const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
                const paymentMethod = document.getElementById('paymentMethod').value;
                const total = subtotal + shippingCost;

                // Generate invoice number
                const invoiceCount = await this.getInvoiceCount();
                const invoiceNumber = `VLC-${(invoiceCount + 1).toString().padStart(4, '0')}`;

                const invoiceData = {
                    invoiceNumber: invoiceNumber,
                    products: products,
                    shippingCost: shippingCost,
                    subtotal: subtotal,
                    total: total,
                    paymentMethod: paymentMethod,
                    date: new Date().toLocaleDateString('id-ID'),
                    time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                    createdAt: new Date(),
                    status: 'completed'
                };

                try {
                    // Save invoice
                    await db.collection("invoices").add(invoiceData);
                    
                    // Update account balance based on payment method
                    const account = this.accounts.find(acc => acc.type === paymentMethod);
                    if (account) {
                        const newBalance = account.balance + total;
                        await this.updateAccountBalance(account.id, newBalance);
                    }
                    
                    this.showNotification('Invoice berhasil dibuat!', 'success');
                    this.closeModal();
                } catch (error) {
                    console.error("Error creating invoice:", error);
                    this.showNotification('Error membuat invoice', 'error');
                }
            },

            async getInvoiceCount() {
                try {
                    const snapshot = await db.collection("invoices").get();
                    return snapshot.size;
                } catch (error) {
                    console.error("Error getting invoice count:", error);
                    return 0;
                }
            },

            async editInvoice(invoiceId) {
                const invoice = this.invoices.find(inv => inv.id === invoiceId);
                if (!invoice) return;

                this.currentEditingInvoice = invoice;
                
                document.getElementById('editInvoiceModal').classList.remove('hidden');
                
                const form = document.getElementById('editInvoiceForm');
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Nomor Invoice</label>
                        <input type="text" id="editInvoiceNumber" class="form-input" value="${invoice.invoiceNumber}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ongkos Kirim</label>
                        <input type="number" id="editShippingCost" class="form-input" value="${invoice.shippingCost || 0}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Metode Pembayaran</label>
                        <select id="editPaymentMethod" class="form-select">
                            <option value="tunai" ${invoice.paymentMethod === 'tunai' ? 'selected' : ''}>Tunai</option>
                            <option value="bca" ${invoice.paymentMethod === 'bca' ? 'selected' : ''}>BCA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Produk</label>
                        <div id="editProductsList">
                            ${invoice.products ? invoice.products.map((product, index) => `
                                <div class="flex gap-2 mb-2">
                                    <input type="text" value="${product.name}" placeholder="Nama produk" class="form-input flex-1">
                                    <input type="number" value="${product.quantity}" placeholder="Qty" class="form-input w-20">
                                    <input type="number" value="${product.price}" placeholder="Harga" class="form-input w-24">
                                    <button onclick="this.parentElement.remove()" class="text-red-600">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `).join('') : ''}
                        </div>
                        <button onclick="app.addEditProductField()" class="btn btn-secondary btn-sm mt-2">
                            <i class="fas fa-plus mr-1"></i>Tambah Produk
                        </button>
                    </div>
                `;
            },

            addEditProductField() {
                const container = document.getElementById('editProductsList');
                container.innerHTML += `
                    <div class="flex gap-2 mb-2">
                        <input type="text" placeholder="Nama produk" class="form-input flex-1">
                        <input type="number" placeholder="Qty" class="form-input w-20" value="1">
                        <input type="number" placeholder="Harga" class="form-input w-24" value="0">
                        <button onclick="this.parentElement.remove()" class="text-red-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            },

            async updateInvoice() {
                if (!this.currentEditingInvoice) return;

                const invoiceNumber = document.getElementById('editInvoiceNumber').value;
                const shippingCost = parseFloat(document.getElementById('editShippingCost').value) || 0;
                const paymentMethod = document.getElementById('editPaymentMethod').value;
                
                // Get products from form
                const productInputs = document.querySelectorAll('#editProductsList > div');
                const products = [];
                let subtotal = 0;

                productInputs.forEach(div => {
                    const inputs = div.querySelectorAll('input');
                    const name = inputs[0].value;
                    const quantity = parseInt(inputs[1].value) || 1;
                    const price = parseFloat(inputs[2].value) || 0;
                    
                    if (name && price > 0) {
                        products.push({
                            name: name,
                            quantity: quantity,
                            price: price,
                            total: quantity * price
                        });
                        subtotal += quantity * price;
                    }
                });

                const total = subtotal + shippingCost;

                const updateData = {
                    invoiceNumber: invoiceNumber,
                    products: products,
                    shippingCost: shippingCost,
                    subtotal: subtotal,
                    total: total,
                    paymentMethod: paymentMethod,
                    updatedAt: new Date()
                };

                try {
                    await db.collection("invoices").doc(this.currentEditingInvoice.id).update(updateData);
                    this.showNotification('Invoice berhasil diupdate', 'success');
                    this.closeModal();
                } catch (error) {
                    console.error("Error updating invoice:", error);
                    this.showNotification('Error mengupdate invoice', 'error');
                }
            },

            async deleteInvoice(invoiceId) {
                if (!confirm('Hapus invoice ini?')) return;
                
                try {
                    // Get invoice data first to update account balance
                    const invoice = this.invoices.find(inv => inv.id === invoiceId);
                    if (invoice) {
                        // Find the corresponding account
                        const account = this.accounts.find(acc => 
                            acc.type === invoice.paymentMethod
                        );
                        
                        if (account) {
                            // Subtract the invoice total from account balance
                            const newBalance = Math.max(0, account.balance - invoice.total);
                            await this.updateAccountBalance(account.id, newBalance);
                        }
                    }
                    
                    await db.collection("invoices").doc(invoiceId).delete();
                    this.showNotification('Invoice dihapus', 'success');
                } catch (error) {
                    console.error("Error deleting invoice:", error);
                    this.showNotification('Error menghapus invoice', 'error');
                }
            },

            async shareInvoice(invoiceId) {
                const invoice = this.invoices.find(inv => inv.id === invoiceId);
                if (!invoice) return;

                let shareText = '';
                
                if (invoice.paymentMethod === 'bca') {
                    shareText = `âœ… Pesanan anda telah selesai dan akan segera menuju alamat anda

Untuk pembayaran Transfer silahkan ke nomor rekening dibawah

BCA 
6455106421
a/n VICKY SATRIA LINDY
Nominal : ${this.formatCurrency(invoice.total)}

Terima kasih telah mempercayai VLCrave Express!`;
                } else {
                    shareText = `âœ… Pesanan anda telah selesai dan akan segera menuju alamat anda

Silahkan bayar sesuai nominal dibawah secara Tunai/Cash
Nominal : ${this.formatCurrency(invoice.total)}

Terima kasih telah mempercayai VLCrave Express!`;
                }

                // Check if Web Share API is available
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: `Invoice ${invoice.invoiceNumber} - VLCrave Express`,
                            text: shareText
                        });
                    } catch (error) {
                        // Fallback: copy to clipboard
                        await this.copyToClipboard(shareText);
                        this.showNotification('Pesan disalin ke clipboard', 'success');
                    }
                } else {
                    // Fallback: copy to clipboard
                    await this.copyToClipboard(shareText);
                    this.showNotification('Pesan disalin ke clipboard', 'success');
                }
            },

            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (err) {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        return true;
                    } catch (err) {
                        document.body.removeChild(textArea);
                        return false;
                    }
                }
            },

            // Transaction Management
            renderRecentTransactions() {
                const container = document.getElementById('recentTransactions');
                const recent = this.transactions.slice(0, 5);
                
                if (recent.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-6 text-gray-500">
                            <i class="fas fa-exchange-alt text-2xl mb-2"></i>
                            <p class="text-sm">Belum ada transaksi</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = recent.map(transaction => `
                    <div class="transaction-item">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800 text-sm text-truncate">${transaction.description}</div>
                            <div class="text-xs text-gray-500">${this.formatDate(transaction.createdAt)} â€¢ ${transaction.category}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'} text-sm">
                                ${transaction.type === 'income' ? '+' : '-'} ${this.formatCurrency(transaction.amount)}
                            </div>
                            <div class="action-buttons">
                                <button onclick="app.editTransaction('${transaction.id}')" class="btn btn-sm btn-secondary">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="app.deleteTransaction('${transaction.id}')" class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            async saveTransaction() {
                const type = document.getElementById('transactionType').value;
                const category = document.getElementById('transactionCategory').value;
                const accountId = document.getElementById('transactionAccount').value;
                const amount = parseFloat(document.getElementById('transactionAmount').value) || 0;
                const description = document.getElementById('transactionDescription').value.trim();

                if (!description || amount <= 0 || !accountId) {
                    this.showNotification('Isi semua field dengan benar', 'error');
                    return;
                }

                const account = this.accounts.find(acc => acc.id === accountId);
                if (!account) {
                    this.showNotification('Rekening tidak ditemukan', 'error');
                    return;
                }

                // Check if balance will go negative for expense
                if (type === 'expense' && account.balance < amount) {
                    this.showNotification('Saldo tidak mencukupi', 'error');
                    return;
                }

                const transactionData = {
                    type,
                    category,
                    accountId,
                    accountName: account.name,
                    amount,
                    description,
                    createdAt: new Date(),
                    date: new Date()
                };

                try {
                    // Save transaction
                    await db.collection("finance_transactions").add(transactionData);
                    
                    // Update account balance
                    const newBalance = type === 'income' ? 
                        account.balance + amount : 
                        account.balance - amount;
                    
                    await this.updateAccountBalance(accountId, newBalance);
                    
                    this.showNotification('Transaksi berhasil disimpan!', 'success');
                    this.closeModal();
                } catch (error) {
                    console.error("Error saving transaction:", error);
                    this.showNotification('Error menyimpan transaksi', 'error');
                }
            },

            async deleteTransaction(transactionId) {
                if (!confirm('Hapus transaksi ini?')) return;
                
                try {
                    // Get transaction data first to update account balance
                    const transaction = this.transactions.find(t => t.id === transactionId);
                    if (transaction) {
                        const account = this.accounts.find(acc => acc.id === transaction.accountId);
                        if (account) {
                            // Reverse the transaction effect
                            const newBalance = transaction.type === 'income' ? 
                                Math.max(0, account.balance - transaction.amount) :
                                account.balance + transaction.amount;
                            
                            await this.updateAccountBalance(account.id, newBalance);
                        }
                    }
                    
                    await db.collection("finance_transactions").doc(transactionId).delete();
                    this.showNotification('Transaksi dihapus', 'success');
                } catch (error) {
                    console.error("Error deleting transaction:", error);
                    this.showNotification('Error menghapus transaksi', 'error');
                }
            },

            // Expense Analysis
            async analyzeExpenses() {
                const expenseTransactions = this.transactions.filter(t => t.type === 'expense');
                
                if (expenseTransactions.length === 0) {
                    this.showNotification('Belum ada data pengeluaran', 'info');
                    return;
                }

                // Show loading
                document.getElementById('aiInsights').innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-spinner fa-spin text-blue-600"></i>
                        <span class="text-blue-700 text-xs">AI sedang menganalisis pengeluaran...</span>
                    </div>
                `;

                setTimeout(() => {
                    this.generateExpenseAnalysis(expenseTransactions);
                }, 2000);
            },

            generateExpenseAnalysis(expenses) {
                const categoryTotals = {};
                let totalExpenses = 0;

                expenses.forEach(expense => {
                    const category = expense.category || 'lainnya';
                    categoryTotals[category] = (categoryTotals[category] || 0) + expense.amount;
                    totalExpenses += expense.amount;
                });

                const categories = Object.keys(categoryTotals).map(category => ({
                    category,
                    name: this.expenseCategories[category]?.name || 'Lainnya',
                    amount: categoryTotals[category],
                    percentage: (categoryTotals[category] / totalExpenses) * 100,
                    color: this.expenseCategories[category]?.color || '#64748b'
                })).sort((a, b) => b.amount - a.amount);

                this.generateBubbleChart(categories);
                this.generateCategoryDetails(categories);
                this.generateAIInsights(categories, totalExpenses);
            },

            generateBubbleChart(categories) {
                const container = document.getElementById('bubbleChart');
                container.innerHTML = '';

                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                const maxBubbleSize = 80;
                const minBubbleSize = 40;

                const maxAmount = Math.max(...categories.map(c => c.amount));

                categories.forEach((category, index) => {
                    const size = minBubbleSize + ((category.amount / maxAmount) * (maxBubbleSize - minBubbleSize));
                    const angle = (index / categories.length) * 2 * Math.PI;
                    const radius = Math.min(containerWidth, containerHeight) * 0.3;
                    const x = (containerWidth / 2) + Math.cos(angle) * radius - size / 2;
                    const y = (containerHeight / 2) + Math.sin(angle) * radius - size / 2;

                    const bubble = document.createElement('div');
                    bubble.className = 'bubble';
                    bubble.style.width = `${size}px`;
                    bubble.style.height = `${size}px`;
                    bubble.style.left = `${x}px`;
                    bubble.style.top = `${y}px`;
                    bubble.style.backgroundColor = category.color;
                    bubble.style.fontSize = `${Math.max(10, size / 8)}px`;

                    bubble.innerHTML = `
                        <div class="text-center">
                            <div class="font-bold">${category.name.split(' ')[0]}</div>
                            <div class="text-xs opacity-90">${category.percentage.toFixed(0)}%</div>
                        </div>
                    `;

                    container.appendChild(bubble);
                });
            },

            generateCategoryDetails(categories) {
                const container = document.getElementById('categoryDetails');
                container.innerHTML = '';

                categories.forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'transaction-item';
                    item.innerHTML = `
                        <div class="flex items-center flex-1">
                            <div class="w-3 h-3 rounded mr-2" style="background-color: ${category.color}"></div>
                            <div>
                                <div class="font-medium text-gray-800 text-sm">${category.name}</div>
                                <div class="text-xs text-gray-500">${category.percentage.toFixed(1)}%</div>
                            </div>
                        </div>
                        <div class="font-semibold text-gray-800 text-sm">${this.formatCurrency(category.amount)}</div>
                    `;
                    container.appendChild(item);
                });
            },

            generateAIInsights(categories, totalExpenses) {
                const largest = categories[0];
                const second = categories[1];
                let insights = `Pengeluaran terbesar: <strong>${largest.name}</strong> (${largest.percentage.toFixed(1)}% - ${this.formatCurrency(largest.amount)})`;
                
                if (largest.percentage > 50) {
                    insights += `. Fokus utama pada ${largest.name.toLowerCase()}.`;
                } else if (second) {
                    insights += `, diikuti oleh <strong>${second.name}</strong> (${second.percentage.toFixed(1)}%).`;
                }

                insights += ` Total pengeluaran: <strong>${this.formatCurrency(totalExpenses)}</strong>.`;

                document.getElementById('aiInsights').innerHTML = `
                    <div class="flex items-start gap-2">
                        <i class="fas fa-robot text-blue-500 text-lg mt-0.5"></i>
                        <div>
                            <h5 class="font-bold text-blue-800 mb-1 text-sm">AI Insights</h5>
                            <p class="text-blue-700 text-xs">${insights}</p>
                        </div>
                    </div>
                `;
            },

            // Dashboard Updates - FIXED VERSION (Only shipping as income)
            updateDashboard() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                // Calculate income from SHIPPING COSTS only (today) - FIXED
                const todayIncome = this.invoices
                    .filter(invoice => {
                        const invoiceDate = new Date(invoice.createdAt?.toDate?.() || invoice.createdAt);
                        return invoiceDate >= today;
                    })
                    .reduce((sum, invoice) => sum + (invoice.shippingCost || 0), 0);

                // Calculate monthly income from SHIPPING COSTS only - FIXED
                const monthlyIncome = this.invoices
                    .filter(invoice => {
                        const invoiceDate = new Date(invoice.createdAt?.toDate?.() || invoice.createdAt);
                        return invoiceDate.getMonth() === currentMonth && invoiceDate.getFullYear() === currentYear;
                    })
                    .reduce((sum, invoice) => sum + (invoice.shippingCost || 0), 0);

                // Update delivery count (today's invoices)
                const todayInvoices = this.invoices.filter(invoice => {
                    const invoiceDate = new Date(invoice.createdAt?.toDate?.() || invoice.createdAt);
                    return invoiceDate >= today;
                });
                
                // Calculate total balance from accounts
                const totalBalance = this.accounts.reduce((sum, account) => sum + account.balance, 0);

                // Update invoice count (this month)
                const monthInvoices = this.invoices.filter(invoice => {
                    const invoiceDate = new Date(invoice.createdAt?.toDate?.() || invoice.createdAt);
                    return invoiceDate.getMonth() === currentMonth && invoiceDate.getFullYear() === currentYear;
                });

                // Update UI
                document.getElementById('incomeToday').textContent = this.formatCurrency(todayIncome);
                document.getElementById('deliveryToday').textContent = todayInvoices.length;
                document.getElementById('totalBalance').textContent = this.formatCurrency(totalBalance > 0 ? totalBalance : 0);
                document.getElementById('invoiceCount').textContent = monthInvoices.length;

                // Update finance section (monthly) - FIXED (only shipping as income)
                const monthlyExpense = this.transactions
                    .filter(t => t.type === 'expense' && 
                        new Date(t.createdAt?.toDate?.() || t.createdAt).getMonth() === currentMonth &&
                        new Date(t.createdAt?.toDate?.() || t.createdAt).getFullYear() === currentYear
                    )
                    .reduce((sum, t) => sum + t.amount, 0);

                document.getElementById('financeIncome').textContent = this.formatCurrency(monthlyIncome);
                document.getElementById('financeExpense').textContent = this.formatCurrency(monthlyExpense);
            },

            // Utility Functions
            formatCurrency(amount) {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                }).format(amount);
            },

            formatDate(timestamp) {
                if (!timestamp) return '';
                try {
                    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    return date.toLocaleDateString('id-ID', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric' 
                    });
                } catch (error) {
                    return '';
                }
            },

            showNotification(message, type = 'info') {
                // Remove existing notifications
                document.querySelectorAll('.notification').forEach(notif => notif.remove());
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 100);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        };

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
