<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLCrave Express - Monitor Keuangan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#f97316',
                        'primary-dark': '#ea580c',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#3b82f6'
                    },
                    animation: {
                        'bounce-in': 'bounceIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pulse-soft': 'pulseSoft 2s infinite'
                    },
                    keyframes: {
                        bounceIn: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)', opacity: '0.8' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.7' }
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom animations and utilities */
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .text-shadow {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Fix untuk modal overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- App Container -->
    <div class="app-container min-h-screen flex flex-col max-w-md mx-auto bg-white/95 backdrop-blur-xl">
        
        <!-- Header -->
        <header class="bg-gradient-to-r from-primary to-primary-dark text-white p-4 shadow-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-chart-line text-primary text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-shadow">VLCrave Express</h1>
                        <p class="text-xs opacity-90">Monitor Keuangan Bisnis</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="app.showNotification('Data diperbarui', 'success')" 
                            class="p-2 rounded-lg bg-white/20 hover:bg-white/30 transition-colors">
                        <i class="fas fa-sync-alt text-sm"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-4 pb-24 overflow-y-auto">
            
            <!-- Beranda Tab -->
            <div id="berandaTab" class="tab-content active animate-fade-in">
                
                <!-- Stats Overview -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <!-- Pendapatan Hari Ini -->
                    <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-2xl p-4 text-center hover-lift">
                        <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-2 shadow-lg">
                            <i class="fas fa-money-bill-wave text-white text-lg"></i>
                        </div>
                        <div class="text-2xl font-bold text-gray-800 mb-1" id="incomeToday">Rp 0</div>
                        <div class="text-xs text-green-600 font-semibold">Pendapatan Hari Ini</div>
                    </div>
                    
                    <!-- Total Saldo -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-2xl p-4 text-center hover-lift">
                        <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-2 shadow-lg">
                            <i class="fas fa-wallet text-white text-lg"></i>
                        </div>
                        <div class="text-2xl font-bold text-gray-800 mb-1" id="totalBalance">Rp 0</div>
                        <div class="text-xs text-blue-600 font-semibold">Total Saldo</div>
                    </div>
                    
                    <!-- Pengantaran Hari Ini -->
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-2xl p-4 text-center hover-lift">
                        <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-2 shadow-lg">
                            <i class="fas fa-shipping-fast text-white text-lg"></i>
                        </div>
                        <div class="text-2xl font-bold text-gray-800 mb-1" id="deliveryToday">0</div>
                        <div class="text-xs text-purple-600 font-semibold">Pengantaran Hari Ini</div>
                    </div>
                    
                    <!-- Invoice Bulan Ini -->
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 rounded-2xl p-4 text-center hover-lift">
                        <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center mx-auto mb-2 shadow-lg">
                            <i class="fas fa-receipt text-white text-lg"></i>
                        </div>
                        <div class="text-2xl font-bold text-gray-800 mb-1" id="invoiceCount">0</div>
                        <div class="text-xs text-orange-600 font-semibold">Invoice Bulan Ini</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="app.showTransactionModal('income')" 
                            class="bg-gradient-to-r from-success to-green-600 text-white p-4 rounded-2xl text-center hover-lift group">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mx-auto mb-2 group-hover:scale-110 transition-transform">
                            <i class="fas fa-arrow-down text-white text-lg"></i>
                        </div>
                        <div class="font-semibold text-sm">Pendapatan</div>
                        <div class="text-xs opacity-90">Tambah pemasukan</div>
                    </button>
                    
                    <button onclick="app.showTransactionModal('expense')" 
                            class="bg-gradient-to-r from-danger to-red-600 text-white p-4 rounded-2xl text-center hover-lift group">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mx-auto mb-2 group-hover:scale-110 transition-transform">
                            <i class="fas fa-arrow-up text-white text-lg"></i>
                        </div>
                        <div class="font-semibold text-sm">Pengeluaran</div>
                        <div class="text-xs opacity-90">Catat pengeluaran</div>
                    </button>
                </div>

                <!-- Account Balances -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-gray-800 flex items-center">
                            <i class="fas fa-piggy-bank text-primary mr-2"></i>
                            Saldo Rekening
                        </h3>
                        <button onclick="app.showManageAccountsModal()" 
                                class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg transition-colors">
                            <i class="fas fa-cog mr-1"></i> Kelola
                        </button>
                    </div>
                    <div id="accountBalances" class="space-y-3">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-wallet text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm font-medium mb-2">Belum ada rekening</p>
                            <button onclick="app.showManageAccountsModal()" 
                                    class="text-primary text-xs font-bold">
                                Tambah Rekening
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div>
                    <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-history text-primary mr-2"></i>
                        Transaksi Terbaru
                    </h3>
                    <div id="recentTransactions" class="space-y-2">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-exchange-alt text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm font-medium">Belum ada transaksi</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaksi Tab -->
            <div id="transaksiTab" class="tab-content animate-fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-gray-800 flex items-center">
                        <i class="fas fa-list-alt text-primary mr-2"></i>
                        Semua Transaksi
                    </h3>
                    <div class="flex space-x-2">
                        <select id="filterType" onchange="app.filterTransactions()" 
                                class="text-xs border rounded-lg px-2 py-1">
                            <option value="all">Semua</option>
                            <option value="income">Pendapatan</option>
                            <option value="expense">Pengeluaran</option>
                        </select>
                    </div>
                </div>
                
                <div id="allTransactions" class="space-y-2">
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-receipt text-4xl mb-3 opacity-50"></i>
                        <p class="text-sm font-medium mb-1">Belum ada transaksi</p>
                        <p class="text-xs">Mulai dengan mencatat transaksi pertama Anda</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 safe-area-bottom max-w-md mx-auto">
            <div class="flex">
                <button onclick="app.showTab('beranda')" 
                        class="nav-btn flex-1 flex flex-col items-center py-3 transition-all duration-300 text-primary scale-110"
                        data-tab="beranda">
                    <div class="w-6 h-6 mb-1 transition-transform duration-300">
                        <i class="fas fa-home text-lg"></i>
                    </div>
                    <span class="text-xs font-medium">Beranda</span>
                </button>
                
                <button onclick="app.showTab('transaksi')" 
                        class="nav-btn flex-1 flex flex-col items-center py-3 transition-all duration-300 text-gray-500"
                        data-tab="transaksi">
                    <div class="w-6 h-6 mb-1 transition-transform duration-300">
                        <i class="fas fa-exchange-alt text-lg"></i>
                    </div>
                    <span class="text-xs font-medium">Transaksi</span>
                </button>
            </div>
        </nav>

        <!-- Floating Action Button -->
        <button onclick="app.showTransactionModal('income')" 
                class="fixed bottom-20 right-4 w-14 h-14 bg-gradient-to-r from-primary to-primary-dark rounded-full flex items-center justify-center text-white shadow-2xl hover-lift z-50 animate-bounce-in">
            <i class="fas fa-plus text-xl"></i>
        </button>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal-overlay hidden">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-hidden animate-slide-up">
            <div class="bg-gradient-to-r from-primary to-primary-dark p-6 text-white">
                <h2 id="modalTitle" class="text-lg font-bold text-center">Tambah Transaksi</h2>
            </div>
            
            <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-2">Jenis Transaksi</label>
                    <select id="transactionType" class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                        <option value="income">üí∞ Pendapatan</option>
                        <option value="expense">üí∏ Pengeluaran</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-2">Kategori</label>
                    <select id="transactionCategory" class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                        <option value="penjualan">üõçÔ∏è Penjualan</option>
                        <option value="servis">üîß Servis</option>
                        <option value="bahan_baku">üì¶ Bahan Baku</option>
                        <option value="operasional">‚ö° Operasional</option>
                        <option value="transportasi">üöö Transportasi</option>
                        <option value="lainnya">üìã Lainnya</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-2">Rekening</label>
                    <select id="transactionAccount" class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                        <!-- Accounts will be populated here -->
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-2">Jumlah</label>
                    <input type="number" id="transactionAmount" 
                           class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all" 
                           placeholder="0">
                </div>
                
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-2">Keterangan</label>
                    <input type="text" id="transactionDescription" 
                           class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all" 
                           placeholder="Deskripsi transaksi">
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 flex space-x-3">
                <button onclick="app.closeModal()" 
                        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-xl font-semibold text-sm transition-all active:scale-95">
                    Batal
                </button>
                <button onclick="app.saveTransaction()" 
                        class="flex-1 bg-gradient-to-r from-primary to-primary-dark hover:from-primary-dark hover:to-primary text-white py-3 rounded-xl font-semibold text-sm transition-all active:scale-95">
                    üíæ Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="modal-overlay hidden">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-hidden animate-slide-up">
            <div class="bg-gradient-to-r from-info to-blue-600 p-6 text-white">
                <h2 class="text-lg font-bold text-center">Edit Transaksi</h2>
            </div>
            
            <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                <div id="editTransactionForm">
                    <!-- Form will be populated here -->
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 flex space-x-3">
                <button onclick="app.closeModal()" 
                        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-xl font-semibold text-sm transition-all active:scale-95">
                    Batal
                </button>
                <button onclick="app.updateTransaction()" 
                        class="flex-1 bg-gradient-to-r from-info to-blue-600 hover:from-blue-600 hover:to-info text-white py-3 rounded-xl font-semibold text-sm transition-all active:scale-95">
                    ‚úèÔ∏è Update
                </button>
            </div>
        </div>
    </div>

    <!-- Manage Accounts Modal -->
    <div id="manageAccountsModal" class="modal-overlay hidden">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-hidden animate-slide-up">
            <div class="bg-gradient-to-r from-warning to-yellow-600 p-6 text-white">
                <h2 class="text-lg font-bold text-center">Kelola Rekening</h2>
            </div>
            
            <div class="p-6 space-y-6 max-h-[60vh] overflow-y-auto">
                <div class="space-y-3">
                    <h3 class="text-sm font-bold text-gray-800">Tambah Rekening Baru</h3>
                    <select id="newAccountType" class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm">
                        <option value="tunai">üíµ Tunai</option>
                        <option value="bca">üè¶ BCA</option>
                        <option value="dana">üì± Dana</option>
                    </select>
                    <input type="number" id="newAccountBalance" 
                           class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm" 
                           placeholder="Saldo awal" value="0">
                    <button onclick="app.addAccount()" 
                            class="w-full bg-gradient-to-r from-success to-green-600 text-white py-3 rounded-xl font-semibold text-sm transition-all active:scale-95">
                        <i class="fas fa-plus mr-2"></i>Tambah Rekening
                    </button>
                </div>
                
                <div class="border-t pt-4">
                    <h3 class="text-sm font-bold text-gray-800 mb-3">Rekening Saat Ini</h3>
                    <div id="accountsList" class="space-y-2">
                        <!-- Accounts will be listed here -->
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200">
                <button onclick="app.closeModal()" 
                        class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-xl font-semibold text-sm transition-all active:scale-95">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA1kevuJ9mRJ8le8uPXin11uUqJ6sOLopY",
            authDomain: "vlcrave-whatsapp-order.firebaseapp.com",
            projectId: "vlcrave-whatsapp-order",
            storageBucket: "vlcrave-whatsapp-order.firebasestorage.app",
            messagingSenderId: "796602954067",
            appId: "1:796602954067:web:e10a110ae904decdc471a6",
            measurementId: "G-XLWNDN39ZD"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Main Application
        const app = {
            currentTab: 'beranda',
            transactions: [],
            accounts: [],
            invoices: [],
            currentEditingTransaction: null,
            currentTransactionType: 'income',

            // Initialize App
            async init() {
                console.log("VLCrave Express - Monitor Keuangan Initialized");
                
                // Set up real-time listeners
                this.setupRealtimeListeners();
                
                // Initialize default accounts if not exists
                await this.initializeDefaultAccounts();
                
                // Setup navigation
                this.setupNavigation();

                // Setup modal close on overlay click
                this.setupModalClose();
            },

            // Setup navigation active states
            setupNavigation() {
                const navBtns = document.querySelectorAll('.nav-btn');
                navBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const tab = this.getAttribute('data-tab');
                        navBtns.forEach(b => {
                            b.classList.remove('text-primary', 'scale-110');
                            b.classList.add('text-gray-500');
                        });
                        this.classList.remove('text-gray-500');
                        this.classList.add('text-primary', 'scale-110');
                    });
                });
            },

            // Setup modal close when clicking overlay
            setupModalClose() {
                document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            this.closeModal();
                        }
                    });
                });
            },

            // Initialize default accounts
            async initializeDefaultAccounts() {
                try {
                    const accountsSnapshot = await db.collection("finance_accounts").get();
                    if (accountsSnapshot.empty) {
                        const defaultAccounts = [
                            { name: 'Tunai', type: 'tunai', balance: 0, createdAt: new Date(), updatedAt: new Date() },
                            { name: 'BCA', type: 'bca', balance: 0, createdAt: new Date(), updatedAt: new Date() }
                        ];
                        
                        for (const account of defaultAccounts) {
                            await db.collection("finance_accounts").add(account);
                        }
                        console.log("Default accounts created");
                    }
                } catch (error) {
                    console.error("Error initializing default accounts:", error);
                }
            },

            // Setup real-time Firestore listeners
            setupRealtimeListeners() {
                // Invoices listener for delivery tracking
                db.collection("invoices")
                    .orderBy("createdAt", "desc")
                    .onSnapshot((snapshot) => {
                        this.invoices = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            data.id = doc.id;
                            this.invoices.push(data);
                        });
                        this.updateDashboard();
                    });

                // Transactions listener
                db.collection("finance_transactions")
                    .orderBy("createdAt", "desc")
                    .limit(100)
                    .onSnapshot((snapshot) => {
                        this.transactions = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            data.id = doc.id;
                            this.transactions.push(data);
                        });
                        this.updateDashboard();
                        this.renderRecentTransactions();
                        this.renderAllTransactions();
                    });

                // Accounts listener
                db.collection("finance_accounts")
                    .onSnapshot((snapshot) => {
                        this.accounts = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            data.id = doc.id;
                            this.accounts.push(data);
                        });
                        this.updateDashboard();
                        this.renderAccountBalances();
                        this.renderAccountsList();
                        this.updateAccountSelect();
                    });
            },

            // Tab Navigation
            showTab(tabName) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab
                document.getElementById(tabName + 'Tab').classList.add('active');
                
                // Update navigation buttons
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if (btn.getAttribute('data-tab') === tabName) {
                        btn.classList.remove('text-gray-500');
                        btn.classList.add('text-primary', 'scale-110');
                    } else {
                        btn.classList.remove('text-primary', 'scale-110');
                        btn.classList.add('text-gray-500');
                    }
                });
                
                this.currentTab = tabName;
            },

            // Modal Management - PERBAIKAN DI SINI
            showTransactionModal(type) {
                this.currentTransactionType = type;
                document.getElementById('transactionType').value = type;
                document.getElementById('modalTitle').textContent = 
                    type === 'income' ? 'üí∞ Tambah Pendapatan' : 'üí∏ Tambah Pengeluaran';
                document.getElementById('transactionModal').classList.remove('hidden');
                
                // Reset form
                document.getElementById('transactionAmount').value = '';
                document.getElementById('transactionDescription').value = '';
            },

            showManageAccountsModal() {
                document.getElementById('manageAccountsModal').classList.remove('hidden');
            },

            closeModal() {
                // PERBAIKAN: Tutup semua modal dengan class modal-overlay
                const modals = document.querySelectorAll('.modal-overlay');
                console.log('Menutup modal, ditemukan:', modals.length, 'modal');
                
                modals.forEach(modal => {
                    modal.classList.add('hidden');
                    console.log('Modal ditutup:', modal.id);
                });
                
                this.currentEditingTransaction = null;
            },

            // Account Management
            async addAccount() {
                const type = document.getElementById('newAccountType').value;
                const balance = parseFloat(document.getElementById('newAccountBalance').value) || 0;
                
                const accountName = type === 'tunai' ? 'Tunai' : 
                                  type === 'bca' ? 'BCA' : 'Dana';

                // Check if account already exists
                const existingAccount = this.accounts.find(acc => acc.type === type);
                if (existingAccount) {
                    this.showNotification('Rekening sudah ada', 'error');
                    return;
                }

                const accountData = {
                    name: accountName,
                    type: type,
                    balance: balance,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                try {
                    await db.collection("finance_accounts").add(accountData);
                    this.showNotification('‚úÖ Rekening berhasil ditambahkan', 'success');
                    document.getElementById('newAccountBalance').value = '0';
                } catch (error) {
                    console.error("Error adding account:", error);
                    this.showNotification('‚ùå Error menambah rekening', 'error');
                }
            },

            async deleteAccount(accountId) {
                if (!confirm('Hapus rekening ini?')) return;
                
                try {
                    await db.collection("finance_accounts").doc(accountId).delete();
                    this.showNotification('üóëÔ∏è Rekening dihapus', 'success');
                } catch (error) {
                    console.error("Error deleting account:", error);
                    this.showNotification('‚ùå Error menghapus rekening', 'error');
                }
            },

            renderAccountBalances() {
                const container = document.getElementById('accountBalances');
                
                if (this.accounts.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-wallet text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm font-medium mb-2">Belum ada rekening</p>
                            <button onclick="app.showManageAccountsModal()" 
                                    class="text-primary text-xs font-bold">
                                Tambah Rekening
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.accounts.map(account => `
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 border border-gray-200 rounded-2xl p-4 hover-lift">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center ${
                                    account.type === 'tunai' ? 'bg-orange-500' : 
                                    account.type === 'bca' ? 'bg-blue-500' : 'bg-green-500'
                                }">
                                    <i class="fas fa-${
                                        account.type === 'tunai' ? 'money-bill-wave' : 
                                        account.type === 'bca' ? 'university' : 'mobile-alt'
                                    } text-white text-sm"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800 text-sm">${account.name}</div>
                                    <div class="text-xs text-gray-500 capitalize">${account.type}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-gray-800 text-lg">${this.formatCurrency(account.balance)}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            renderAccountsList() {
                const container = document.getElementById('accountsList');
                
                if (this.accounts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm text-center">Belum ada rekening</p>';
                    return;
                }

                container.innerHTML = this.accounts.map(account => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg ${
                                account.type === 'tunai' ? 'bg-orange-500' : 
                                account.type === 'bca' ? 'bg-blue-500' : 'bg-green-500'
                            } flex items-center justify-center">
                                <i class="fas fa-${
                                    account.type === 'tunai' ? 'money-bill-wave' : 
                                    account.type === 'bca' ? 'university' : 'mobile-alt'
                                } text-white text-xs"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800 text-sm">${account.name}</div>
                                <div class="text-xs text-gray-500">${this.formatCurrency(account.balance)}</div>
                            </div>
                        </div>
                        <button onclick="app.deleteAccount('${account.id}')" 
                                class="text-danger hover:text-red-700 transition-colors">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                `).join('');
            },

            updateAccountSelect() {
                const select = document.getElementById('transactionAccount');
                select.innerHTML = this.accounts.map(account => `
                    <option value="${account.id}">${account.name} - ${this.formatCurrency(account.balance)}</option>
                `).join('');
            },

            // Transaction Management - CRUD Operations
            async saveTransaction() {
                const type = document.getElementById('transactionType').value;
                const category = document.getElementById('transactionCategory').value;
                const accountId = document.getElementById('transactionAccount').value;
                const amount = parseFloat(document.getElementById('transactionAmount').value) || 0;
                const description = document.getElementById('transactionDescription').value.trim();

                if (!description || amount <= 0 || !accountId) {
                    this.showNotification('‚ùå Isi semua field dengan benar', 'error');
                    return;
                }

                const account = this.accounts.find(acc => acc.id === accountId);
                if (!account) {
                    this.showNotification('‚ùå Rekening tidak ditemukan', 'error');
                    return;
                }

                // Check if balance will go negative for expense
                if (type === 'expense' && account.balance < amount) {
                    this.showNotification('‚ùå Saldo tidak mencukupi', 'error');
                    return;
                }

                const transactionData = {
                    type,
                    category,
                    accountId,
                    accountName: account.name,
                    amount,
                    description,
                    createdAt: new Date(),
                    date: new Date()
                };

                try {
                    await db.collection("finance_transactions").add(transactionData);
                    
                    // Update account balance
                    const newBalance = type === 'income' ? 
                        account.balance + amount : 
                        account.balance - amount;
                    
                    await this.updateAccountBalanceDirect(accountId, newBalance);
                    
                    this.showNotification('‚úÖ Transaksi berhasil disimpan!', 'success');
                    this.closeModal();
                } catch (error) {
                    console.error("Error saving transaction:", error);
                    this.showNotification('‚ùå Error menyimpan transaksi', 'error');
                }
            },

            async updateAccountBalanceDirect(accountId, newBalance) {
                try {
                    await db.collection("finance_accounts").doc(accountId).update({
                        balance: newBalance,
                        updatedAt: new Date()
                    });
                } catch (error) {
                    console.error("Error updating account:", error);
                    throw error;
                }
            },

            // Edit Transaction
            editTransaction(transactionId) {
                const transaction = this.transactions.find(t => t.id === transactionId);
                if (!transaction) return;

                this.currentEditingTransaction = transaction;
                
                document.getElementById('editTransactionModal').classList.remove('hidden');
                
                const form = document.getElementById('editTransactionForm');
                form.innerHTML = `
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-2">Jenis Transaksi</label>
                        <select id="editTransactionType" class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm">
                            <option value="income" ${transaction.type === 'income' ? 'selected' : ''}>üí∞ Pendapatan</option>
                            <option value="expense" ${transaction.type === 'expense' ? 'selected' : ''}>üí∏ Pengeluaran</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-2">Kategori</label>
                        <select id="editTransactionCategory" class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm">
                            <option value="penjualan" ${transaction.category === 'penjualan' ? 'selected' : ''}>üõçÔ∏è Penjualan</option>
                            <option value="servis" ${transaction.category === 'servis' ? 'selected' : ''}>üîß Servis</option>
                            <option value="bahan_baku" ${transaction.category === 'bahan_baku' ? 'selected' : ''}>üì¶ Bahan Baku</option>
                            <option value="operasional" ${transaction.category === 'operasional' ? 'selected' : ''}>‚ö° Operasional</option>
                            <option value="transportasi" ${transaction.category === 'transportasi' ? 'selected' : ''}>üöö Transportasi</option>
                            <option value="lainnya" ${transaction.category === 'lainnya' ? 'selected' : ''}>üìã Lainnya</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-2">Jumlah</label>
                        <input type="number" id="editTransactionAmount" 
                               class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm" 
                               value="${transaction.amount}">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-2">Keterangan</label>
                        <input type="text" id="editTransactionDescription" 
                               class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm" 
                               value="${transaction.description}">
                    </div>
                `;
            },

            async updateTransaction() {
                if (!this.currentEditingTransaction) return;

                const type = document.getElementById('editTransactionType').value;
                const category = document.getElementById('editTransactionCategory').value;
                const amount = parseFloat(document.getElementById('editTransactionAmount').value) || 0;
                const description = document.getElementById('editTransactionDescription').value.trim();

                if (!description || amount <= 0) {
                    this.showNotification('‚ùå Isi semua field dengan benar', 'error');
                    return;
                }

                const updateData = {
                    type,
                    category,
                    amount,
                    description,
                    updatedAt: new Date()
                };

                try {
                    await db.collection("finance_transactions").doc(this.currentEditingTransaction.id).update(updateData);
                    this.showNotification('‚úÖ Transaksi berhasil diupdate', 'success');
                    this.closeModal();
                } catch (error) {
                    console.error("Error updating transaction:", error);
                    this.showNotification('‚ùå Error mengupdate transaksi', 'error');
                }
            },

            // Delete Transaction
            async deleteTransaction(transactionId) {
                if (!confirm('Hapus transaksi ini?')) return;
                
                try {
                    const transaction = this.transactions.find(t => t.id === transactionId);
                    if (transaction) {
                        const account = this.accounts.find(acc => acc.id === transaction.accountId);
                        if (account) {
                            // Reverse the transaction effect
                            const newBalance = transaction.type === 'income' ? 
                                Math.max(0, account.balance - transaction.amount) :
                                account.balance + transaction.amount;
                            
                            await this.updateAccountBalanceDirect(account.id, newBalance);
                        }
                    }
                    
                    await db.collection("finance_transactions").doc(transactionId).delete();
                    this.showNotification('üóëÔ∏è Transaksi dihapus', 'success');
                } catch (error) {
                    console.error("Error deleting transaction:", error);
                    this.showNotification('‚ùå Error menghapus transaksi', 'error');
                }
            },

            renderRecentTransactions() {
                const container = document.getElementById('recentTransactions');
                const recent = this.transactions.slice(0, 5);
                
                if (recent.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-exchange-alt text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm font-medium">Belum ada transaksi</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = recent.map(transaction => `
                    <div class="bg-white border border-gray-200 rounded-2xl p-4 hover-lift">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3 flex-1">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center ${
                                    transaction.type === 'income' ? 'bg-green-500' : 'bg-red-500'
                                }">
                                    <i class="fas fa-${transaction.type === 'income' ? 'arrow-down' : 'arrow-up'} text-white text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-gray-800 text-sm truncate">${transaction.description}</div>
                                    <div class="text-xs text-gray-500 flex items-center space-x-2 mt-1">
                                        <span>${this.formatDate(transaction.createdAt)}</span>
                                        <span>‚Ä¢</span>
                                        <span>${transaction.accountName}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-sm ${
                                    transaction.type === 'income' ? 'text-green-600' : 'text-red-600'
                                }">
                                    ${transaction.type === 'income' ? '+' : '-'} ${this.formatCurrency(transaction.amount)}
                                </div>
                                <div class="flex space-x-1 mt-2">
                                    <button onclick="app.editTransaction('${transaction.id}')" 
                                            class="text-info hover:text-blue-700 transition-colors">
                                        <i class="fas fa-edit text-xs"></i>
                                    </button>
                                    <button onclick="app.deleteTransaction('${transaction.id}')" 
                                            class="text-danger hover:text-red-700 transition-colors">
                                        <i class="fas fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            renderAllTransactions() {
                const container = document.getElementById('allTransactions');
                const filterType = document.getElementById('filterType').value;
                
                let filteredTransactions = this.transactions;
                if (filterType !== 'all') {
                    filteredTransactions = this.transactions.filter(t => t.type === filterType);
                }
                
                if (filteredTransactions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-receipt text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm font-medium mb-1">Belum ada transaksi</p>
                            <p class="text-xs">Mulai dengan mencatat transaksi pertama Anda</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filteredTransactions.map(transaction => `
                    <div class="bg-white border border-gray-200 rounded-2xl p-4 hover-lift animate-fade-in">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3 flex-1">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center ${
                                    transaction.type === 'income' ? 'bg-green-500' : 'bg-red-500'
                                }">
                                    <i class="fas fa-${transaction.type === 'income' ? 'arrow-down' : 'arrow-up'} text-white text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-gray-800 text-sm truncate">${transaction.description}</div>
                                    <div class="text-xs text-gray-500 flex items-center space-x-2 mt-1">
                                        <span>${this.formatDate(transaction.createdAt)}</span>
                                        <span>‚Ä¢</span>
                                        <span>${transaction.accountName}</span>
                                        <span>‚Ä¢</span>
                                        <span class="capitalize">${transaction.category}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-sm ${
                                    transaction.type === 'income' ? 'text-green-600' : 'text-red-600'
                                }">
                                    ${transaction.type === 'income' ? '+' : '-'} ${this.formatCurrency(transaction.amount)}
                                </div>
                                <div class="flex space-x-1 mt-2">
                                    <button onclick="app.editTransaction('${transaction.id}')" 
                                            class="text-info hover:text-blue-700 transition-colors">
                                        <i class="fas fa-edit text-xs"></i>
                                    </button>
                                    <button onclick="app.deleteTransaction('${transaction.id}')" 
                                            class="text-danger hover:text-red-700 transition-colors">
                                        <i class="fas fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            filterTransactions() {
                this.renderAllTransactions();
            },

            // Dashboard Updates with Invoice Data
            updateDashboard() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                // Calculate income from invoices shipping costs (today)
                const todayIncomeFromInvoices = this.invoices
                    .filter(invoice => {
                        const invoiceDate = new Date(invoice.createdAt?.toDate?.() || invoice.createdAt);
                        return invoiceDate >= today;
                    })
                    .reduce((sum, invoice) => sum + (invoice.shippingCost || 0), 0);

                // Calculate income from transactions (today)
                const todayIncomeFromTransactions = this.transactions
                    .filter(transaction => {
                        const transactionDate = new Date(transaction.createdAt?.toDate?.() || transaction.createdAt);
                        return transactionDate >= today && transaction.type === 'income';
                    })
                    .reduce((sum, transaction) => sum + transaction.amount, 0);

                const totalTodayIncome = todayIncomeFromInvoices + todayIncomeFromTransactions;

                // Calculate total balance from accounts
                const totalBalance = this.accounts.reduce((sum, account) => sum + account.balance, 0);

                // Count today's deliveries (invoices)
                const todayDeliveries = this.invoices.filter(invoice => {
                    const invoiceDate = new Date(invoice.createdAt?.toDate?.() || invoice.createdAt);
                    return invoiceDate >= today;
                }).length;

                // Count this month's invoices
                const monthInvoices = this.invoices.filter(invoice => {
                    const invoiceDate = new Date(invoice.createdAt?.toDate?.() || invoice.createdAt);
                    return invoiceDate.getMonth() === currentMonth && invoiceDate.getFullYear() === currentYear;
                }).length;

                // Update UI
                document.getElementById('incomeToday').textContent = this.formatCurrency(totalTodayIncome);
                document.getElementById('totalBalance').textContent = this.formatCurrency(totalBalance);
                document.getElementById('deliveryToday').textContent = todayDeliveries;
                document.getElementById('invoiceCount').textContent = monthInvoices;
            },

            // Utility Functions
            formatCurrency(amount) {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                }).format(amount);
            },

            formatDate(timestamp) {
                if (!timestamp) return '';
                try {
                    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    return date.toLocaleDateString('id-ID', { 
                        day: '2-digit', 
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (error) {
                    return '';
                }
            },

            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 
                              type === 'error' ? 'bg-red-500' : 'bg-blue-500';
                
                notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 -translate-y-20 ${bgColor} text-white px-6 py-3 rounded-2xl font-semibold text-sm shadow-2xl z-50 transition-all duration-500`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.classList.remove('-translate-y-20');
                    notification.classList.add('translate-y-0');
                }, 100);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.classList.remove('translate-y-0');
                    notification.classList.add('-translate-y-20');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 500);
                }, 3000);
            }
        };

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
