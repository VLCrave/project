<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLCrave Express - All in One</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            500: '#f97316',
                            600: '#ea580c',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px) scale(0.95)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom minimal styles */
        .text-gradient {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .bubble {
            transition: all 0.3s ease;
        }
        
        .bubble:hover {
            transform: scale(1.1);
        }
        
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .modal-overlay {
            display: none;
        }
        
        .modal-overlay:not(.hidden) {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased">
    <!-- Main Container -->
    <div class="min-h-screen flex flex-col">
        <!-- Main Content -->
        <main class="flex-1 pb-20 safe-area-bottom">
            <div class="container mx-auto px-4 py-6 max-w-md">
                
                <!-- Header -->
                <header class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-white rounded-2xl shadow-sm mb-4 border border-orange-200">
                        <img src="https://vlcrave.github.io/project/img/icon.png" alt="VLCrave Express" class="w-10 h-10">
                    </div>
                    <h1 class="text-3xl font-black text-gray-800 mb-2 text-gradient">VLCrave Express</h1>
                    <p class="text-gray-600 text-sm font-medium">All-in-One Business Solution</p>
                </header>

                <!-- Dashboard Tab -->
                <div id="dashboardTab" class="tab-content active animate-fade-in">
                    <!-- Quick Stats -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                            <div class="text-2xl font-bold text-gray-800 mb-1" id="incomeToday">Rp 0</div>
                            <div class="text-xs text-gray-500">Pendapatan Hari Ini</div>
                            <i class="fas fa-money-bill-wave absolute top-4 right-4 text-orange-500 text-xl"></i>
                        </div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                            <div class="text-2xl font-bold text-gray-800 mb-1" id="deliveryToday">0</div>
                            <div class="text-xs text-gray-500">Pengantaran Hari Ini</div>
                            <i class="fas fa-shipping-fast absolute top-4 right-4 text-blue-500 text-xl"></i>
                        </div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                            <div class="text-2xl font-bold text-gray-800 mb-1" id="totalBalance">Rp 0</div>
                            <div class="text-xs text-gray-500">Total Saldo</div>
                            <i class="fas fa-wallet absolute top-4 right-4 text-green-500 text-xl"></i>
                        </div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                            <div class="text-2xl font-bold text-gray-800 mb-1" id="invoiceCount">0</div>
                            <div class="text-xs text-gray-500">Invoice Bulan Ini</div>
                            <i class="fas fa-receipt absolute top-4 right-4 text-purple-500 text-xl"></i>
                        </div>
                    </div>

                    <!-- Account Balances -->
                    <div class="bg-white rounded-2xl p-4 mb-4 shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-piggy-bank text-orange-500"></i>
                                Saldo Rekening
                            </h2>
                            <button onclick="app.showManageAccountsModal()" class="p-2 rounded-xl bg-gray-100 hover:bg-gray-200 transition-colors">
                                <i class="fas fa-cog text-gray-600"></i>
                            </button>
                        </div>
                        <div id="accountBalances">
                            <div class="text-center py-6 text-gray-500">
                                <i class="fas fa-wallet text-4xl mb-3 opacity-50"></i>
                                <p class="text-sm font-medium">Belum ada rekening</p>
                                <button onclick="app.showManageAccountsModal()" class="text-orange-600 text-xs font-bold mt-2">
                                    Tambah Rekening
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white rounded-2xl p-4 mb-4 shadow-sm border border-gray-100">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-bolt text-yellow-500"></i>
                            Quick Actions
                        </h2>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="app.showInvoiceGeneratorModal()" class="bg-orange-500 hover:bg-orange-600 py-3 px-4 rounded-xl text-white font-bold flex items-center justify-center gap-2 transition-colors">
                                <i class="fas fa-receipt"></i>
                                Buat Invoice
                            </button>
                            <button onclick="app.showTab('invoices')" class="bg-blue-500 hover:bg-blue-600 py-3 px-4 rounded-xl text-white font-bold flex items-center justify-center gap-2 transition-colors">
                                <i class="fas fa-chart-line"></i>
                                Keuangan
                            </button>
                        </div>
                    </div>

                    <!-- Recent Invoices -->
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-history text-purple-500"></i>
                                Invoice Terbaru
                            </h2>
                            <button onclick="app.showTab('invoices')" class="text-orange-600 font-bold text-sm">
                                Lihat Semua
                            </button>
                        </div>
                        <div id="recentInvoices">
                            <div class="text-center py-6 text-gray-500">
                                <i class="fas fa-receipt text-4xl mb-3 opacity-50"></i>
                                <p class="text-sm font-medium">Belum ada invoice</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Invoices Tab -->
                <div id="invoicesTab" class="tab-content animate-fade-in">
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                        <div class="flex gap-3 mb-6">
                            <button onclick="app.showInvoiceGeneratorModal()" class="flex-1 bg-orange-500 hover:bg-orange-600 py-3 px-4 rounded-xl text-white font-bold flex items-center justify-center gap-2 transition-colors">
                                <i class="fas fa-plus"></i>
                                Buat Invoice
                            </button>
                            <button onclick="app.showManageAccountsModal()" class="p-3 rounded-xl bg-gray-100 hover:bg-gray-200 transition-colors">
                                <i class="fas fa-cog text-gray-600"></i>
                            </button>
                        </div>

                        <!-- Invoice Container -->
                        <div class="invoice-container max-h-96 overflow-y-auto custom-scrollbar rounded-xl border border-gray-200 p-4 mb-4 bg-gray-50">
                            <div id="invoiceList">
                                <!-- Invoices will be loaded here -->
                            </div>
                        </div>

                        <!-- Pagination Controls -->
                        <div id="paginationControls" class="pagination flex justify-center items-center gap-2 mt-4 hidden">
                            <button id="firstPage" class="p-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="fas fa-angle-double-left text-sm"></i>
                            </button>
                            <button id="prevPage" class="p-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="fas fa-angle-left text-sm"></i>
                            </button>
                            
                            <div id="pageNumbers" class="flex gap-1">
                                <!-- Page numbers will be generated here -->
                            </div>
                            
                            <button id="nextPage" class="p-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="fas fa-angle-right text-sm"></i>
                            </button>
                            <button id="lastPage" class="p-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="fas fa-angle-double-right text-sm"></i>
                            </button>
                            
                            <div class="page-info text-sm text-gray-600 mx-2 font-medium" id="pageInfo">
                                Halaman 1 dari 1
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finance Tab -->
                <div id="financeTab" class="tab-content animate-fade-in">
                    <!-- Finance Quick Stats -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                            <div class="text-2xl font-bold text-gray-800 mb-1" id="financeIncome">Rp 0</div>
                            <div class="text-xs text-gray-500">Pendapatan Bulan Ini</div>
                            <i class="fas fa-arrow-down absolute top-4 right-4 text-green-500 text-xl"></i>
                        </div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                            <div class="text-2xl font-bold text-gray-800 mb-1" id="financeExpense">Rp 0</div>
                            <div class="text-xs text-gray-500">Pengeluaran Bulan Ini</div>
                            <i class="fas fa-arrow-up absolute top-4 right-4 text-red-500 text-xl"></i>
                        </div>
                    </div>

                    <!-- Finance Actions -->
                    <div class="bg-white rounded-2xl p-4 mb-6 shadow-sm border border-gray-100">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-coins text-yellow-500"></i>
                            Aksi Cepat
                        </h2>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="app.showAddTransactionModal()" class="bg-green-500 hover:bg-green-600 py-3 px-4 rounded-xl text-white font-bold flex items-center justify-center gap-2 transition-colors">
                                <i class="fas fa-plus"></i>
                                Transaksi
                            </button>
                            <button onclick="app.showTab('analysis')" class="bg-purple-500 hover:bg-purple-600 py-3 px-4 rounded-xl text-white font-bold flex items-center justify-center gap-2 transition-colors">
                                <i class="fas fa-chart-pie"></i>
                                Analisis
                            </button>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-exchange-alt text-green-500"></i>
                                Transaksi Terbaru
                            </h2>
                            <button onclick="app.showTransactionHistory()" class="text-orange-600 font-bold text-sm">
                                Lihat Semua
                            </button>
                        </div>
                        <div id="recentTransactions">
                            <div class="text-center py-6 text-gray-500">
                                <i class="fas fa-exchange-alt text-4xl mb-3 opacity-50"></i>
                                <p class="text-sm font-medium">Belum ada transaksi</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Tab -->
                <div id="analysisTab" class="tab-content animate-fade-in">
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                        <button onclick="app.analyzeExpenses()" class="w-full bg-purple-500 hover:bg-purple-600 py-3 px-4 rounded-xl text-white font-bold flex items-center justify-center gap-2 mb-6 transition-colors">
                            <i class="fas fa-robot"></i>
                            Analisis AI Pengeluaran
                        </button>

                        <div id="expenseAnalysis">
                            <div class="bubble-chart-container h-64 relative mb-6 rounded-xl bg-gray-50 p-4" id="bubbleChart">
                                <!-- Bubbles will be generated here -->
                            </div>

                            <div id="categoryDetails" class="space-y-2 mb-6">
                                <!-- Category details will be generated here -->
                            </div>

                            <div id="aiInsights" class="p-4 rounded-xl bg-blue-50 border border-blue-200">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-robot text-blue-500 text-xl mt-0.5"></i>
                                    <div>
                                        <h5 class="font-bold text-blue-800 mb-2 text-sm">AI Insights</h5>
                                        <p class="text-blue-700 text-xs font-medium">Klik tombol analisis untuk melihat insights pengeluaran Anda</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Floating Action Button -->
        <button class="fab fixed bottom-24 right-4 w-14 h-14 rounded-full bg-orange-500 text-white flex items-center justify-center shadow-lg transition-all hover:scale-110 active:scale-95 z-30" onclick="app.showInvoiceGeneratorModal()">
            <i class="fas fa-plus text-lg"></i>
        </button>

        <!-- Bottom Navigation - Fixed Footer -->
        <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex p-2 z-40 safe-area-bottom shadow-sm">
            <button class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-gray-500 transition-all rounded-xl active:bg-orange-50 active:text-orange-600" onclick="app.showTab('dashboard')">
                <i class="fas fa-home text-lg mb-1"></i>
                <span class="text-xs font-semibold">Home</span>
            </button>
            <button class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-gray-500 transition-all rounded-xl active:bg-orange-50 active:text-orange-600" onclick="app.showTab('invoices')">
                <i class="fas fa-receipt text-lg mb-1"></i>
                <span class="text-xs font-semibold">Invoice</span>
            </button>
            <button class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-gray-500 transition-all rounded-xl active:bg-orange-50 active:text-orange-600" onclick="app.showTab('finance')">
                <i class="fas fa-wallet text-lg mb-1"></i>
                <span class="text-xs font-semibold">Keuangan</span>
            </button>
            <button class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-gray-500 transition-all rounded-xl active:bg-orange-50 active:text-orange-600" onclick="app.showTab('analysis')">
                <i class="fas fa-chart-pie text-lg mb-1"></i>
                <span class="text-xs font-semibold">Analisis</span>
            </button>
        </nav>
    </div>

    <!-- Invoice Generator Modal -->
    <div id="invoiceModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden animate-fade-in">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col overflow-hidden animate-slide-up">
            <div class="modal-header bg-orange-500 p-4 text-white relative">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-receipt"></i>
                    Buat Invoice
                </h2>
                <button onclick="app.closeModal()" class="absolute top-4 right-4 text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-body p-4 overflow-y-auto flex-1 custom-scrollbar">
                <div class="form-group mb-4">
                    <label class="form-label block font-bold text-gray-700 mb-2 text-sm">Produk</label>
                    <div id="productsContainer">
                        <div class="product-row grid grid-cols-2 gap-3 mb-4 p-3 rounded-xl bg-gray-50">
                            <div class="col-span-2">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Nama Produk</label>
                                <input type="text" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Nama produk" value="">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Qty</label>
                                <input type="number" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Qty" value="1" min="1">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Harga</label>
                                <input type="number" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Harga" value="">
                            </div>
                            <div class="col-span-2 flex justify-end">
                                <button onclick="app.removeProduct(this)" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                    <i class="fas fa-times"></i> Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                    <button onclick="app.addProduct()" class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium text-gray-700 flex items-center justify-center gap-2 transition-colors">
                        <i class="fas fa-plus"></i>Tambah Produk
                    </button>
                </div>

                <div class="form-group mb-4">
                    <label class="form-label block font-bold text-gray-700 mb-2 text-sm">Ongkos Kirim</label>
                    <input type="number" id="shippingCost" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="0" value="">
                </div>

                <div class="form-group mb-4">
                    <label class="form-label block font-bold text-gray-700 mb-2 text-sm">Metode Pembayaran</label>
                    <select id="paymentMethod" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <option value="tunai">Tunai</option>
                        <option value="bca">BCA</option>
                    </select>
                </div>

                <!-- Invoice Summary -->
                <div class="bg-gray-50 rounded-xl p-4 mt-4">
                    <h3 class="font-bold text-gray-800 mb-3">Ringkasan Invoice</h3>
                    <div id="invoiceSummary" class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>Subtotal Produk:</span>
                            <span id="subtotalDisplay" class="font-medium">Rp 0</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Ongkos Kirim:</span>
                            <span id="shippingDisplay" class="font-medium">Rp 0</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold border-t border-gray-300 pt-2">
                            <span>Total:</span>
                            <span id="totalDisplay" class="text-orange-600">Rp 0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer flex gap-3 p-4 border-t border-gray-200">
                <button onclick="app.closeModal()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-bold text-gray-700 transition-colors">
                    Batal
                </button>
                <button onclick="app.generateInvoice()" class="flex-1 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-colors">
                    <i class="fas fa-check"></i>
                    Buat Invoice
                </button>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="transactionModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden animate-fade-in">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col overflow-hidden animate-slide-up">
            <div class="modal-header bg-orange-500 p-4 text-white relative">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-plus"></i>
                    Tambah Transaksi
                </h2>
                <button onclick="app.closeModal()" class="absolute top-4 right-4 text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-body p-4 overflow-y-auto flex-1 custom-scrollbar">
                <div class="form-group mb-4">
                    <label class="form-label block font-bold text-gray-700 mb-2 text-sm">Jenis Transaksi</label>
                    <select id="transactionType" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <option value="income">Pendapatan</option>
                        <option value="expense">Pengeluaran</option>
                    </select>
                </div>
                <div class="form-group mb-4">
                    <label class="form-label block font-bold text-gray-700 mb-2 text-sm">Kategori</label>
                    <select id="transactionCategory" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <option value="operasional">Operasional</option>
                        <option value="bahan_baku">Bahan Baku</option>
                        <option value="transportasi">Transportasi</option>
                        <option value="gaji">Gaji Karyawan</option>
                        <option value="listrik">Listrik & Air</option>
                        <option value="internet">Internet</option>
                        <option value="pemeliharaan">Pemeliharaan</option>
                        <option value="lainnya">Lainnya</option>
                    </select>
                </div>
                <div class="form-group mb-4">
                    <label class="form-label block font-bold text-gray-700 mb-2 text-sm">Rekening</label>
                    <select id="transactionAccount" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <!-- Accounts will be populated here -->
                    </select>
                </div>
                <div class="form-group mb-4">
                    <label class="form-label block font-bold text-gray-700 mb-2 text-sm">Jumlah</label>
                    <input type="number" id="transactionAmount" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="0">
                </div>
                <div class="form-group mb-4">
                    <label class="form-label block font-bold text-gray-700 mb-2 text-sm">Keterangan</label>
                    <input type="text" id="transactionDescription" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Deskripsi transaksi">
                </div>
            </div>
            <div class="modal-footer flex gap-3 p-4 border-t border-gray-200">
                <button onclick="app.closeModal()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-bold text-gray-700 transition-colors">
                    Batal
                </button>
                <button onclick="app.saveTransaction()" class="flex-1 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-bold transition-colors">
                    Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- Manage Accounts Modal -->
    <div id="manageAccountsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden animate-fade-in">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col overflow-hidden animate-slide-up">
            <div class="modal-header bg-orange-500 p-4 text-white relative">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-cog"></i>
                    Kelola Rekening
                </h2>
                <button onclick="app.closeModal()" class="absolute top-4 right-4 text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-body p-4 overflow-y-auto flex-1 custom-scrollbar">
                <div class="form-group mb-6">
                    <label class="form-label block font-bold text-gray-700 mb-3 text-sm">Tambah Rekening Baru</label>
                    <select id="newAccountType" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 mb-2">
                        <option value="tunai">Tunai</option>
                        <option value="bca">BCA</option>
                        <option value="dana">Dana</option>
                    </select>
                    <input type="number" id="newAccountBalance" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 mb-3" placeholder="Saldo awal" value="0">
                    <button onclick="app.addAccount()" class="w-full py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-colors">
                        <i class="fas fa-plus"></i>
                        Tambah Rekening
                    </button>
                </div>
                
                <div class="mt-4">
                    <h3 class="font-bold text-gray-800 mb-3">Rekening Saat Ini</h3>
                    <div id="accountsList" class="space-y-3">
                        <!-- Accounts will be listed here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer p-4 border-t border-gray-200">
                <button onclick="app.closeModal()" class="w-full py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-bold text-gray-700 transition-colors">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- Notification System -->
    <div id="notificationContainer" class="fixed top-4 right-4 left-4 z-50 space-y-2"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA1kevuJ9mRJ8le8uPXin11uUqJ6sOLopY",
            authDomain: "vlcrave-whatsapp-order.firebaseapp.com",
            projectId: "vlcrave-whatsapp-order",
            storageBucket: "vlcrave-whatsapp-order.firebasestorage.app",
            messagingSenderId: "796602954067",
            appId: "1:796602954067:web:e10a110ae904decdc471a6",
            measurementId: "G-XLWNDN39ZD"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Main Application
        const app = {
            currentTab: 'dashboard',
            invoices: [],
            transactions: [],
            accounts: [],
            currentEditingInvoice: null,
            currentEditingAccount: null,
            expenseCategories: {
                'operasional': { name: 'Operasional', color: '#ef4444' },
                'bahan_baku': { name: 'Bahan Baku', color: '#f97316' },
                'transportasi': { name: 'Transportasi', color: '#eab308' },
                'gaji': { name: 'Gaji Karyawan', color: '#84cc16' },
                'listrik': { name: 'Listrik & Air', color: '#06b6d4' },
                'internet': { name: 'Internet', color: '#3b82f6' },
                'pemeliharaan': { name: 'Pemeliharaan', color: '#8b5cf6' },
                'penyesuaian': { name: 'Penyesuaian', color: '#a855f7' },
                'lainnya': { name: 'Lainnya', color: '#64748b' }
            },
            
            // Pagination variables
            currentPage: 1,
            itemsPerPage: 10,
            totalPages: 1,

            // Initialize App
            async init() {
                console.log("VLCrave Express Mobile App Initialized");
                
                // Set up real-time listeners
                this.setupRealtimeListeners();
                
                // Initialize default accounts if not exists
                await this.initializeDefaultAccounts();
                
                // Setup invoice calculation listeners
                this.setupInvoiceCalculations();
                
                // Setup pagination event listeners
                this.setupPaginationListeners();
            },

            // Setup pagination event listeners
            setupPaginationListeners() {
                document.getElementById('firstPage').addEventListener('click', () => {
                    this.goToPage(1);
                });
                
                document.getElementById('prevPage').addEventListener('click', () => {
                    this.goToPage(this.currentPage - 1);
                });
                
                document.getElementById('nextPage').addEventListener('click', () => {
                    this.goToPage(this.currentPage + 1);
                });
                
                document.getElementById('lastPage').addEventListener('click', () => {
                    this.goToPage(this.totalPages);
                });
            },

            // Setup invoice calculation listeners
            setupInvoiceCalculations() {
                document.addEventListener('input', (e) => {
                    if (e.target.classList.contains('product-name') || 
                        e.target.classList.contains('product-qty') || 
                        e.target.classList.contains('product-price') ||
                        e.target.id === 'shippingCost') {
                        this.calculateInvoiceTotal();
                    }
                });
            },

            // Calculate invoice total
            calculateInvoiceTotal() {
                let subtotal = 0;
                
                const productRows = document.querySelectorAll('.product-row');
                productRows.forEach(row => {
                    const qty = parseInt(row.querySelector('.product-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.product-price').value) || 0;
                    subtotal += qty * price;
                });
                
                const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
                const total = subtotal + shippingCost;
                
                document.getElementById('subtotalDisplay').textContent = this.formatCurrency(subtotal);
                document.getElementById('shippingDisplay').textContent = this.formatCurrency(shippingCost);
                document.getElementById('totalDisplay').textContent = this.formatCurrency(total);
            },

            // Initialize default accounts
            async initializeDefaultAccounts() {
                try {
                    const accountsSnapshot = await db.collection("finance_accounts").get();
                    if (accountsSnapshot.empty) {
                        const defaultAccounts = [
                            { name: 'Tunai', type: 'tunai', balance: 0, createdAt: new Date(), updatedAt: new Date() },
                            { name: 'BCA', type: 'bca', balance: 0, createdAt: new Date(), updatedAt: new Date() }
                        ];
                        
                        for (const account of defaultAccounts) {
                            await db.collection("finance_accounts").add(account);
                        }
                        console.log("Default accounts created");
                    }
                } catch (error) {
                    console.error("Error initializing default accounts:", error);
                }
            },

            // Setup real-time Firestore listeners
            setupRealtimeListeners() {
                // Invoices listener
                db.collection("invoices")
                    .orderBy("createdAt", "desc")
                    .limit(100)
                    .onSnapshot((snapshot) => {
                        this.invoices = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            data.id = doc.id;
                            this.invoices.push(data);
                        });
                        this.updateDashboard();
                        this.renderRecentInvoices();
                        this.renderInvoiceList();
                    });

                // Transactions listener
                db.collection("finance_transactions")
                    .orderBy("createdAt", "desc")
                    .limit(50)
                    .onSnapshot((snapshot) => {
                        this.transactions = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            data.id = doc.id;
                            this.transactions.push(data);
                        });
                        this.updateDashboard();
                        this.renderRecentTransactions();
                    });

                // Accounts listener
                db.collection("finance_accounts")
                    .onSnapshot((snapshot) => {
                        this.accounts = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            data.id = doc.id;
                            this.accounts.push(data);
                        });
                        this.updateDashboard();
                        this.renderAccountBalances();
                        this.renderAccountsList();
                        this.updateAccountSelect();
                    });
            },

            // Tab Navigation
            showTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.getElementById(tabName + 'Tab').classList.add('active');
                this.currentTab = tabName;
            },

            // Modal Management
            showInvoiceGeneratorModal() {
                document.getElementById('invoiceModal').classList.remove('hidden');
                this.resetInvoiceForm();
                this.calculateInvoiceTotal();
            },

            showAddTransactionModal() {
                document.getElementById('transactionModal').classList.remove('hidden');
                document.getElementById('transactionAmount').value = '';
                document.getElementById('transactionDescription').value = '';
            },

            showManageAccountsModal() {
                document.getElementById('manageAccountsModal').classList.remove('hidden');
            },

            closeModal() {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.classList.add('hidden');
                });
                this.currentEditingInvoice = null;
                this.currentEditingAccount = null;
            },

            // Invoice Form Management
            resetInvoiceForm() {
                const container = document.getElementById('productsContainer');
                container.innerHTML = `
                    <div class="product-row grid grid-cols-2 gap-3 mb-4 p-3 rounded-xl bg-gray-50">
                        <div class="col-span-2">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Nama Produk</label>
                            <input type="text" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Nama produk" value="Teh Tarik">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Qty</label>
                            <input type="number" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Qty" value="1" min="1">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Harga</label>
                            <input type="number" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Harga" value="10000">
                        </div>
                        <div class="col-span-2 flex justify-end">
                            <button onclick="app.removeProduct(this)" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                <i class="fas fa-times"></i> Hapus
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('shippingCost').value = '5000';
                document.getElementById('paymentMethod').value = 'tunai';
            },

            addProduct() {
                const container = document.getElementById('productsContainer');
                const newRow = document.createElement('div');
                newRow.className = 'product-row grid grid-cols-2 gap-3 mb-4 p-3 rounded-xl bg-gray-50';
                newRow.innerHTML = `
                    <div class="col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Nama Produk</label>
                        <input type="text" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Nama produk">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Qty</label>
                        <input type="number" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Qty" value="1" min="1">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Harga</label>
                        <input type="number" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Harga" value="0">
                    </div>
                    <div class="col-span-2 flex justify-end">
                        <button onclick="app.removeProduct(this)" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                            <i class="fas fa-times"></i> Hapus
                        </button>
                    </div>
                `;
                container.appendChild(newRow);
                this.calculateInvoiceTotal();
            },

            removeProduct(button) {
                const row = button.closest('.product-row');
                if (document.querySelectorAll('.product-row').length > 1) {
                    row.remove();
                    this.calculateInvoiceTotal();
                } else {
                    this.showNotification('Minimal harus ada 1 produk', 'error');
                }
            },

            // Account Management
            async addAccount() {
                const type = document.getElementById('newAccountType').value;
                const balance = parseFloat(document.getElementById('newAccountBalance').value) || 0;
                
                const accountName = type === 'tunai' ? 'Tunai' : 
                                  type === 'bca' ? 'BCA' : 'Dana';

                const existingAccount = this.accounts.find(acc => acc.type === type);
                if (existingAccount) {
                    this.showNotification('Rekening sudah ada', 'error');
                    return;
                }

                const accountData = {
                    name: accountName,
                    type: type,
                    balance: balance,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                try {
                    await db.collection("finance_accounts").add(accountData);
                    this.showNotification('Rekening berhasil ditambahkan', 'success');
                    document.getElementById('newAccountBalance').value = '0';
                } catch (error) {
                    console.error("Error adding account:", error);
                    this.showNotification('Error menambah rekening', 'error');
                }
            },

            renderAccountBalances() {
                const container = document.getElementById('accountBalances');
                
                if (this.accounts.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-6 text-gray-500">
                            <i class="fas fa-wallet text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm font-medium">Belum ada rekening</p>
                            <button onclick="app.showManageAccountsModal()" class="text-orange-600 text-xs font-bold mt-2">
                                Tambah Rekening
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.accounts.map(account => `
                    <div class="flex justify-between items-center p-3 mb-3 rounded-xl bg-gray-50 border-l-4 ${account.type === 'tunai' ? 'border-orange-500' : account.type === 'bca' ? 'border-blue-500' : 'border-green-500'}">
                        <div>
                            <div class="font-semibold text-gray-800">${account.name}</div>
                            <div class="text-xs text-gray-500 capitalize">${account.type}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-800">${this.formatCurrency(account.balance)}</div>
                            <button onclick="app.editAccountBalance('${account.id}')" class="text-xs text-blue-600 font-medium mt-1">
                                Edit Saldo
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            renderAccountsList() {
                const container = document.getElementById('accountsList');
                
                if (this.accounts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Belum ada rekening</p>';
                    return;
                }

                container.innerHTML = this.accounts.map(account => `
                    <div class="flex justify-between items-center p-3 border border-gray-200 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-800">${account.name}</div>
                            <div class="text-sm text-gray-500">${this.formatCurrency(account.balance)}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="app.editAccountBalance('${account.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="app.deleteAccount('${account.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            updateAccountSelect() {
                const select = document.getElementById('transactionAccount');
                select.innerHTML = this.accounts.map(account => `
                    <option value="${account.id}">${account.name} - ${this.formatCurrency(account.balance)}</option>
                `).join('');
            },

            // Invoice Management with Pagination
            renderRecentInvoices() {
                const container = document.getElementById('recentInvoices');
                const recent = this.invoices.slice(0, 3);
                
                if (recent.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-6 text-gray-500">
                            <i class="fas fa-receipt text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm font-medium">Belum ada invoice</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = recent.map(invoice => `
                    <div class="flex justify-between items-center p-3 mb-2 rounded-xl bg-gray-50 hover:bg-gray-100 transition-colors">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800 text-sm">${invoice.invoiceNumber}</div>
                            <div class="text-xs text-gray-500">${this.formatDate(invoice.createdAt)}</div>
                        </div>
                        <div class="font-semibold text-orange-600 text-sm">
                            ${this.formatCurrency(invoice.total || 0)}
                        </div>
                    </div>
                `).join('');
            },

            renderInvoiceList() {
                const container = document.getElementById('invoiceList');
                const paginationControls = document.getElementById('paginationControls');
                
                if (this.invoices.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-receipt text-3xl mb-3"></i>
                            <p>Belum ada invoice</p>
                            <p class="text-sm">Buat invoice pertama Anda</p>
                        </div>
                    `;
                    paginationControls.classList.add('hidden');
                    return;
                }

                this.totalPages = Math.ceil(this.invoices.length / this.itemsPerPage);
                
                if (this.currentPage > this.totalPages) {
                    this.currentPage = this.totalPages;
                }
                if (this.currentPage < 1) {
                    this.currentPage = 1;
                }

                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const currentInvoices = this.invoices.slice(startIndex, endIndex);

                container.innerHTML = currentInvoices.map(invoice => `
                    <div class="flex justify-between items-start p-3 mb-3 rounded-xl bg-white hover:bg-gray-50 transition-colors border border-gray-200">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800 text-sm">${invoice.invoiceNumber}</div>
                            <div class="text-xs text-gray-500">${this.formatDate(invoice.createdAt)}  ${invoice.paymentMethod}</div>
                            <div class="text-xs text-gray-500">Ongkir: ${this.formatCurrency(invoice.shippingCost || 0)}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-orange-600 text-sm mb-2">${this.formatCurrency(invoice.total || 0)}</div>
                            <div class="flex gap-1">
                                <button onclick="app.editInvoice('${invoice.id}')" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors">
                                    <i class="fas fa-edit text-xs"></i>
                                </button>
                                <button onclick="app.deleteInvoice('${invoice.id}')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                                <button onclick="app.shareInvoice('${invoice.id}')" class="p-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200 transition-colors">
                                    <i class="fas fa-share text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                this.updatePaginationControls();
                paginationControls.classList.remove('hidden');
            },

            // Pagination Methods
            updatePaginationControls() {
                const pageInfo = document.getElementById('pageInfo');
                const firstPageBtn = document.getElementById('firstPage');
                const prevPageBtn = document.getElementById('prevPage');
                const nextPageBtn = document.getElementById('nextPage');
                const lastPageBtn = document.getElementById('lastPage');

                pageInfo.textContent = `Halaman ${this.currentPage} dari ${this.totalPages}`;

                firstPageBtn.disabled = this.currentPage === 1;
                prevPageBtn.disabled = this.currentPage === 1;
                nextPageBtn.disabled = this.currentPage === this.totalPages;
                lastPageBtn.disabled = this.currentPage === this.totalPages;

                this.generatePageNumbers();
            },

            generatePageNumbers() {
                const pageNumbers = document.getElementById('pageNumbers');
                pageNumbers.innerHTML = '';

                let startPage = Math.max(1, this.currentPage - 2);
                let endPage = Math.min(this.totalPages, startPage + 4);

                if (endPage - startPage < 4) {
                    startPage = Math.max(1, endPage - 4);
                }

                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `w-8 h-8 rounded-lg border font-medium text-sm transition-colors ${i === this.currentPage ? 'bg-orange-500 text-white border-orange-500' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'}`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => {
                        this.goToPage(i);
                    });
                    pageNumbers.appendChild(pageBtn);
                }
            },

            goToPage(page) {
                if (page < 1 || page > this.totalPages || page === this.currentPage) {
                    return;
                }
                
                this.currentPage = page;
                this.renderInvoiceList();
                
                document.getElementById('invoiceList').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            },

            // Generate Invoice
            async generateInvoice() {
                const productRows = document.querySelectorAll('.product-row');
                const products = [];
                let subtotal = 0;

                productRows.forEach(row => {
                    const name = row.querySelector('.product-name').value.trim();
                    const quantity = parseInt(row.querySelector('.product-qty').value) || 1;
                    const price = parseFloat(row.querySelector('.product-price').value) || 0;
                    
                    if (name && price > 0) {
                        const productTotal = quantity * price;
                        products.push({
                            name: name,
                            quantity: quantity,
                            price: price,
                            total: productTotal
                        });
                        subtotal += productTotal;
                    }
                });

                if (products.length === 0) {
                    this.showNotification('Tambahkan minimal 1 produk', 'error');
                    return;
                }

                const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
                const paymentMethod = document.getElementById('paymentMethod').value;
                const total = subtotal + shippingCost;

                const invoiceCount = await this.getInvoiceCount();
                const invoiceNumber = `VLC-${(invoiceCount + 1).toString().padStart(4, '0')}`;

                const invoiceData = {
                    invoiceNumber: invoiceNumber,
                    products: products,
                    shippingCost: shippingCost,
                    subtotal: subtotal,
                    total: total,
                    paymentMethod: paymentMethod,
                    date: new Date().toLocaleDateString('id-ID'),
                    time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                    createdAt: new Date(),
                    status: 'completed'
                };

                try {
                    await db.collection("invoices").add(invoiceData);
                    
                    const account = this.accounts.find(acc => acc.type === paymentMethod);
                    if (account) {
                        const newBalance = account.balance + total;
                        await this.updateAccountBalanceDirect(account.id, newBalance);
                    }
                    
                    this.showNotification('Invoice berhasil dibuat!', 'success');
                    this.closeModal();
                    
                    this.currentPage = 1;
                } catch (error) {
                    console.error("Error creating invoice:", error);
                    this.showNotification('Error membuat invoice', 'error');
                }
            },

            async updateAccountBalanceDirect(accountId, newBalance) {
                try {
                    await db.collection("finance_accounts").doc(accountId).update({
                        balance: newBalance,
                        updatedAt: new Date()
                    });
                } catch (error) {
                    console.error("Error updating account:", error);
                    throw error;
                }
            },

            async getInvoiceCount() {
                try {
                    const snapshot = await db.collection("invoices").get();
                    return snapshot.size;
                } catch (error) {
                    console.error("Error getting invoice count:", error);
                    return 0;
                }
            },

            async deleteInvoice(invoiceId) {
                if (!confirm('Hapus invoice ini?')) return;
                
                try {
                    const invoice = this.invoices.find(inv => inv.id === invoiceId);
                    if (invoice) {
                        const account = this.accounts.find(acc => 
                            acc.type === invoice.paymentMethod
                        );
                        
                        if (account) {
                            const newBalance = Math.max(0, account.balance - invoice.total);
                            await this.updateAccountBalanceDirect(account.id, newBalance);
                        }
                    }
                    
                    await db.collection("invoices").doc(invoiceId).delete();
                    this.showNotification('Invoice dihapus', 'success');
                    
                    const currentPageCount = this.invoices.length - 1;
                    const maxPageForItems = Math.ceil(currentPageCount / this.itemsPerPage);
                    if (this.currentPage > maxPageForItems) {
                        this.currentPage = maxPageForItems;
                    }
                } catch (error) {
                    console.error("Error deleting invoice:", error);
                    this.showNotification('Error menghapus invoice', 'error');
                }
            },

            async shareInvoice(invoiceId) {
                const invoice = this.invoices.find(inv => inv.id === invoiceId);
                if (!invoice) return;

                let shareText = '';
                
                if (invoice.paymentMethod === 'bca') {
                    shareText = ` Pesanan anda telah selesai dan akan segera menuju alamat anda

Untuk pembayaran Transfer silahkan ke nomor rekening dibawah

BCA 
6455106421
a/n VICKY SATRIA LINDY
Nominal : ${this.formatCurrency(invoice.total)}

Terima kasih telah mempercayai VLCrave Express!`;
                } else {
                    shareText = ` Pesanan anda telah selesai dan akan segera menuju alamat anda

Silahkan bayar sesuai nominal dibawah secara Tunai/Cash
Nominal : ${this.formatCurrency(invoice.total)}

Terima kasih telah mempercayai VLCrave Express!`;
                }

                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: `Invoice ${invoice.invoiceNumber} - VLCrave Express`,
                            text: shareText
                        });
                    } catch (error) {
                        await this.copyToClipboard(shareText);
                        this.showNotification('Pesan disalin ke clipboard', 'success');
                    }
                } else {
                    await this.copyToClipboard(shareText);
                    this.showNotification('Pesan disalin ke clipboard', 'success');
                }
            },

            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (err) {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        return true;
                    } catch (err) {
                        document.body.removeChild(textArea);
                        return false;
                    }
                }
            },

            // Transaction Management
            renderRecentTransactions() {
                const container = document.getElementById('recentTransactions');
                const recent = this.transactions.slice(0, 5);
                
                if (recent.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-6 text-gray-500">
                            <i class="fas fa-exchange-alt text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm font-medium">Belum ada transaksi</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = recent.map(transaction => {
                    const isAdjustment = transaction.adjustment;
                    const icon = isAdjustment ? 'fa-adjust' : 
                                transaction.type === 'income' ? 'fa-arrow-down' : 'fa-arrow-up';
                    const bgColor = isAdjustment ? 'bg-purple-100' : 
                                   transaction.type === 'income' ? 'bg-green-100' : 'bg-red-100';
                    const textColor = isAdjustment ? 'text-purple-600' : 
                                     transaction.type === 'income' ? 'text-green-600' : 'text-red-600';
                    
                    return `
                        <div class="flex items-start p-3 mb-2 rounded-xl bg-gray-50 hover:bg-gray-100 transition-colors">
                            <div class="w-8 h-8 rounded-full ${bgColor} flex items-center justify-center mr-3 mt-1">
                                <i class="fas ${icon} ${textColor} text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-medium text-gray-800 text-sm">${transaction.description}</div>
                                <div class="text-xs text-gray-500">
                                    ${this.formatDate(transaction.createdAt)}  ${transaction.category}
                                    ${isAdjustment ? ' <span class="text-purple-600">Penyesuaian</span>' : ''}
                                </div>
                                ${isAdjustment ? `
                                    <div class="text-xs text-gray-500 mt-1">
                                        <span class="font-medium">Sebelum:</span> ${this.formatCurrency(transaction.balanceBefore)} 
                                        <span class="font-medium ml-2">Sesudah:</span> ${this.formatCurrency(transaction.balanceAfter)}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="text-right">
                                <div class="font-semibold ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'} text-sm">
                                    ${transaction.type === 'income' ? '+' : '-'} ${this.formatCurrency(transaction.amount)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            async saveTransaction() {
                const type = document.getElementById('transactionType').value;
                const category = document.getElementById('transactionCategory').value;
                const accountId = document.getElementById('transactionAccount').value;
                const amount = parseFloat(document.getElementById('transactionAmount').value) || 0;
                const description = document.getElementById('transactionDescription').value.trim();

                if (!description || amount <= 0 || !accountId) {
                    this.showNotification('Isi semua field dengan benar', 'error');
                    return;
                }

                const account = this.accounts.find(acc => acc.id === accountId);
                if (!account) {
                    this.showNotification('Rekening tidak ditemukan', 'error');
                    return;
                }

                if (type === 'expense' && account.balance < amount) {
                    this.showNotification('Saldo tidak mencukupi', 'error');
                    return;
                }

                const transactionData = {
                    type,
                    category,
                    accountId,
                    accountName: account.name,
                    amount,
                    description,
                    createdAt: new Date(),
                    date: new Date()
                };

                try {
                    await db.collection("finance_transactions").add(transactionData);
                    
                    const newBalance = type === 'income' ? 
                        account.balance + amount : 
                        account.balance - amount;
                    
                    await this.updateAccountBalanceDirect(accountId, newBalance);
                    
                    this.showNotification('Transaksi berhasil disimpan!', 'success');
                    this.closeModal();
                } catch (error) {
                    console.error("Error saving transaction:", error);
                    this.showNotification('Error menyimpan transaksi', 'error');
                }
            },

            // Expense Analysis
            async analyzeExpenses() {
                const expenseTransactions = this.transactions.filter(t => 
                    t.type === 'expense' && !t.adjustment
                );
                
                if (expenseTransactions.length === 0) {
                    this.showNotification('Belum ada data pengeluaran', 'info');
                    return;
                }

                document.getElementById('aiInsights').innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-spinner fa-spin text-blue-600"></i>
                        <span class="text-blue-700 text-xs">AI sedang menganalisis pengeluaran...</span>
                    </div>
                `;

                setTimeout(() => {
                    this.generateExpenseAnalysis(expenseTransactions);
                }, 2000);
            },

            generateExpenseAnalysis(expenses) {
                const categoryTotals = {};
                let totalExpenses = 0;

                expenses.forEach(expense => {
                    const category = expense.category || 'lainnya';
                    categoryTotals[category] = (categoryTotals[category] || 0) + expense.amount;
                    totalExpenses += expense.amount;
                });

                const categories = Object.keys(categoryTotals).map(category => ({
                    category,
                    name: this.expenseCategories[category]?.name || 'Lainnya',
                    amount: categoryTotals[category],
                    percentage: (categoryTotals[category] / totalExpenses) * 100,
                    color: this.expenseCategories[category]?.color || '#64748b'
                })).sort((a, b) => b.amount - a.amount);

                this.generateBubbleChart(categories);
                this.generateCategoryDetails(categories);
                this.generateAIInsights(categories, totalExpenses);
            },

            generateBubbleChart(categories) {
                const container = document.getElementById('bubbleChart');
                container.innerHTML = '';

                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                const maxBubbleSize = 80;
                const minBubbleSize = 40;

                const maxAmount = Math.max(...categories.map(c => c.amount));

                categories.forEach((category, index) => {
                    const size = minBubbleSize + ((category.amount / maxAmount) * (maxBubbleSize - minBubbleSize));
                    const angle = (index / categories.length) * 2 * Math.PI;
                    const radius = Math.min(containerWidth, containerHeight) * 0.3;
                    const x = (containerWidth / 2) + Math.cos(angle) * radius - size / 2;
                    const y = (containerHeight / 2) + Math.sin(angle) * radius - size / 2;

                    const bubble = document.createElement('div');
                    bubble.className = 'bubble absolute rounded-full flex items-center justify-center text-white font-bold text-center shadow-lg';
                    bubble.style.width = `${size}px`;
                    bubble.style.height = `${size}px`;
                    bubble.style.left = `${x}px`;
                    bubble.style.top = `${y}px`;
                    bubble.style.backgroundColor = category.color;
                    bubble.style.fontSize = `${Math.max(10, size / 8)}px`;

                    bubble.innerHTML = `
                        <div>
                            <div class="font-bold">${category.name.split(' ')[0]}</div>
                            <div class="text-xs opacity-90">${category.percentage.toFixed(0)}%</div>
                        </div>
                    `;

                    container.appendChild(bubble);
                });
            },

            generateCategoryDetails(categories) {
                const container = document.getElementById('categoryDetails');
                container.innerHTML = '';

                categories.forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-3 rounded-xl bg-gray-50';
                    item.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded mr-2" style="background-color: ${category.color}"></div>
                            <div>
                                <div class="font-medium text-gray-800 text-sm">${category.name}</div>
                                <div class="text-xs text-gray-500">${category.percentage.toFixed(1)}%</div>
                            </div>
                        </div>
                        <div class="font-semibold text-gray-800 text-sm">${this.formatCurrency(category.amount)}</div>
                    `;
                    container.appendChild(item);
                });
            },

            generateAIInsights(categories, totalExpenses) {
                const largest = categories[0];
                const second = categories[1];
                let insights = `Pengeluaran terbesar: <strong>${largest.name}</strong> (${largest.percentage.toFixed(1)}% - ${this.formatCurrency(largest.amount)})`;
                
                if (largest.percentage > 50) {
                    insights += `. Fokus utama pada ${largest.name.toLowerCase()}.`;
                } else if (second) {
                    insights += `, diikuti oleh <strong>${second.name}</strong> (${second.percentage.toFixed(1)}%).`;
                }

                insights += ` Total pengeluaran: <strong>${this.formatCurrency(totalExpenses)}</strong>.`;

                document.getElementById('aiInsights').innerHTML = `
                    <div class="flex items-start gap-3">
                        <i class="fas fa-robot text-blue-500 text-xl mt-0.5"></i>
                        <div>
                            <h5 class="font-bold text-blue-800 mb-2 text-sm">AI Insights</h5>
                            <p class="text-blue-700 text-xs font-medium">${insights}</p>
                        </div>
                    </div>
                `;
            },

            // Dashboard Updates
            updateDashboard() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                const todayIncome = this.invoices
                    .filter(invoice => {
                        const invoiceDate = new Date(invoice.createdAt?.toDate?.() || invoice.createdAt);
                        return invoiceDate >= today;
                    })
                    .reduce((sum, invoice) => sum + (invoice.shippingCost || 0), 0);

                const monthlyIncome = this.invoices
                    .filter(invoice => {
                        const invoiceDate = new Date(invoice.createdAt?.toDate?.() || invoice.createdAt);
                        return invoiceDate.getMonth() === currentMonth && invoiceDate.getFullYear() === currentYear;
                    })
                    .reduce((sum, invoice) => sum + (invoice.shippingCost || 0), 0);

                const todayInvoices = this.invoices.filter(invoice => {
                    const invoiceDate = new Date(invoice.createdAt?.toDate?.() || invoice.createdAt);
                    return invoiceDate >= today;
                });
                
                const totalBalance = this.accounts.reduce((sum, account) => sum + account.balance, 0);

                const monthInvoices = this.invoices.filter(invoice => {
                    const invoiceDate = new Date(invoice.createdAt?.toDate?.() || invoice.createdAt);
                    return invoiceDate.getMonth() === currentMonth && invoiceDate.getFullYear() === currentYear;
                });

                document.getElementById('incomeToday').textContent = this.formatCurrency(todayIncome);
                document.getElementById('deliveryToday').textContent = todayInvoices.length;
                document.getElementById('totalBalance').textContent = this.formatCurrency(totalBalance > 0 ? totalBalance : 0);
                document.getElementById('invoiceCount').textContent = monthInvoices.length;

                const monthlyExpense = this.transactions
                    .filter(t => t.type === 'expense' && 
                        new Date(t.createdAt?.toDate?.() || t.createdAt).getMonth() === currentMonth &&
                        new Date(t.createdAt?.toDate?.() || t.createdAt).getFullYear() === currentYear
                    )
                    .reduce((sum, t) => sum + t.amount, 0);

                document.getElementById('financeIncome').textContent = this.formatCurrency(monthlyIncome);
                document.getElementById('financeExpense').textContent = this.formatCurrency(monthlyExpense);
            },

            // Utility Functions
            formatCurrency(amount) {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                }).format(amount);
            },

            formatDate(timestamp) {
                if (!timestamp) return '';
                try {
                    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    return date.toLocaleDateString('id-ID', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric' 
                    });
                } catch (error) {
                    return '';
                }
            },

            showNotification(message, type = 'info') {
                const container = document.getElementById('notificationContainer');
                const notification = document.createElement('div');
                
                const typeClasses = {
                    success: 'bg-green-500 text-white',
                    error: 'bg-red-500 text-white',
                    info: 'bg-blue-500 text-white',
                    warning: 'bg-yellow-500 text-white'
                };
                
                notification.className = `p-4 rounded-xl shadow-lg font-bold text-sm transform -translate-y-2 opacity-0 transition-all duration-300 ${typeClasses[type]}`;
                notification.textContent = message;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.remove('-translate-y-2', 'opacity-0');
                    notification.classList.add('translate-y-0', 'opacity-100');
                }, 100);
                
                setTimeout(() => {
                    notification.classList.remove('translate-y-0', 'opacity-100');
                    notification.classList.add('-translate-y-2', 'opacity-0');
                    
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        };

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
