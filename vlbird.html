<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e88e5">
    <title>VLCrave Taxi - Taxi Meter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöï</text></svg>">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e88e5',
                        'primary-dark': '#1565c0',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1e88e5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        .pulse {
            animation: pulse 0.5s ease-in-out;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Custom scrollbar */
        .thin-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        
        .thin-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }
        
        .thin-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }
        
        .thin-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Landscape layout adjustments */
        @media (max-width: 1024px) {
            .landscape-container {
                min-width: 900px;
            }
        }
        
        @media (max-width: 768px) {
            .landscape-container {
                min-width: 700px;
            }
        }

        .qr-placeholder {
            background: linear-gradient(45deg, #f3f4f6 25%, transparent 25%), 
                        linear-gradient(-45deg, #f3f4f6 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f3f4f6 75%), 
                        linear-gradient(-45deg, transparent 75%, #f3f4f6 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Map container */
        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            z-index: 1;
        }
        
        /* Tab styles */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            border-bottom-color: #1e88e5;
            color: #1e88e5;
            font-weight: bold;
        }
        
        .sync-badge {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-600 to-blue-800 min-h-screen overflow-x-auto">
    <!-- Main Container - Landscape Layout -->
    <div class="w-full min-h-screen p-2 landscape-container">
        <!-- Taximeter Card - Horizontal Layout -->
        <div class="bg-white rounded-xl shadow-xl w-full min-h-[95vh] flex flex-col overflow-hidden border border-white/20 fade-in">
            
            <!-- Compact Header dengan Sync Status -->
            <div class="bg-gradient-to-r from-primary to-primary-dark text-white px-4 py-2 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-taxi text-lg"></i>
                    <div>
                        <h1 class="text-sm font-bold">VLCrave Taxi</h1>
                        <p class="text-xs opacity-90">
                            Sync: <span id="sync-status" class="text-green-400 font-bold">Perfect</span> | 
                            Firebase: <span id="firebase-status" class="text-green-400">Connected</span>
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-3 text-xs">
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-satellite-dish"></i>
                        <span id="gps-status">Mencari...</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-battery-three-quarters"></i>
                        <span id="battery-level">-</span>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="flex border-b border-gray-200 bg-gray-50">
                <button class="tab-button active" data-tab="taximeter">
                    <i class="fas fa-taxi mr-1"></i>Taximeter
                </button>
                <button class="tab-button" data-tab="maps">
                    <i class="fas fa-map mr-1"></i>Peta
                </button>
                <button class="tab-button" data-tab="history">
                    <i class="fas fa-history mr-1"></i>Riwayat
                </button>
            </div>

            <!-- Tab Contents -->
            <div class="flex-1 overflow-hidden">
                <!-- Taximeter Tab -->
                <div id="taximeter-tab" class="tab-content active h-full">
                    <div class="flex-1 flex overflow-x-auto thin-scrollbar h-full">
                        
                        <!-- QR Code Section -->
                        <div id="payment-section" class="w-64 min-w-[200px] flex flex-col border-r border-gray-200 hidden">
                            <div class="p-3 border-b border-gray-200">
                                <h2 class="text-sm font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-qrcode mr-1 text-primary text-xs"></i>
                                    PEMBAYARAN QRIS
                                </h2>
                            </div>
                            
                            <div class="flex-1 flex flex-col items-center justify-center p-3">
                                <div class="bg-white p-2 rounded-lg shadow-inner border border-gray-200 mb-3 qr-placeholder relative">
                                    <canvas id="qrcode-canvas" width="128" height="128" class="w-32 h-32"></canvas>
                                    <div id="qr-placeholder-text" class="absolute inset-0 flex items-center justify-center flex-col">
                                        <div class="loader mb-2"></div>
                                        <div class="text-xs text-gray-500 text-center">QR Code akan muncul<br>setelah trip selesai</div>
                                    </div>
                                </div>
                                
                                <div class="text-center">
                                    <div class="text-xs text-gray-600 font-semibold mb-1">TOTAL BAYAR</div>
                                    <div id="amount-display" class="text-lg font-bold text-primary">Rp 0</div>
                                </div>

                                <!-- Trip ID Display -->
                                <div class="mt-3 text-center">
                                    <div class="text-xs text-gray-600 font-semibold mb-1">TRIP ID</div>
                                    <div id="trip-id" class="text-sm font-bold text-gray-800">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Middle Section - Distance, Fare & Controls -->
                        <div class="w-full min-w-[500px] flex flex-col border-r border-gray-200">
                            
                            <!-- Compact Distance Display dengan Sync Info -->
                            <div class="p-3 border-b border-gray-200">
                                <div class="flex justify-between items-center mb-2">
                                    <h2 class="text-sm font-bold text-gray-800 flex items-center">
                                        <i class="fas fa-road mr-1 text-primary text-xs"></i>
                                        Jarak Tempuh
                                    </h2>
                                    <div class="flex items-center space-x-2">
                                        <span id="distance-status" class="text-xs font-medium">-</span>
                                        <span id="distance-indicator" class="w-2 h-2 rounded-full"></span>
                                        <span id="sync-indicator" class="sync-badge bg-green-500 text-white text-[8px] px-1 rounded">SYNC</span>
                                    </div>
                                </div>
                                
                                <div class="text-center mb-3">
                                    <div id="distance" class="text-3xl font-bold text-primary mb-1">0.00</div>
                                    <div class="text-xs text-gray-600 font-semibold">KILOMETER</div>
                                </div>

                                <!-- Compact Stats Grid -->
                                <div class="grid grid-cols-4 gap-2 mb-3">
                                    <div class="bg-gray-50 rounded-lg p-2 text-center border border-gray-200">
                                        <div id="duration" class="text-base font-bold text-primary">00:00:00</div>
                                        <div class="text-[10px] text-gray-600 font-semibold mt-1">DURASI</div>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-2 text-center border border-gray-200">
                                        <div id="speed" class="text-base font-bold text-primary">0.0</div>
                                        <div class="text-[10px] text-gray-600 font-semibold mt-1">KM/JAM</div>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-2 text-center border border-gray-200">
                                        <div id="valid-points" class="text-base font-bold text-primary">0</div>
                                        <div class="text-[10px] text-gray-600 font-semibold mt-1">DATA VALID</div>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-2 text-center border border-gray-200">
                                        <div id="waiting-time" class="text-base font-bold text-primary">00:00</div>
                                        <div class="text-[10px] text-gray-600 font-semibold mt-1">WAKTU TUNGGU</div>
                                    </div>
                                </div>

                                <!-- Perhitungan Tarif -->
                                <div class="bg-gradient-to-r from-success to-green-600 text-white p-3 rounded-lg text-center mb-3 shadow">
                                    <div id="total-fare" class="text-xl font-bold mb-1">Rp 5.000</div>
                                    <div class="text-xs opacity-90 font-semibold">TOTAL TARIF</div>
                                </div>

                                <!-- Compact Tarif Breakdown -->
                                <div class="grid grid-cols-3 gap-2 mb-3">
                                    <div class="bg-blue-50 rounded-lg p-2 text-center border border-blue-200">
                                        <div class="text-xs font-semibold text-gray-600 mb-1">Tarif Awal</div>
                                        <div id="base-fare" class="text-sm font-bold text-primary">Rp 5.000</div>
                                    </div>
                                    <div class="bg-blue-50 rounded-lg p-2 text-center border border-blue-200">
                                        <div class="text-xs font-semibold text-gray-600 mb-1">Biaya Jarak</div>
                                        <div id="distance-fare" class="text-sm font-bold text-primary">Rp 0</div>
                                    </div>
                                    <div class="bg-blue-50 rounded-lg p-2 text-center border border-blue-200">
                                        <div class="text-xs font-semibold text-gray-600 mb-1">Biaya Tunggu</div>
                                        <div id="waiting-fare" class="text-sm font-bold text-primary">Rp 0</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Controls Section -->
                            <div class="flex-1 p-3 bg-gray-50 flex flex-col">
                                <!-- Status Information dengan Sync Details -->
                                <div class="bg-blue-50 rounded-lg p-3 border border-blue-200 mb-3">
                                    <div class="text-xs font-bold text-blue-800 mb-2 flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            STATUS SISTEM
                                        </div>
                                        <div id="data-sync-status" class="text-green-600 font-bold text-[10px]">SYNCED</div>
                                    </div>
                                    <div class="text-[11px] text-blue-700 space-y-1">
                                        <div class="flex justify-between">
                                            <span class="font-semibold">Status Trip:</span>
                                            <span id="trip-status" class="text-green-600 font-bold">Siap</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-semibold">Trip ID:</span>
                                            <span id="current-trip-id" class="font-mono text-[10px]">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-semibold">Firebase Updates:</span>
                                            <span id="firebase-update-count" class="font-bold">0</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-semibold">Pending Data:</span>
                                            <span id="pending-data-count" class="font-bold">0</span>
                                        </div>
                                    </div>
                                </div>

                                <div id="distance-warning" class="hidden bg-warning text-white p-2 rounded text-center text-xs mb-3">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    Menunggu akurasi GPS...
                                </div>

                                <div class="flex space-x-2 mt-auto">
                                    <button id="start-btn" class="flex-1 bg-primary hover:bg-primary-dark text-white py-2 rounded-lg font-bold flex items-center justify-center transition-all duration-200 active:scale-95 shadow text-xs">
                                        <i class="fas fa-play mr-1"></i>
                                        MULAI
                                    </button>
                                    <button id="reset-btn" disabled class="flex-1 bg-gray-400 text-white py-2 rounded-lg font-bold flex items-center justify-center transition-all duration-200 active:scale-95 shadow text-xs">
                                        <i class="fas fa-redo mr-1"></i>
                                        SELESAI
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Maps Tab -->
                <div id="maps-tab" class="tab-content h-full p-4">
                    <div class="bg-white rounded-lg shadow p-4 h-full">
                        <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-map-marked-alt mr-2 text-primary"></i>
                            Peta Perjalanan
                        </h2>
                        <div id="map" class="w-full h-3/4 mb-3"></div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                <div class="text-xs font-semibold text-gray-600 mb-1">Lokasi Saat Ini</div>
                                <div id="current-location" class="text-sm font-medium text-gray-800">-</div>
                            </div>
                            <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                                <div class="text-xs font-semibold text-gray-600 mb-1">Status GPS</div>
                                <div id="map-gps-status" class="text-sm font-medium text-green-600">Mencari...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="history-tab" class="tab-content h-full p-4">
                    <div class="bg-white rounded-lg shadow p-4 h-full flex flex-col">
                        <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-history mr-2 text-primary"></i>
                            Riwayat Perjalanan
                        </h2>
                        <div class="flex space-x-2 mb-3">
                            <button id="refresh-history" class="bg-primary text-white px-3 py-1 rounded text-xs flex items-center">
                                <i class="fas fa-sync-alt mr-1"></i> Refresh
                            </button>
                            <button id="clear-history" class="bg-gray-500 text-white px-3 py-1 rounded text-xs flex items-center">
                                <i class="fas fa-trash mr-1"></i> Hapus
                            </button>
                        </div>
                        <div id="history-list" class="flex-1 overflow-y-auto thin-scrollbar space-y-2">
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-history text-3xl mb-2 opacity-50"></i>
                                <p>Belum ada riwayat perjalanan</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Status Bar dengan Sync Info -->
            <div class="bg-gray-800 text-white px-3 py-1 flex justify-between items-center text-xs">
                <div class="flex items-center space-x-3">
                    <span>VLCrave Taxi - Perfect Sync System</span>
                    <span class="text-gray-400">|</span>
                    <span id="connection-status" class="text-green-400">
                        <i class="fas fa-wifi mr-1"></i>Connected
                    </span>
                </div>
                <div class="flex items-center space-x-3">
                    <span id="current-time">00:00:00</span>
                    <span class="text-gray-400">|</span>
                    <span id="last-update">Last: -</span>
                    <span class="text-gray-400">|</span>
                    <span id="data-sync">Sync: <span class="text-green-400">Perfect</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pembayaran -->
    <div id="payment-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold text-gray-800">Pilih Metode Pembayaran</h2>
                <p class="text-sm text-gray-600 mt-1">Total yang harus dibayar:</p>
                <div id="modal-total-fare" class="text-xl font-bold text-primary mt-1">Rp 0</div>
            </div>
            
            <div class="space-y-3">
                <button id="cash-payment" class="w-full bg-primary hover:bg-primary-dark text-white py-3 rounded-lg font-bold flex items-center justify-center transition-all duration-200 active:scale-95 shadow">
                    <i class="fas fa-money-bill-wave mr-2"></i>
                    Bayar Cash
                </button>
                
                <button id="qris-payment" class="w-full bg-success hover:bg-green-600 text-white py-3 rounded-lg font-bold flex items-center justify-center transition-all duration-200 active:scale-95 shadow">
                    <i class="fas fa-qrcode mr-2"></i>
                    Bayar dengan QRIS
                </button>
            </div>
            
            <button id="close-modal" class="w-full mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 rounded-lg font-bold transition-all duration-200 active:scale-95">
                Tutup
            </button>
        </div>
    </div>

    <!-- Compact Notification -->
    <div id="notification" class="fixed top-2 left-1/2 transform -translate-x-1/2 -translate-y-20 bg-success text-white px-4 py-2 rounded-full shadow-lg z-50 transition-all duration-300 flex items-center space-x-2 text-xs">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">Sistem siap!</span>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA1kevuJ9mRJ8le8uPXin11uUqJ6sOLopY",
            authDomain: "vlcrave-whatsapp-order.firebaseapp.com",
            projectId: "vlcrave-whatsapp-order",
            storageBucket: "vlcrave-whatsapp-order.firebasestorage.app",
            messagingSenderId: "796602954067",
            appId: "1:796602954067:web:e10a110ae904decdc471a6",
            measurementId: "G-XLWNDN39ZD"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Taximeter Application Class - PERFECT SYNC VERSION
        class Taximeter {
            constructor() {
                this.isTracking = false;
                this.startTime = null;
                this.timerInterval = null;
                this.waitingTimerInterval = null;
                this.totalDistance = 0;
                this.lastPosition = null;
                this.watchId = null;
                this.validPoints = 0;
                this.waitingTime = 0;
                this.isMoving = false;
                this.lastUpdateTime = 0;
                this.positionHistory = [];
                this.currentTripId = null;
                this.firebaseConnected = false;
                this.finalFare = 0;
                this.map = null;
                this.marker = null;
                this.path = null;
                this.routeCoordinates = [];
                
                // PERFECT SYNC SETTINGS
                this.MIN_ACCURACY = 15;
                this.MIN_DISTANCE = 2;
                this.DISTANCE_INCREMENT = 100;
                this.BASE_FARE = 5000;
                this.DISTANCE_RATE = 200;
                this.WAITING_RATE = 2500;
                this.GPS_UPDATE_INTERVAL = 1000;        // GPS: 1 detik
                this.FIREBASE_UPDATE_INTERVAL = 2000;   // Firebase: 2 detik
                this.lastFirebaseUpdate = 0;
                this.pendingFirebaseData = null;
                this.firebaseUpdateCount = 0;
                this.lastFirebaseValidPoints = 0;
                this.syncStatus = 'perfect';
                
                // DOM Elements dengan sync indicators
                this.elements = {
                    distance: document.getElementById('distance'),
                    duration: document.getElementById('duration'),
                    speed: document.getElementById('speed'),
                    validPoints: document.getElementById('valid-points'),
                    waitingTime: document.getElementById('waiting-time'),
                    startBtn: document.getElementById('start-btn'),
                    resetBtn: document.getElementById('reset-btn'),
                    gpsStatus: document.getElementById('gps-status'),
                    batteryLevel: document.getElementById('battery-level'),
                    distanceStatus: document.getElementById('distance-status'),
                    distanceIndicator: document.getElementById('distance-indicator'),
                    distanceWarning: document.getElementById('distance-warning'),
                    totalFare: document.getElementById('total-fare'),
                    baseFare: document.getElementById('base-fare'),
                    distanceFare: document.getElementById('distance-fare'),
                    waitingFare: document.getElementById('waiting-fare'),
                    amountDisplay: document.getElementById('amount-display'),
                    notification: document.getElementById('notification'),
                    notificationText: document.getElementById('notification-text'),
                    currentTime: document.getElementById('current-time'),
                    lastUpdate: document.getElementById('last-update'),
                    qrCanvas: document.getElementById('qrcode-canvas'),
                    tripId: document.getElementById('trip-id'),
                    firebaseStatus: document.getElementById('firebase-status'),
                    tripStatus: document.getElementById('trip-status'),
                    currentTripId: document.getElementById('current-trip-id'),
                    qrPlaceholderText: document.getElementById('qr-placeholder-text'),
                    paymentSection: document.getElementById('payment-section'),
                    paymentModal: document.getElementById('payment-modal'),
                    modalTotalFare: document.getElementById('modal-total-fare'),
                    cashPayment: document.getElementById('cash-payment'),
                    qrisPayment: document.getElementById('qris-payment'),
                    closeModal: document.getElementById('close-modal'),
                    currentLocation: document.getElementById('current-location'),
                    mapGpsStatus: document.getElementById('map-gps-status'),
                    refreshHistory: document.getElementById('refresh-history'),
                    clearHistory: document.getElementById('clear-history'),
                    historyList: document.getElementById('history-list'),
                    syncStatus: document.getElementById('sync-status'),
                    syncIndicator: document.getElementById('sync-indicator'),
                    dataSyncStatus: document.getElementById('data-sync-status'),
                    firebaseUpdateCount: document.getElementById('firebase-update-count'),
                    pendingDataCount: document.getElementById('pending-data-count'),
                    dataSync: document.getElementById('data-sync')
                };
                
                this.init();
            }
            
            init() {
                console.log('üöï VLCrave Taxi - Perfect Sync System Loaded');
                this.initFirebase();
                this.initBattery();
                this.initMap();
                this.bindEvents();
                this.loadTripHistory();
                this.updateSyncUI();
                
                this.updateCurrentTime();
                setInterval(() => this.updateCurrentTime(), 1000);
                
                this.updateFare();
                this.showQRPlaceholder();
                
                this.showNotification('Sistem Perfect Sync siap!', false);
            }

            // UPDATE SYNC UI
            updateSyncUI() {
                const pendingCount = this.pendingFirebaseData ? 1 : 0;
                this.elements.pendingDataCount.textContent = pendingCount;
                this.elements.firebaseUpdateCount.textContent = this.firebaseUpdateCount;
                
                // Update sync status color
                if (this.syncStatus === 'perfect') {
                    this.elements.syncStatus.textContent = 'Perfect';
                    this.elements.syncStatus.className = 'text-green-400 font-bold';
                    this.elements.dataSyncStatus.textContent = 'SYNCED';
                    this.elements.dataSyncStatus.className = 'text-green-600 font-bold text-[10px]';
                    this.elements.dataSync.innerHTML = 'Sync: <span class="text-green-400">Perfect</span>';
                } else if (this.syncStatus === 'pending') {
                    this.elements.syncStatus.textContent = 'Pending';
                    this.elements.syncStatus.className = 'text-yellow-400 font-bold';
                    this.elements.dataSyncStatus.textContent = 'PENDING';
                    this.elements.dataSyncStatus.className = 'text-yellow-600 font-bold text-[10px]';
                    this.elements.dataSync.innerHTML = 'Sync: <span class="text-yellow-400">Pending</span>';
                } else {
                    this.elements.syncStatus.textContent = 'Error';
                    this.elements.syncStatus.className = 'text-red-400 font-bold';
                    this.elements.dataSyncStatus.textContent = 'ERROR';
                    this.elements.dataSyncStatus.className = 'text-red-600 font-bold text-[10px]';
                    this.elements.dataSync.innerHTML = 'Sync: <span class="text-red-400">Error</span>';
                }
            }

            initMap() {
                const defaultLocation = [-6.2088, 106.8456];
                this.map = L.map('map').setView(defaultLocation, 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(this.map);
                
                this.marker = L.marker(defaultLocation).addTo(this.map)
                    .bindPopup('Lokasi saat ini')
                    .openPopup();
                
                this.path = L.polyline([], {color: 'blue'}).addTo(this.map);
            }

            updateMap(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const newLatLng = [lat, lng];
                
                this.marker.setLatLng(newLatLng);
                
                if (this.isTracking) {
                    this.routeCoordinates.push(newLatLng);
                    this.path.setLatLngs(this.routeCoordinates);
                    
                    if (this.routeCoordinates.length === 1) {
                        this.map.setView(newLatLng, 15);
                    } else {
                        this.map.fitBounds(this.path.getBounds());
                    }
                } else {
                    this.map.setView(newLatLng, 15);
                }
                
                this.elements.currentLocation.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                this.elements.mapGpsStatus.textContent = 'Aktif';
                this.elements.mapGpsStatus.className = 'text-sm font-medium text-green-600';
            }

            showQRPlaceholder() {
                const canvas = this.elements.qrCanvas;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#f3f4f6';
                for (let y = 0; y < canvas.height; y += 20) {
                    for (let x = 0; x < canvas.width; x += 20) {
                        if ((x + y) % 40 === 0) {
                            ctx.fillRect(x, y, 10, 10);
                        }
                    }
                }
                
                this.elements.qrPlaceholderText.classList.remove('hidden');
            }

            initFirebase() {
                try {
                    db.collection('test').doc('connection').get()
                        .then(() => {
                            this.firebaseConnected = true;
                            this.elements.firebaseStatus.textContent = 'Connected';
                            this.elements.firebaseStatus.className = 'text-green-400';
                            console.log('‚úÖ Firebase connected successfully');
                        })
                        .catch((error) => {
                            this.firebaseConnected = false;
                            this.elements.firebaseStatus.textContent = 'Disconnected';
                            this.elements.firebaseStatus.className = 'text-red-400';
                            console.error('‚ùå Firebase connection error:', error);
                        });
                } catch (error) {
                    console.error('‚ùå Firebase initialization error:', error);
                    this.firebaseConnected = false;
                }
            }

            generateTripId() {
                const timestamp = Date.now().toString(36);
                const random = Math.random().toString(36).substr(2, 5);
                return `VL-${timestamp}-${random}`.toUpperCase();
            }

            removeUndefinedValues(obj) {
                if (obj === null || obj === undefined) return {};
                const cleanObj = {};
                for (const [key, value] of Object.entries(obj)) {
                    if (value !== undefined && value !== null) {
                        if (typeof value === 'object' && !Array.isArray(value)) {
                            const cleaned = this.removeUndefinedValues(value);
                            if (Object.keys(cleaned).length > 0) cleanObj[key] = cleaned;
                        } else if (Array.isArray(value)) {
                            const cleanedArray = value.filter(item => item !== undefined && item !== null);
                            if (cleanedArray.length > 0) cleanObj[key] = cleanedArray;
                        } else {
                            cleanObj[key] = value;
                        }
                    }
                }
                return cleanObj;
            }

            convertRouteForFirebase(routeCoordinates) {
                if (!routeCoordinates || !Array.isArray(routeCoordinates) || routeCoordinates.length === 0) return [];
                return routeCoordinates.filter(coord => Array.isArray(coord) && coord.length === 2)
                    .map(coord => ({ lat: coord[0] || 0, lng: coord[1] || 0 }));
            }

            async createNewTrip() {
                if (!this.firebaseConnected) {
                    console.warn('‚ö†Ô∏è Firebase not connected, skipping create trip');
                    return false;
                }

                try {
                    const tripData = {
                        tripId: this.currentTripId,
                        status: "active",
                        startTime: new Date(),
                        baseFare: this.BASE_FARE,
                        distanceRate: this.DISTANCE_RATE,
                        waitingRate: this.WAITING_RATE,
                        totalDistance: 0,
                        totalDuration: 0,
                        waitingTime: 0,
                        totalFare: this.BASE_FARE,
                        distanceFare: 0,
                        waitingFare: 0,
                        currentSpeed: 0,
                        validPoints: 0,
                        locations: [],
                        routeCoordinates: this.convertRouteForFirebase(this.routeCoordinates),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    const cleanTripData = this.removeUndefinedValues(tripData);
                    const tripRef = db.collection('taxi_trips').doc(this.currentTripId);
                    await tripRef.set(cleanTripData);
                    console.log('‚úÖ New trip created in Firebase:', this.currentTripId);
                    return true;
                } catch (error) {
                    console.error('‚ùå Error creating trip in Firebase:', error);
                    this.showNotification('Error membuat trip baru di cloud', true);
                    return false;
                }
            }

            // Lanjutan dari optimizedFirebaseUpdate
            async optimizedFirebaseUpdate(updateData) {
                const now = Date.now();
                
                // SELALU update validPoints
                updateData.validPoints = this.validPoints;
                
                // Jika belum waktunya update, simpan ke pending
                if (now - this.lastFirebaseUpdate < this.FIREBASE_UPDATE_INTERVAL) {
                    this.pendingFirebaseData = this.pendingFirebaseData ? 
                        { ...this.pendingFirebaseData, ...updateData } : updateData;
                    this.syncStatus = 'pending';
                    this.updateSyncUI();
                    return false;
                }
                
                // Gabungkan dengan pending data jika ada
                const finalUpdateData = this.pendingFirebaseData ? 
                    { ...this.pendingFirebaseData, ...updateData } : updateData;
                
                this.pendingFirebaseData = null;
                
                try {
                    if (!this.firebaseConnected || !this.currentTripId) {
                        console.warn('‚ö†Ô∏è Firebase not ready for update');
                        return false;
                    }

                    // Tambahkan timestamp update
                    finalUpdateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    finalUpdateData.lastUpdate = new Date();
                    
                    const cleanData = this.removeUndefinedValues(finalUpdateData);
                    const tripRef = db.collection('taxi_trips').doc(this.currentTripId);
                    
                    await tripRef.update(cleanData);
                    
                    this.lastFirebaseUpdate = now;
                    this.firebaseUpdateCount++;
                    this.syncStatus = 'perfect';
                    this.updateSyncUI();
                    
                    console.log('‚úÖ Firebase updated successfully');
                    return true;
                } catch (error) {
                    console.error('‚ùå Firebase update error:', error);
                    this.syncStatus = 'error';
                    this.updateSyncUI();
                    return false;
                }
            }

            // Method untuk complete trip
            async completeTripInFirebase() {
                if (!this.firebaseConnected || !this.currentTripId) return false;

                try {
                    const endTime = new Date();
                    const duration = Math.floor((endTime - this.startTime) / 1000);
                    
                    const tripData = {
                        status: "completed",
                        endTime: endTime,
                        totalDistance: this.totalDistance,
                        totalDuration: duration,
                        waitingTime: this.waitingTime,
                        totalFare: this.finalFare,
                        distanceFare: this.calculateDistanceFare(),
                        waitingFare: this.calculateWaitingFare(),
                        finalFare: this.finalFare,
                        routeCoordinates: this.convertRouteForFirebase(this.routeCoordinates),
                        completedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    const cleanData = this.removeUndefinedValues(tripData);
                    const tripRef = db.collection('taxi_trips').doc(this.currentTripId);
                    await tripRef.update(cleanData);
                    
                    console.log('‚úÖ Trip completed in Firebase');
                    return true;
                } catch (error) {
                    console.error('‚ùå Error completing trip in Firebase:', error);
                    return false;
                }
            }

            // GPS Tracking dengan akurasi tinggi
            startGPSTracking() {
                if (this.watchId) return;

                const options = {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 1000
                };

                this.watchId = navigator.geolocation.watchPosition(
                    (position) => this.handleNewPosition(position),
                    (error) => this.handleGPSError(error),
                    options
                );

                this.elements.gpsStatus.textContent = 'Aktif';
                this.elements.gpsStatus.className = 'text-green-400';
            }

            handleNewPosition(position) {
                const accuracy = position.coords.accuracy;
                const now = Date.now();
                
                // Update GPS status
                this.elements.gpsStatus.textContent = `Aktif (¬±${Math.round(accuracy)}m)`;
                this.elements.mapGpsStatus.textContent = `Aktif (¬±${Math.round(accuracy)}m)`;
                
                // Cek akurasi GPS
                if (accuracy > this.MIN_ACCURACY) {
                    this.elements.distanceWarning.classList.remove('hidden');
                    this.elements.distanceStatus.textContent = 'Akurasi rendah';
                    this.elements.distanceIndicator.className = 'w-2 h-2 rounded-full bg-red-500';
                    return;
                }
                
                this.elements.distanceWarning.classList.add('hidden');
                this.elements.distanceStatus.textContent = 'Akurasi tinggi';
                this.elements.distanceIndicator.className = 'w-2 h-2 rounded-full bg-green-500';
                
                // Update map
                this.updateMap(position);
                
                // Process untuk taximeter jika sedang tracking
                if (this.isTracking) {
                    this.processPositionForTaximeter(position, now);
                }
                
                this.lastUpdateTime = now;
                this.elements.lastUpdate.textContent = `Last: ${new Date().toLocaleTimeString()}`;
            }

            processPositionForTaximeter(position, timestamp) {
                const newPosition = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    timestamp: timestamp,
                    accuracy: position.coords.accuracy,
                    speed: position.coords.speed || 0
                };
                
                // Update speed display
                const speedKmh = newPosition.speed ? (newPosition.speed * 3.6).toFixed(1) : '0.0';
                this.elements.speed.textContent = speedKmh;
                
                // Cek apakah sedang bergerak
                this.isMoving = newPosition.speed > 1.0; // 1 m/s = 3.6 km/h
                
                // Hitung jarak dari posisi terakhir
                if (this.lastPosition) {
                    const distance = this.calculateDistance(
                        this.lastPosition.latitude, this.lastPosition.longitude,
                        newPosition.latitude, newPosition.longitude
                    );
                    
                    // Hanya tambahkan jarak jika memenuhi kriteria
                    if (distance >= this.MIN_DISTANCE / 1000) { // Convert to km
                        this.totalDistance += distance;
                        this.validPoints++;
                        
                        // Update display
                        this.elements.distance.textContent = this.totalDistance.toFixed(2);
                        this.elements.validPoints.textContent = this.validPoints;
                        
                        // Trigger UI update
                        this.elements.distance.classList.add('pulse');
                        setTimeout(() => this.elements.distance.classList.remove('pulse'), 500);
                        
                        // Update Firebase
                        this.optimizedFirebaseUpdate({
                            totalDistance: this.totalDistance,
                            validPoints: this.validPoints,
                            currentSpeed: parseFloat(speedKmh),
                            currentLocation: {
                                lat: newPosition.latitude,
                                lng: newPosition.longitude
                            }
                        });
                    }
                }
                
                this.lastPosition = newPosition;
                this.positionHistory.push(newPosition);
                
                // Update fare calculation
                this.updateFare();
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Radius bumi dalam km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            // Timer dan waiting time
            startTimers() {
                // Main timer
                this.startTime = Date.now();
                this.timerInterval = setInterval(() => {
                    const elapsed = Date.now() - this.startTime;
                    this.elements.duration.textContent = this.formatTime(elapsed);
                    
                    // Update Firebase setiap 30 detik dengan duration
                    if (Math.floor(elapsed / 1000) % 30 === 0) {
                        this.optimizedFirebaseUpdate({
                            totalDuration: Math.floor(elapsed / 1000)
                        });
                    }
                }, 1000);
                
                // Waiting timer
                this.waitingTimerInterval = setInterval(() => {
                    if (!this.isMoving && this.isTracking) {
                        this.waitingTime++;
                        this.elements.waitingTime.textContent = this.formatWaitingTime(this.waitingTime);
                        
                        // Update waiting fare setiap menit
                        if (this.waitingTime % 60 === 0) {
                            this.updateFare();
                        }
                    }
                }, 1000);
            }

            // Perhitungan tarif
            updateFare() {
                const distanceFare = this.calculateDistanceFare();
                const waitingFare = this.calculateWaitingFare();
                const totalFare = this.BASE_FARE + distanceFare + waitingFare;
                
                this.finalFare = totalFare;
                
                // Update displays
                this.elements.totalFare.textContent = `Rp ${totalFare.toLocaleString('id-ID')}`;
                this.elements.baseFare.textContent = `Rp ${this.BASE_FARE.toLocaleString('id-ID')}`;
                this.elements.distanceFare.textContent = `Rp ${distanceFare.toLocaleString('id-ID')}`;
                this.elements.waitingFare.textContent = `Rp ${waitingFare.toLocaleString('id-ID')}`;
                this.elements.amountDisplay.textContent = `Rp ${totalFare.toLocaleString('id-ID')}`;
                this.elements.modalTotalFare.textContent = `Rp ${totalFare.toLocaleString('id-ID')}`;
                
                // Update Firebase dengan tarif
                this.optimizedFirebaseUpdate({
                    totalFare: totalFare,
                    distanceFare: distanceFare,
                    waitingFare: waitingFare
                });
            }

            calculateDistanceFare() {
                const distanceKm = this.totalDistance;
                return Math.floor(distanceKm * this.DISTANCE_RATE);
            }

            calculateWaitingFare() {
                const waitingMinutes = Math.floor(this.waitingTime / 60);
                return waitingMinutes * this.WAITING_RATE;
            }

            // Utility functions
            formatTime(milliseconds) {
                const totalSeconds = Math.floor(milliseconds / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            formatWaitingTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            updateCurrentTime() {
                const now = new Date();
                this.elements.currentTime.textContent = now.toLocaleTimeString('id-ID');
            }

            showNotification(message, isError = false) {
                const notification = this.elements.notification;
                const notificationText = this.elements.notificationText;
                
                notificationText.textContent = message;
                notification.className = `fixed top-2 left-1/2 transform -translate-x-1/2 -translate-y-20 px-4 py-2 rounded-full shadow-lg z-50 transition-all duration-300 flex items-center space-x-2 text-xs ${
                    isError ? 'bg-danger text-white' : 'bg-success text-white'
                }`;
                
                notification.innerHTML = `
                    <i class="fas ${isError ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
                    <span>${message}</span>
                `;
                
                // Show
                notification.style.transform = 'translateX(-50%) translateY(0)';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    notification.style.transform = 'translateX(-50%) translateY(-20px)';
                }, 3000);
            }

            // Event bindings
            bindEvents() {
                // Start trip
                this.elements.startBtn.addEventListener('click', () => {
                    this.startTrip();
                });
                
                // Reset/Complete trip
                this.elements.resetBtn.addEventListener('click', () => {
                    this.completeTrip();
                });
                
                // Tab navigation
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tabName = e.target.getAttribute('data-tab');
                        this.switchTab(tabName);
                    });
                });
                
                // Payment methods
                this.elements.cashPayment.addEventListener('click', () => {
                    this.processCashPayment();
                });
                
                this.elements.qrisPayment.addEventListener('click', () => {
                    this.processQRISPayment();
                });
                
                this.elements.closeModal.addEventListener('click', () => {
                    this.hidePaymentModal();
                });
                
                // History actions
                this.elements.refreshHistory.addEventListener('click', () => {
                    this.loadTripHistory();
                });
                
                this.elements.clearHistory.addEventListener('click', () => {
                    this.clearTripHistory();
                });
            }

            // Main trip control methods
            startTrip() {
                this.isTracking = true;
                this.currentTripId = this.generateTripId();
                
                // Reset counters
                this.totalDistance = 0;
                this.validPoints = 0;
                this.waitingTime = 0;
                this.positionHistory = [];
                this.routeCoordinates = [];
                
                // Update UI
                this.elements.startBtn.disabled = true;
                this.elements.resetBtn.disabled = false;
                this.elements.startBtn.innerHTML = '<i class="fas fa-pause mr-1"></i>JALAN';
                this.elements.tripStatus.textContent = 'Berjalan';
                this.elements.tripStatus.className = 'text-green-600 font-bold';
                this.elements.currentTripId.textContent = this.currentTripId;
                this.elements.tripId.textContent = this.currentTripId;
                
                // Start timers and tracking
                this.startTimers();
                this.startGPSTracking();
                
                // Create trip in Firebase
                this.createNewTrip();
                
                this.showNotification('Perjalanan dimulai! Data tersinkronisasi ke cloud.');
            }

            async completeTrip() {
                this.isTracking = false;
                
                // Stop timers
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                if (this.waitingTimerInterval) {
                    clearInterval(this.waitingTimerInterval);
                    this.waitingTimerInterval = null;
                }
                
                // Complete trip in Firebase
                await this.completeTripInFirebase();
                
                // Update UI
                this.elements.startBtn.disabled = false;
                this.elements.resetBtn.disabled = true;
                this.elements.startBtn.innerHTML = '<i class="fas fa-play mr-1"></i>MULAI';
                this.elements.tripStatus.textContent = 'Selesai';
                this.elements.tripStatus.className = 'text-blue-600 font-bold';
                
                // Show payment section and modal
                this.elements.paymentSection.classList.remove('hidden');
                this.showPaymentModal();
                
                // Save to history
                this.saveTripToHistory();
                
                this.showNotification('Perjalanan selesai! Total tarif: Rp ' + this.finalFare.toLocaleString('id-ID'));
            }

            // Payment methods
            showPaymentModal() {
                this.elements.paymentModal.classList.remove('hidden');
            }

            hidePaymentModal() {
                this.elements.paymentModal.classList.add('hidden');
            }

            processCashPayment() {
                this.showNotification('Pembayaran cash berhasil! Terima kasih.');
                this.hidePaymentModal();
                this.resetSystem();
            }

            processQRISPayment() {
                // Generate QR code untuk pembayaran
                this.generateQRCode(this.finalFare);
                this.hidePaymentModal();
                this.showNotification('QR Code berhasil dibuat. Silakan scan untuk pembayaran.');
            }

            generateQRCode(amount) {
                const canvas = this.elements.qrCanvas;
                const ctx = canvas.getContext('2d');
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Simple QR code simulation (in real app, use a QR library)
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#000000';
                // Draw simple QR pattern (simplified)
                for (let i = 0; i < 7; i++) {
                    for (let j = 0; j < 7; j++) {
                        if ((i === 0 || i === 6 || j === 0 || j === 6) || 
                            (i === 2 && j === 2) || (i === 4 && j === 4)) {
                            ctx.fillRect(10 + i * 16, 10 + j * 16, 12, 12);
                        }
                    }
                }
                
                // Hide placeholder
                this.elements.qrPlaceholderText.classList.add('hidden');
            }

            // History management
            saveTripToHistory() {
                const trip = {
                    id: this.currentTripId,
                    date: new Date().toISOString(),
                    distance: this.totalDistance,
                    duration: Math.floor((Date.now() - this.startTime) / 1000),
                    totalFare: this.finalFare,
                    waitingTime: this.waitingTime
                };
                
                const history = this.getTripHistory();
                history.unshift(trip);
                
                // Simpan max 50 riwayat
                if (history.length > 50) {
                    history.pop();
                }
                
                localStorage.setItem('taxi_trip_history', JSON.stringify(history));
                this.loadTripHistory();
            }

            getTripHistory() {
                const history = localStorage.getItem('taxi_trip_history');
                return history ? JSON.parse(history) : [];
            }

            loadTripHistory() {
                const history = this.getTripHistory();
                const historyList = this.elements.historyList;
                
                if (history.length === 0) {
                    historyList.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-history text-3xl mb-2 opacity-50"></i>
                            <p>Belum ada riwayat perjalanan</p>
                        </div>
                    `;
                    return;
                }
                
                // Filter dan validasi data riwayat
                const validHistory = history.filter(trip => {
                    return trip && 
                           typeof trip.id === 'string' &&
                           typeof trip.distance === 'number' &&
                           typeof trip.duration === 'number' &&
                           typeof trip.totalFare === 'number' &&
                           typeof trip.waitingTime === 'number';
                });
                
                // Jika ada data yang tidak valid, perbarui localStorage
                if (validHistory.length !== history.length) {
                    localStorage.setItem('taxi_trip_history', JSON.stringify(validHistory));
                }
                
                historyList.innerHTML = validHistory.map(trip => {
                    // Pastikan semua nilai valid sebelum render
                    const distance = typeof trip.distance === 'number' ? trip.distance : 0;
                    const totalFare = typeof trip.totalFare === 'number' ? trip.totalFare : 0;
                    const waitingTime = typeof trip.waitingTime === 'number' ? trip.waitingTime : 0;
                    const duration = typeof trip.duration === 'number' ? trip.duration : 0;
                    const tripId = trip.id || 'Unknown';
                    const date = trip.date ? new Date(trip.date).toLocaleDateString('id-ID') : '-';
                    
                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-bold text-primary">${tripId}</div>
                                <div class="text-xs text-gray-500">${date}</div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div>
                                    <div class="text-gray-600">Jarak</div>
                                    <div class="font-bold">${distance.toFixed(2)} km</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">Durasi</div>
                                    <div class="font-bold">${this.formatTime(duration * 1000)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">Tunggu</div>
                                    <div class="font-bold">${this.formatWaitingTime(waitingTime)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">Total</div>
                                    <div class="font-bold text-success">Rp ${totalFare.toLocaleString('id-ID')}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            clearTripHistory() {
                if (confirm('Hapus semua riwayat perjalanan?')) {
                    localStorage.removeItem('taxi_trip_history');
                    this.loadTripHistory();
                    this.showNotification('Riwayat perjalanan telah dihapus');
                }
            }

            // Tab management
            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.toggle('active', button.getAttribute('data-tab') === tabName);
                });
                
                // Update tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === `${tabName}-tab`);
                });
                
                // Refresh map size when switching to maps tab
                if (tabName === 'maps' && this.map) {
                    setTimeout(() => {
                        this.map.invalidateSize();
                    }, 100);
                }
            }

            // Battery status
            initBattery() {
                if ('getBattery' in navigator) {
                    navigator.getBattery().then(battery => {
                        this.updateBatteryStatus(battery);
                        
                        battery.addEventListener('levelchange', () => {
                            this.updateBatteryStatus(battery);
                        });
                        
                        battery.addEventListener('chargingchange', () => {
                            this.updateBatteryStatus(battery);
                        });
                    });
                }
            }

            updateBatteryStatus(battery) {
                const level = Math.round(battery.level * 100);
                const charging = battery.charging;
                
                this.elements.batteryLevel.textContent = charging ? 
                    `${level}% (Charging)` : `${level}%`;
            }

            // Reset system setelah pembayaran
            resetSystem() {
                this.isTracking = false;
                this.startTime = null;
                this.totalDistance = 0;
                this.lastPosition = null;
                this.validPoints = 0;
                this.waitingTime = 0;
                this.isMoving = false;
                this.currentTripId = null;
                this.finalFare = 0;
                this.routeCoordinates = [];
                
                // Reset UI
                this.elements.distance.textContent = '0.00';
                this.elements.duration.textContent = '00:00:00';
                this.elements.speed.textContent = '0.0';
                this.elements.validPoints.textContent = '0';
                this.elements.waitingTime.textContent = '00:00';
                this.elements.totalFare.textContent = 'Rp 5.000';
                this.elements.baseFare.textContent = 'Rp 5.000';
                this.elements.distanceFare.textContent = 'Rp 0';
                this.elements.waitingFare.textContent = 'Rp 0';
                this.elements.amountDisplay.textContent = 'Rp 0';
                this.elements.tripStatus.textContent = 'Siap';
                this.elements.tripStatus.className = 'text-green-600 font-bold';
                this.elements.currentTripId.textContent = '-';
                this.elements.tripId.textContent = '-';
                
                // Reset payment section
                this.elements.paymentSection.classList.add('hidden');
                this.showQRPlaceholder();
                
                // Clear map route
                if (this.path) {
                    this.path.setLatLngs([]);
                }
                
                // Reset sync status
                this.firebaseUpdateCount = 0;
                this.pendingFirebaseData = null;
                this.syncStatus = 'perfect';
                this.updateSyncUI();
            }

            handleGPSError(error) {
                console.error('GPS Error:', error);
                let message = 'Error GPS: ';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message += 'Akses lokasi ditolak';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message += 'Informasi lokasi tidak tersedia';
                        break;
                    case error.TIMEOUT:
                        message += 'Permintaan lokasi timeout';
                        break;
                    default:
                        message += 'Error tidak diketahui';
                        break;
                }
                
                this.elements.gpsStatus.textContent = 'Error';
                this.elements.gpsStatus.className = 'text-red-400';
                this.elements.mapGpsStatus.textContent = 'Error';
                this.elements.mapGpsStatus.className = 'text-sm font-medium text-red-600';
                
                this.showNotification(message, true);
            }
        }

        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.taximeter = new Taximeter();
        });

        // Service Worker for PWA (optional) - Hanya dijalankan jika dalam konteks HTTPS/localhost
        if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
