<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLCrave Express - Invoice Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="flex justify-between items-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-white rounded-full shadow-lg">
                    <img src="https://vlcrave.github.io/project/img/icon.png" alt="VLCrave Express" class="w-8 h-8">
                </div>
                <button onclick="app.refreshAllData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">VLCrave Express</h1>
            <p class="text-gray-600">Invoice Generator & Delivery Service</p>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 gap-4 max-w-md mx-auto mb-6">
            <div class="bg-white rounded-xl p-4 shadow border">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-truck text-orange-500"></i>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-800" id="deliveryToday">0</div>
                        <div class="text-xs text-gray-500">Hari Ini</div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow border">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-blue-500"></i>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-800" id="deliveryTotal">0</div>
                        <div class="text-xs text-gray-500">Total</div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow border">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-money-bill-wave text-green-500"></i>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-gray-800" id="incomeToday">Rp 0</div>
                        <div class="text-xs text-gray-500">Hari Ini</div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow border">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-wallet text-purple-500"></i>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-gray-800" id="incomeTotal">Rp 0</div>
                        <div class="text-xs text-gray-500">Total</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Info -->
        <div class="max-w-md mx-auto mb-4 text-center">
            <div class="text-xs text-gray-500 bg-yellow-50 p-2 rounded-lg">
                <span id="debugInfo">Memuat data...</span>
            </div>
        </div>

        <!-- Main Actions -->
        <div class="max-w-md mx-auto mb-8">
            <div class="bg-white rounded-xl shadow border p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Invoice Generator</h2>
                <button onclick="app.showInvoiceGeneratorModal()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg flex items-center justify-center gap-2 mb-3 transition-colors">
                    <i class="fas fa-receipt"></i>
                    Buat Invoice Baru
                </button>
                <button onclick="app.cleanupOldData()" class="w-full border border-red-300 text-red-600 py-3 rounded-lg flex items-center justify-center gap-2 hover:bg-red-50 transition-colors">
                    <i class="fas fa-trash"></i>
                    Reset Data
                </button>
            </div>
        </div>

        <!-- History Section -->
        <div class="max-w-md mx-auto">
            <div class="bg-white rounded-xl shadow border p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Riwayat Invoice</h2>
                    <div class="text-sm text-gray-500" id="invoiceCount">0 invoices</div>
                </div>

                <!-- Filter Buttons -->
                <div class="flex gap-2 mb-4">
                    <button onclick="app.filterInvoices('all')" class="filter-btn active">Semua</button>
                    <button onclick="app.filterInvoices('today')" class="filter-btn">Hari Ini</button>
                    <button onclick="app.filterInvoices('week')" class="filter-btn">Minggu Ini</button>
                </div>

                <!-- Invoice List -->
                <div id="invoiceList" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-receipt text-3xl mb-3"></i>
                        <p>Belum ada invoice</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div id="pagination" class="pagination hidden"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA1kevuJ9mRJ8le8uPXin11uUqJ6sOLopY",
            authDomain: "vlcrave-whatsapp-order.firebaseapp.com",
            projectId: "vlcrave-whatsapp-order",
            storageBucket: "vlcrave-whatsapp-order.firebasestorage.app",
            messagingSenderId: "796602954067",
            appId: "1:796602954067:web:e10a110ae904decdc471a6",
            measurementId: "G-XLWNDN39ZD"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const app = {
            currentProducts: [],
            currentShippingCost: 0,
            currentInvoiceData: null,
            invoices: [],
            filteredInvoices: [],
            currentPage: 1,
            invoicesPerPage: 8,
            currentFilter: 'all',
            unsubscribeFunctions: [],
            isInitialized: false,

            init() {
                if (this.isInitialized) {
                    console.log('‚ö†Ô∏è App sudah diinisialisasi sebelumnya');
                    return;
                }
                
                console.log('üöÄ Inisialisasi aplikasi...');
                this.isInitialized = true;
                this.user = { uid: "guest-user" };
                this.loadInvoicesFromFirestore();
                this.loadStats();
            },

            async refreshAllData() {
                console.log('üîÑ Refresh semua data...');
                this.unsubscribeAllListeners();
                await this.loadInvoicesFromFirestore();
                this.loadStats();
                this.showNotification('Data diperbarui', 'success');
            },

            unsubscribeAllListeners() {
                console.log('üóëÔ∏è Unsubscribe semua listener...');
                this.unsubscribeFunctions.forEach(unsub => {
                    if (unsub && typeof unsub === 'function') {
                        unsub();
                    }
                });
                this.unsubscribeFunctions = [];
            },

            loadStats() {
                console.log('üìä Memuat stats...');
                
                // Unsubscribe listener stats sebelumnya
                const existingStatsIndex = this.unsubscribeFunctions.findIndex(fn => 
                    fn && fn.name === 'statsListener'
                );
                if (existingStatsIndex > -1) {
                    this.unsubscribeFunctions[existingStatsIndex]();
                    this.unsubscribeFunctions.splice(existingStatsIndex, 1);
                }

                const statsListener = db.collection("invoices").onSnapshot((snapshot) => {
                    const today = new Date();
                    const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const todayEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
                    
                    let deliveryToday = 0;
                    let deliveryTotal = 0;
                    let incomeToday = 0;
                    let incomeTotal = 0;

                    const processedIds = new Set(); // Hindari duplikat

                    snapshot.forEach((doc) => {
                        if (processedIds.has(doc.id)) {
                            console.warn('‚ö†Ô∏è Duplikat dokumen:', doc.id);
                            return;
                        }
                        processedIds.add(doc.id);

                        const data = doc.data();
                        const invoiceDate = data.createdAt ? data.createdAt.toDate() : new Date();
                        
                        deliveryTotal++;
                        
                        // Cek apakah invoice hari ini
                        if (invoiceDate >= todayStart && invoiceDate < todayEnd) {
                            deliveryToday++;
                        }
                        
                        const shippingCost = data.shippingCost || 0;
                        incomeTotal += shippingCost;
                        
                        if (invoiceDate >= todayStart && invoiceDate < todayEnd) {
                            incomeToday += shippingCost;
                        }
                    });

                    console.log(`üìä Stats - Total: ${deliveryTotal}, Hari Ini: ${deliveryToday}`);
                    
                    // Update UI
                    document.getElementById('deliveryToday').textContent = deliveryToday;
                    document.getElementById('deliveryTotal').textContent = deliveryTotal;
                    document.getElementById('incomeToday').textContent = this.formatCurrency(incomeToday);
                    document.getElementById('incomeTotal').textContent = this.formatCurrency(incomeTotal);
                    
                    // Debug info
                    document.getElementById('debugInfo').textContent = 
                        `Ditemukan: ${deliveryTotal} invoice total, ${deliveryToday} hari ini`;

                }, (error) => {
                    console.error('‚ùå Error load stats:', error);
                });

                // Simpan listener untuk nanti di-unsubscribe
                statsListener.name = 'statsListener';
                this.unsubscribeFunctions.push(statsListener);
            },

            showInvoiceGeneratorModal() {
                this.closeInvoiceModal();
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="bg-blue-500 p-4 text-white">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-receipt text-xl"></i>
                                    <div>
                                        <h2 class="font-bold">Buat Invoice</h2>
                                        <p class="text-blue-100 text-sm">Input manual produk</p>
                                    </div>
                                </div>
                                <button onclick="app.closeInvoiceModal()" class="text-white hover:text-blue-200">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-4">
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-800 mb-2">Produk:</label>
                                <div id="productsContainer"></div>
                                <button onclick="app.addProduct()" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg flex items-center justify-center gap-2 mt-2">
                                    <i class="fas fa-plus"></i>Tambah Produk
                                </button>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-800 mb-2">Ongkos Kirim:</label>
                                <input type="number" id="shippingCost" placeholder="0" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       oninput="app.calculateTotalManual()">
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-800 mb-2">Metode Bayar:</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="relative">
                                        <input type="radio" name="paymentMethod" value="tunai" class="hidden peer" checked>
                                        <div class="p-3 border-2 border-gray-300 rounded-lg text-center cursor-pointer peer-checked:border-blue-500 peer-checked:bg-blue-50">
                                            <i class="fas fa-money-bill-wave text-gray-600 mb-1"></i>
                                            <div class="font-medium text-sm">Tunai</div>
                                        </div>
                                    </label>
                                    <label class="relative">
                                        <input type="radio" name="paymentMethod" value="transfer" class="hidden peer">
                                        <div class="p-3 border-2 border-gray-300 rounded-lg text-center cursor-pointer peer-checked:border-blue-500 peer-checked:bg-blue-50">
                                            <i class="fas fa-mobile-alt text-gray-600 mb-1"></i>
                                            <div class="font-medium text-sm">Transfer</div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                <h3 class="font-semibold text-blue-800 mb-3">Ringkasan</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-blue-700">Subtotal:</span>
                                        <span id="subtotalAmount" class="font-semibold">Rp 0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-blue-700">Ongkir:</span>
                                        <span id="shippingAmount" class="font-semibold">Rp 0</span>
                                    </div>
                                    <div class="border-t border-blue-300 pt-2">
                                        <div class="flex justify-between font-bold">
                                            <span>Total:</span>
                                            <span id="totalAmount" class="text-blue-600">Rp 0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-2 p-4 border-t">
                            <button onclick="app.closeInvoiceModal()" class="flex-1 border border-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-50">
                                Batal
                            </button>
                            <button onclick="app.generateManualInvoice()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">
                                Buat Invoice
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                this.addProduct();
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) this.closeInvoiceModal();
                });
            },

            addProduct() {
                const container = document.getElementById('productsContainer');
                const id = Date.now();
                container.insertAdjacentHTML('beforeend', `
                    <div class="product-item flex gap-2 mb-2" id="product-${id}">
                        <div class="flex-1">
                            <input type="text" placeholder="Nama produk" 
                                   class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                                   oninput="app.calculateTotalManual()">
                        </div>
                        <div class="w-16">
                            <input type="number" value="1" min="1" 
                                   class="w-full border border-gray-300 rounded px-2 py-2 text-sm"
                                   oninput="app.calculateTotalManual()">
                        </div>
                        <div class="w-24">
                            <input type="number" placeholder="Harga" 
                                   class="w-full border border-gray-300 rounded px-2 py-2 text-sm"
                                   oninput="app.calculateTotalManual()">
                        </div>
                        <button onclick="app.removeProduct(${id})" class="w-10 bg-red-500 text-white rounded flex items-center justify-center">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `);
            },

            removeProduct(id) {
                const element = document.getElementById(`product-${id}`);
                if (element) element.remove();
                this.calculateTotalManual();
            },

            calculateTotalManual() {
                let subtotal = 0;
                document.querySelectorAll('.product-item').forEach(element => {
                    const qty = parseInt(element.querySelector('input[type="number"]:nth-child(2)').value) || 0;
                    const price = parseInt(element.querySelector('input[type="number"]:nth-child(3)').value) || 0;
                    subtotal += qty * price;
                });
                
                const shipping = parseInt(document.getElementById('shippingCost').value) || 0;
                const total = subtotal + shipping;
                
                document.getElementById('subtotalAmount').textContent = this.formatCurrency(subtotal);
                document.getElementById('shippingAmount').textContent = this.formatCurrency(shipping);
                document.getElementById('totalAmount').textContent = this.formatCurrency(total);
                
                this.currentProducts = Array.from(document.querySelectorAll('.product-item')).map(el => ({
                    name: el.querySelector('input[type="text"]').value || 'Produk',
                    quantity: parseInt(el.querySelector('input[type="number"]:nth-child(2)').value) || 1,
                    price: parseInt(el.querySelector('input[type="number"]:nth-child(3)').value) || 0,
                    total: (parseInt(el.querySelector('input[type="number"]:nth-child(2)').value) || 1) * 
                           (parseInt(el.querySelector('input[type="number"]:nth-child(3)').value) || 0)
                }));
                
                this.currentShippingCost = shipping;
            },

            async generateManualInvoice() {
                const validProducts = this.currentProducts.filter(p => p.name && p.name !== 'Produk' && p.price > 0);
                if (validProducts.length === 0) {
                    alert('Tambah minimal 1 produk dengan harga valid!');
                    return;
                }

                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                const invoiceNumber = await this.generateInvoiceNumber();
                const subtotal = validProducts.reduce((sum, p) => sum + p.total, 0);
                const shippingCost = this.currentShippingCost;
                const total = subtotal + shippingCost;

                const invoiceData = {
                    products: validProducts,
                    subtotal: subtotal,
                    shippingCost: shippingCost,
                    total: total,
                    paymentMethod: paymentMethod,
                    invoiceNumber: invoiceNumber,
                    date: new Date().toLocaleDateString('id-ID'),
                    time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
                };

                await this.saveToFirestore(invoiceData);
                this.showSimpleInvoice(invoiceData);
            },

            async generateInvoiceNumber() {
                let lastNumber = localStorage.getItem('lastInvoiceNumber') || 0;
                lastNumber = parseInt(lastNumber) + 1;
                localStorage.setItem('lastInvoiceNumber', lastNumber);
                return `VLC-${lastNumber.toString().padStart(4, '0')}`;
            },

            async saveToFirestore(invoiceData) {
                try {
                    await db.collection("invoices").add({
                        ...invoiceData,
                        userId: "guest-user",
                        createdAt: new Date(),
                        status: 'completed'
                    });
                    this.showNotification(`Invoice ${invoiceData.invoiceNumber} dibuat`, 'success');
                } catch (error) {
                    console.error("Error saving invoice:", error);
                    this.showNotification('Invoice dibuat tapi gagal disimpan', 'info');
                }
            },

            closeInvoiceModal() {
                document.querySelectorAll('.fixed.inset-0').forEach(modal => modal.remove());
            },

            showSimpleInvoice(invoiceData) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="bg-orange-500 p-4 text-white text-center">
                            <h1 class="font-bold text-lg">VLCrave Express</h1>
                            <p class="text-orange-100 text-sm">Delivery Service</p>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-4">
                            <div class="bg-gray-50 rounded-lg p-3 mb-4">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="text-xs text-gray-500">No Invoice</div>
                                        <div class="font-mono font-bold">${invoiceData.invoiceNumber}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-500">Tanggal</div>
                                        <div class="font-semibold">${invoiceData.date}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-2 px-1">
                                    <h3 class="font-semibold text-sm">Detail Pesanan</h3>
                                    <div class="flex gap-6 text-xs text-gray-500">
                                        <span class="w-8 text-center">Qty</span>
                                        <span class="w-16 text-right">Harga</span>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    ${invoiceData.products.map(product => `
                                        <div class="flex justify-between items-center bg-gray-50 rounded p-2">
                                            <div class="flex-1">
                                                <div class="font-medium text-sm">${product.name}</div>
                                            </div>
                                            <div class="flex gap-6 items-center">
                                                <span class="w-8 text-center font-semibold text-sm">${product.quantity}</span>
                                                <span class="w-16 text-right font-semibold text-sm">${this.formatCurrency(product.price)}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="bg-orange-50 rounded-lg p-4 mb-4 border border-orange-200">
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-orange-800">Subtotal</span>
                                        <span class="font-semibold">${this.formatCurrency(invoiceData.subtotal)}</span>
                                    </div>
                                    ${invoiceData.shippingCost > 0 ? `
                                    <div class="flex justify-between">
                                        <span class="text-orange-800">Ongkos Kirim</span>
                                        <span class="font-semibold">${this.formatCurrency(invoiceData.shippingCost)}</span>
                                    </div>
                                    ` : ''}
                                    <div class="border-t border-orange-300 pt-2">
                                        <div class="flex justify-between font-bold">
                                            <span class="text-orange-900">Total</span>
                                            <span class="text-orange-900 text-lg">${this.formatCurrency(invoiceData.total)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                ${invoiceData.paymentMethod === 'tunai' ? 
                                    `<div class="flex items-center gap-3 p-3 bg-orange-50 rounded-lg border border-orange-200">
                                        <i class="fas fa-money-bill-wave text-orange-500"></i>
                                        <div>
                                            <div class="font-semibold text-orange-800">Tunai</div>
                                            <div class="text-xs text-orange-600">Siapkan uang pas</div>
                                        </div>
                                    </div>` :
                                    `<div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg border border-green-200">
                                        <i class="fas fa-mobile-alt text-green-500"></i>
                                        <div>
                                            <div class="font-semibold text-green-800">Transfer</div>
                                            <div class="text-xs text-green-600">Bayar via transfer</div>
                                        </div>
                                    </div>`
                                }
                            </div>
                        </div>

                        <div class="flex gap-2 p-4 border-t">
                            <button onclick="app.closeInvoiceModal()" class="flex-1 border border-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-50">
                                Tutup
                            </button>
                            <button onclick="app.shareInvoiceIOS()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">
                                Share
                            </button>
                            <button onclick="app.downloadAsPNG()" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-2 rounded-lg">
                                Download
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                this.currentInvoiceData = invoiceData;
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) this.closeInvoiceModal();
                });
            },

            loadInvoicesFromFirestore() {
                console.log('üìã Memuat invoices...');
                
                // Unsubscribe listener invoices sebelumnya
                const existingInvoicesIndex = this.unsubscribeFunctions.findIndex(fn => 
                    fn && fn.name === 'invoicesListener'
                );
                if (existingInvoicesIndex > -1) {
                    this.unsubscribeFunctions[existingInvoicesIndex]();
                    this.unsubscribeFunctions.splice(existingInvoicesIndex, 1);
                }

                const invoicesListener = db.collection("invoices")
                    .orderBy("createdAt", "desc")
                    .limit(100)
                    .onSnapshot((snapshot) => {
                        console.log(`üìã Snapshot invoices: ${snapshot.size} dokumen`);
                        
                        this.invoices = [];
                        const processedIds = new Set();

                        snapshot.forEach((doc) => {
                            if (processedIds.has(doc.id)) {
                                console.warn('‚ö†Ô∏è Duplikat invoice:', doc.id);
                                return;
                            }
                            processedIds.add(doc.id);

                            const data = doc.data();
                            data.id = doc.id;
                            this.invoices.push(data);
                        });

                        this.filteredInvoices = [...this.invoices];
                        this.renderInvoiceList();
                        
                        console.log(`üìã Final invoices: ${this.invoices.length} invoice`);
                    }, (error) => {
                        console.error('‚ùå Error load invoices:', error);
                    });

                invoicesListener.name = 'invoicesListener';
                this.unsubscribeFunctions.push(invoicesListener);
            },

            renderInvoiceList() {
                const list = document.getElementById('invoiceList');
                const count = document.getElementById('invoiceCount');
                const pagination = document.getElementById('pagination');
                
                count.textContent = `${this.filteredInvoices.length} invoice`;
                
                if (this.filteredInvoices.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-receipt text-3xl mb-3"></i>
                            <p>Belum ada invoice</p>
                        </div>
                    `;
                    pagination.classList.add('hidden');
                    return;
                }

                const totalPages = Math.ceil(this.filteredInvoices.length / this.invoicesPerPage);
                const start = (this.currentPage - 1) * this.invoicesPerPage;
                const end = start + this.invoicesPerPage;
                const currentInvoices = this.filteredInvoices.slice(start, end);

                list.innerHTML = currentInvoices.map(invoice => `
                    <div class="bg-white border rounded-lg p-3 hover:border-orange-300 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-gray-800">${invoice.invoiceNumber}</div>
                                <div class="text-sm text-gray-600">${invoice.date}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-orange-600">${this.formatCurrency(invoice.total)}</div>
                                <div class="text-xs text-gray-500 capitalize">${invoice.paymentMethod}</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-3">
                            <div class="text-xs text-gray-500">
                                ${invoice.products.length} item
                            </div>
                            <div class="flex gap-1">
                                <button onclick="app.viewInvoice('${invoice.invoiceNumber}')" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded">
                                    Lihat
                                </button>
                                <button onclick="app.deleteInvoice('${invoice.id}')" class="text-xs bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded">
                                    Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                if (totalPages > 1) {
                    pagination.classList.remove('hidden');
                    let html = '';
                    for (let i = 1; i <= totalPages; i++) {
                        html += `<button onclick="app.changePage(${i})" class="w-8 h-8 border rounded ${i === this.currentPage ? 'bg-blue-500 text-white' : 'bg-white'}">${i}</button>`;
                    }
                    pagination.innerHTML = html;
                } else {
                    pagination.classList.add('hidden');
                }
            },

            filterInvoices(type) {
                this.currentFilter = type;
                this.currentPage = 1;
                
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                if (type === 'all') {
                    this.filteredInvoices = [...this.invoices];
                } else {
                    const now = new Date();
                    let startDate;
                    
                    if (type === 'today') {
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    } else if (type === 'week') {
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                    }
                    
                    this.filteredInvoices = this.invoices.filter(invoice => {
                        const invoiceDate = invoice.createdAt ? invoice.createdAt.toDate() : new Date();
                        return invoiceDate >= startDate;
                    });
                }
                
                this.renderInvoiceList();
            },

            changePage(page) {
                this.currentPage = page;
                this.renderInvoiceList();
            },

            viewInvoice(invoiceNumber) {
                const invoice = this.invoices.find(inv => inv.invoiceNumber === invoiceNumber);
                if (invoice) {
                    this.currentInvoiceData = invoice;
                    this.showSimpleInvoice(invoice);
                }
            },

            async deleteInvoice(id) {
                if (!confirm('Hapus invoice ini?')) return;
                
                try {
                    await db.collection("invoices").doc(id).delete();
                    this.showNotification('Invoice dihapus', 'success');
                } catch (error) {
                    this.showNotification('Gagal menghapus', 'error');
                }
            },

            async cleanupOldData() {
                if (!confirm('Hapus SEMUA data invoice?')) return;
                
                try {
                    const snapshot = await db.collection("invoices").get();
                    const batch = db.batch();
                    snapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    this.showNotification('Semua data dihapus', 'success');
                } catch (error) {
                    this.showNotification('Gagal menghapus data', 'error');
                }
            },

            async shareInvoiceIOS() {
                if (!this.currentInvoiceData) return;
                
                try {
                    const data = this.currentInvoiceData;
                    const shareText = data.paymentMethod === 'transfer' ?
                        `Pesanan selesai - Transfer ke BCA 6455106431 a/n VICKY SATRIA LINDY - ${this.formatCurrency(data.total)}` :
                        `Pesanan selesai - Bayar tunai ${this.formatCurrency(data.total)} saat terima barang`;
                    
                    if (navigator.share) {
                        await navigator.share({
                            title: `Invoice ${data.invoiceNumber}`,
                            text: shareText
                        });
                    } else {
                        await navigator.clipboard.writeText(shareText);
                        this.showNotification('Disalin ke clipboard', 'success');
                    }
                } catch (error) {
                    this.showNotification('Gagal share', 'error');
                }
            },

            async downloadAsPNG() {
                this.showNotification('Fitur download PNG dalam pengembangan', 'info');
            },

            showNotification(message, type) {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white ${
                    type === 'success' ? 'bg-green-500' : 
                    type === 'error' ? 'bg-red-500' : 'bg-blue-500'
                }`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            },

            formatCurrency(amount) {
                return 'Rp ' + new Intl.NumberFormat('id-ID').format(amount);
            }
        };

        // Add CSS
        const style = document.createElement('style');
        style.textContent = `
            .filter-btn {
                flex: 1;
                padding: 8px 12px;
                border: 1px solid #d1d5db;
                background: white;
                border-radius: 8px;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.2s;
            }
            .filter-btn.active {
                background: #3b82f6;
                color: white;
                border-color: #3b82f6;
            }
            .filter-btn:hover:not(.active) {
                background: #f3f4f6;
            }
            .pagination {
                display: flex;
                justify-content: center;
                gap: 4px;
                margin-top: 16px;
                padding-top: 16px;
                border-top: 1px solid #e5e7eb;
            }
        `;
        document.head.appendChild(style);

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
